<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创意数独游戏</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.25);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.8rem;
            color: #FFD700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .logo h1 {
            color: white;
            font-size: 2.4rem;
            font-weight: 800;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .game-info {
            display: flex;
            gap: 25px;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.22);
            border-radius: 18px;
            padding: 15px 28px;
            text-align: center;
            min-width: 140px;
            backdrop-filter: blur(6px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .info-card .label {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1rem;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .info-card .value {
            color: white;
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        main {
            display: flex;
            gap: 30px;
        }
        
        .game-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .difficulty-buttons {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-easy {
            background: linear-gradient(to right, #56ab2f, #a8e063);
            color: white;
        }
        
        .btn-medium {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
        }
        
        .btn-hard {
            background: linear-gradient(to right, #8e2de2, #4a00e0);
            color: white;
        }
        
        .btn-action {
            background: rgba(255, 255, 255, 0.28);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.35);
        }
        
        /* 棋盘容器 - 完美正方形比例 */
        .board-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 宽高比 */
            margin: 0 auto;
            max-width: 500px;
        }
        
        .sudoku-board {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 2px;
            background: rgba(0, 0, 0, 0.18);
            border-radius: 12px;
            padding: 8px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.25);
        }
        
        .cell {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            user-select: none;
        }
        
        .cell:hover {
            background: rgba(255, 255, 255, 0.98);
        }
        
        .cell.fixed {
            background: rgba(240, 240, 240, 0.85);
            color: #2c3e50;
            font-weight: 800;
        }
        
        .cell.user-input {
            color: #2c3e50;
        }
        
        .cell.highlight {
            background: rgba(173, 216, 230, 0.75);
        }
        
        .cell.selected {
            background: rgba(144, 238, 144, 0.75);
            transform: scale(1.02);
            box-shadow: 0 0 8px rgba(144, 238, 144, 0.5);
        }
        
        .cell.error {
            background: rgba(255, 99, 132, 0.75);
            color: white;
        }
        
        .border-right {
            border-right: 3px solid rgba(0, 0, 0, 0.35);
        }
        
        .border-bottom {
            border-bottom: 3px solid rgba(0, 0, 0, 0.35);
        }
        
        .input-panel {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 25px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .number-btn {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2rem;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.28);
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.35);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .number-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }
        
        .number-btn:active {
            transform: scale(0.95);
        }
        
        .number-btn.delete {
            background: rgba(255, 107, 107, 0.7);
            font-size: 1.8rem;
        }
        
        .side-panel {
            flex: 0 0 340px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .panel-section {
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
        }
        
        .panel-title {
            color: white;
            font-size: 1.7rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }
        
        .panel-title i {
            color: #FFD700;
            font-size: 1.8rem;
        }
        
        .instructions {
            color: rgba(255, 255, 255, 0.92);
            line-height: 1.7;
            font-size: 1.05rem;
        }
        
        .instructions ul {
            padding-left: 25px;
            margin: 18px 0;
        }
        
        .instructions li {
            margin-bottom: 12px;
        }
        
        .records-list {
            max-height: 340px;
            overflow-y: auto;
            padding-right: 15px;
        }
        
        .record-item {
            background: rgba(255, 255, 255, 0.12);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        .record-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.18);
        }
        
        .record-difficulty {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .difficulty-easy {
            background: rgba(86, 171, 47, 0.75);
        }
        
        .difficulty-medium {
            background: rgba(255, 126, 95, 0.75);
        }
        
        .difficulty-hard {
            background: rgba(142, 45, 226, 0.75);
        }
        
        .record-time {
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }
        
        /* 确认弹窗 */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .confirmation-modal.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .confirmation-modal.show .modal-content {
            transform: scale(1);
        }
        
        .modal-content h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .modal-content p {
            color: #34495e;
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-btn.confirm {
            background: linear-gradient(to right, #56ab2f, #a8e063);
            color: white;
        }
        
        .modal-btn.cancel {
            background: rgba(236, 240, 241, 0.9);
            color: #2c3e50;
            border: 1px solid #bdc3c7;
        }
        
        .modal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .win-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s ease;
        }
        
        .win-message.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .win-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            max-width: 550px;
            width: 90%;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6);
            transform: scale(0.8);
            transition: transform 0.6s ease;
            position: relative;
            overflow: hidden;
        }
        
        .win-content::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 8s linear infinite;
            z-index: -1;
        }
        
        .win-message.show .win-content {
            transform: scale(1);
        }
        
        .win-content h2 {
            color: #FFD700;
            font-size: 3rem;
            margin-bottom: 25px;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        }
        
        .win-content p {
            color: white;
            font-size: 1.8rem;
            margin-bottom: 35px;
            font-weight: 600;
        }
        
        .btn-close {
            background: linear-gradient(to right, #56ab2f, #a8e063);
            color: white;
            padding: 18px 45px;
            font-size: 1.3rem;
            font-weight: 700;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(86, 171, 47, 0.5);
        }
        
        .btn-close:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(86, 171, 47, 0.7);
        }
        
        .generation-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 12px;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 1024px) {
            main {
                flex-direction: column;
            }
            
            .side-panel {
                flex: 0 0 auto;
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .game-info {
                width: 100%;
                justify-content: center;
            }
            
            .controls {
                justify-content: center;
            }
            
            .difficulty-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .cell {
                font-size: 1.5rem;
            }
            
            .number-btn {
                font-size: 1.8rem;
            }
            
            .board-container {
                max-width: 90vw;
            }
        }
        
        @media (max-width: 480px) {
            .info-card {
                padding: 12px 15px;
                min-width: 100px;
            }
            
            .info-card .value {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 12px 15px;
                font-size: 0.95rem;
            }
            
            .cell {
                font-size: 1.2rem;
            }
            
            .number-btn {
                font-size: 1.6rem;
            }
            
            .panel-section {
                padding: 20px;
            }
            
            .panel-title {
                font-size: 1.4rem;
            }
            
            .modal-content {
                padding: 25px;
            }
            
            .modal-content h2 {
                font-size: 1.5rem;
            }
            
            .modal-content p {
                font-size: 1rem;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-btn {
                width: 100%;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-th-large"></i>
                <h1>创意数独</h1>
            </div>
            <div class="game-info">
                <div class="info-card">
                    <div class="label">时间</div>
                    <div class="value" id="timer">00:00</div>
                </div>
                <div class="info-card">
                    <div class="label">难度</div>
                    <div class="value" id="difficulty">中等</div>
                </div>
                <div class="info-card">
                    <div class="label">错误</div>
                    <div class="value" id="mistakes">0</div>
                </div>
            </div>
        </header>
        
        <main>
            <div class="game-area">
                <div class="controls">
                    <div class="difficulty-buttons">
                        <button class="btn btn-easy" id="easy-btn">
                            <i class="fas fa-seedling"></i> 简单
                        </button>
                        <button class="btn btn-medium" id="medium-btn">
                            <i class="fas fa-fire"></i> 中等
                        </button>
                        <button class="btn btn-hard" id="hard-btn">
                            <i class="fas fa-skull"></i> 困难
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-action" id="new-game-btn">
                            <i class="fas fa-redo"></i> 新游戏
                        </button>
                    </div>
                </div>
                
                <!-- 棋盘容器 - 确保正方形比例 -->
                <div class="board-container">
                    <div class="sudoku-board" id="sudoku-board">
                        <!-- 数独格子将通过JS生成 -->
                    </div>
                </div>
                
                <div class="generation-status" id="generation-status">
                    <i class="fas fa-sync fa-spin"></i>
                    <span>正在生成唯一解数独题目...</span>
                </div>
                
                <div class="input-panel" id="input-panel">
                    <!-- 数字输入面板将通过JS生成 -->
                </div>
            </div>
            
            <div class="side-panel">
                <div class="panel-section">
                    <h2 class="panel-title"><i class="fas fa-info-circle"></i> 游戏说明</h2>
                    <div class="instructions">
                        <p>数独的目标是用数字1-9填满9×9的网格，使得：</p>
                        <ul>
                            <li>每一行包含1-9的所有数字，且不重复</li>
                            <li>每一列包含1-9的所有数字，且不重复</li>
                            <li>每个3×3的子网格包含1-9的所有数字，且不重复</li>
                        </ul>
                        <p><strong>改进说明：</strong></p>
                        <p>本版本保证所有题目都有唯一解，解决了之前版本可能存在多解的问题。</p>
                        <p>生成唯一解题目需要额外计算时间，请耐心等待。</p>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h2 class="panel-title"><i class="fas fa-trophy"></i> 最佳成绩</h2>
                    <div class="records-list" id="records-list">
                        <!-- 成绩记录将通过JS生成 -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 确认弹窗 -->
    <div class="confirmation-modal" id="confirmation-modal">
        <div class="modal-content">
            <h2>确认操作</h2>
            <p id="confirmation-text">确定要开始新游戏吗？当前游戏进度将丢失。</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" id="confirm-btn">确定</button>
                <button class="modal-btn cancel" id="cancel-btn">取消</button>
            </div>
        </div>
    </div>
    
    <div class="win-message" id="win-message">
        <div class="win-content">
            <h2>恭喜！挑战成功</h2>
            <p>你成功完成了<span id="win-difficulty">中等</span>难度的数独</p>
            <p>用时: <span id="win-time">00:00</span></p>
            <p>错误: <span id="win-mistakes">0</span>次</p>
            <button class="btn-close" id="close-win-btn">继续挑战</button>
        </div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            board: Array(9).fill().map(() => Array(9).fill(0)),
            solution: Array(9).fill().map(() => Array(9).fill(0)),
            userBoard: Array(9).fill().map(() => Array(9).fill(0)),
            fixedCells: Array(9).fill().map(() => Array(9).fill(false)),
            selectedCell: { row: -1, col: -1 },
            difficulty: 'medium',
            startTime: null,
            timerInterval: null,
            mistakes: 0,
            gameCompleted: false,
            pendingAction: null
        };

        // 难度设置（已知数字数量）
        const difficultySettings = {
            easy: { min: 35, max: 40 },
            medium: { min: 30, max: 35 },
            hard: { min: 25, max: 30 }
        };

        // 初始化游戏
        function initGame() {
            createBoard();
            createInputPanel();
            loadRecords();
            startNewGame('medium');
            setupEventListeners();
        }

        // 创建数独棋盘
        function createBoard() {
            const board = document.getElementById('sudoku-board');
            board.innerHTML = '';
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // 添加粗边框
                    if (col % 3 === 2 && col < 8) cell.classList.add('border-right');
                    if (row % 3 === 2 && row < 8) cell.classList.add('border-bottom');
                    
                    board.appendChild(cell);
                }
            }
        }

        // 创建数字输入面板
        function createInputPanel() {
            const inputPanel = document.getElementById('input-panel');
            inputPanel.innerHTML = '';
            
            // 创建数字按钮1-9
            for (let i = 1; i <= 9; i++) {
                const btn = document.createElement('div');
                btn.className = 'number-btn';
                btn.textContent = i;
                btn.dataset.number = i;
                inputPanel.appendChild(btn);
            }
            
            // 创建删除按钮
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'number-btn delete';
            deleteBtn.innerHTML = '<i class="fas fa-backspace"></i>';
            deleteBtn.dataset.number = '0';
            inputPanel.appendChild(deleteBtn);
        }

        // 设置事件监听
        function setupEventListeners() {
            // 棋盘点击事件
            document.getElementById('sudoku-board').addEventListener('click', (e) => {
                if (gameState.gameCompleted) return;
                
                const cell = e.target.closest('.cell');
                if (!cell) return;
                
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                
                // 如果点击的是固定数字，不处理
                if (gameState.fixedCells[row][col]) return;
                
                // 移除之前选中的格子
                document.querySelectorAll('.cell.selected').forEach(c => {
                    c.classList.remove('selected');
                });
                
                // 选中新格子
                cell.classList.add('selected');
                gameState.selectedCell = { row, col };
                
                // 高亮相同行、列和区域
                highlightRelatedCells(row, col);
            });
            
            // 数字面板点击事件
            document.getElementById('input-panel').addEventListener('click', (e) => {
                if (gameState.gameCompleted) return;
                
                const btn = e.target.closest('.number-btn');
                if (!btn) return;
                
                const number = parseInt(btn.dataset.number);
                setCellValue(number);
            });
            
            // 难度按钮 - 添加确认
            document.getElementById('easy-btn').addEventListener('click', () => {
                showConfirmation('easy');
            });
            document.getElementById('medium-btn').addEventListener('click', () => {
                showConfirmation('medium');
            });
            document.getElementById('hard-btn').addEventListener('click', () => {
                showConfirmation('hard');
            });
            
            // 新游戏按钮 - 添加确认
            document.getElementById('new-game-btn').addEventListener('click', () => {
                showConfirmation(gameState.difficulty);
            });
            
            // 确认弹窗按钮
            document.getElementById('confirm-btn').addEventListener('click', () => {
                const action = gameState.pendingAction;
                document.getElementById('confirmation-modal').classList.remove('show');
                if (action) {
                    startNewGame(action);
                }
            });
            
            document.getElementById('cancel-btn').addEventListener('click', () => {
                document.getElementById('confirmation-modal').classList.remove('show');
                gameState.pendingAction = null;
            });
            
            // 关闭胜利消息按钮
            document.getElementById('close-win-btn').addEventListener('click', () => {
                document.getElementById('win-message').classList.remove('show');
            });
        }

        // 显示确认弹窗
        function showConfirmation(action) {
            // 如果游戏尚未开始，直接执行操作
            if (!gameState.startTime) {
                startNewGame(action);
                return;
            }
            
            // 如果游戏已完成，直接执行操作
            if (gameState.gameCompleted) {
                startNewGame(action);
                return;
            }
            
            // 设置待处理操作
            gameState.pendingAction = action;
            
            // 更新确认文本
            const text = action === gameState.difficulty ? 
                '确定要开始新游戏吗？当前游戏进度将丢失。' : 
                `确定要切换到${action === 'easy' ? '简单' : action === 'hard' ? '困难' : '中等'}难度吗？当前游戏进度将丢失。`;
            
            document.getElementById('confirmation-text').textContent = text;
            
            // 显示确认弹窗
            document.getElementById('confirmation-modal').classList.add('show');
        }

        // 设置格子值
        function setCellValue(value) {
            const { row, col } = gameState.selectedCell;
            if (row === -1 || gameState.fixedCells[row][col]) return;
            
            // 更新用户输入
            gameState.userBoard[row][col] = value;
            
            // 更新UI
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            cell.textContent = value === 0 ? '' : value;
            cell.classList.remove('error');
            
            // 检查输入是否正确
            if (value !== 0 && value !== gameState.solution[row][col]) {
                gameState.mistakes++;
                document.getElementById('mistakes').textContent = gameState.mistakes;
                cell.classList.add('error');
            }
            
            // 检查游戏是否完成
            checkGameCompletion();
        }

        // 高亮相关格子
        function highlightRelatedCells(row, col) {
            // 移除之前的高亮
            document.querySelectorAll('.cell.highlight').forEach(c => {
                c.classList.remove('highlight');
            });
            
            // 高亮相同行和列
            for (let i = 0; i < 9; i++) {
                document.querySelector(`.cell[data-row="${row}"][data-col="${i}"]`).classList.add('highlight');
                document.querySelector(`.cell[data-row="${i}"][data-col="${col}"]`).classList.add('highlight');
            }
            
            // 高亮3x3区域
            const startRow = Math.floor(row / 3) * 3;
            const startCol = Math.floor(col / 3) * 3;
            
            for (let r = startRow; r < startRow + 3; r++) {
                for (let c = startCol; c < startCol + 3; c++) {
                    document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`).classList.add('highlight');
                }
            }
        }

        // 开始新游戏
        function startNewGame(difficulty) {
            // 显示生成状态
            document.getElementById('generation-status').style.display = 'flex';
            
            // 重置游戏状态
            gameState.difficulty = difficulty;
            gameState.userBoard = Array(9).fill().map(() => Array(9).fill(0));
            gameState.fixedCells = Array(9).fill().map(() => Array(9).fill(false));
            gameState.selectedCell = { row: -1, col: -1 };
            gameState.mistakes = 0;
            gameState.gameCompleted = false;
            
            // 更新UI状态
            document.getElementById('difficulty').textContent = 
                difficulty === 'easy' ? '简单' : 
                difficulty === 'hard' ? '困难' : '中等';
            document.getElementById('mistakes').textContent = '0';
            
            // 清除选中和高亮
            document.querySelectorAll('.cell.selected, .cell.highlight').forEach(cell => {
                cell.classList.remove('selected', 'highlight');
            });
            
            // 生成新数独
            setTimeout(() => {
                generateSudoku();
                
                // 启动计时器
                startTimer();
                
                // 隐藏生成状态
                document.getElementById('generation-status').style.display = 'none';
            }, 100);
        }

        // 生成数独
        function generateSudoku() {
            // 生成完整解
            generateSolution();
            
            // 根据难度移除数字（确保唯一解）
            removeNumbersWithUniqueCheck();
            
            // 渲染棋盘
            renderBoard();
        }

        // 生成完整解
        function generateSolution() {
            // 重置棋盘
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    gameState.solution[i][j] = 0;
                }
            }
            
            // 使用回溯法填充棋盘
            solveSudoku(gameState.solution);
        }

        // 数独求解算法（回溯法）
        function solveSudoku(board) {
            const emptyCell = findEmptyCell(board);
            if (!emptyCell) {
                return true; // 没有空格，数独已解决
            }
            
            const [row, col] = emptyCell;
            const nums = shuffleArray([1, 2, 3, 4, 5, 6, 7, 8, 9]);
            
            for (const num of nums) {
                if (isValidPlacement(board, row, col, num)) {
                    board[row][col] = num;
                    
                    if (solveSudoku(board)) {
                        return true;
                    }
                    
                    board[row][col] = 0; // 回溯
                }
            }
            return false;
        }

        // 查找空格子
        function findEmptyCell(board) {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (board[row][col] === 0) {
                        return [row, col];
                    }
                }
            }
            return null; // 没有空格
        }

        // 检查数字放置是否有效
        function isValidPlacement(board, row, col, num) {
            // 检查行
            for (let c = 0; c < 9; c++) {
                if (board[row][c] === num) return false;
            }
            
            // 检查列
            for (let r = 0; r < 9; r++) {
                if (board[r][col] === num) return false;
            }
            
            // 检查3x3区域
            const startRow = Math.floor(row / 3) * 3;
            const startCol = Math.floor(col / 3) * 3;
            
            for (let r = startRow; r < startRow + 3; r++) {
                for (let c = startCol; c < startCol + 3; c++) {
                    if (board[r][c] === num) return false;
                }
            }
            
            return true;
        }

        // 打乱数组
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 计算解法数量（确保唯一解的关键函数）
        function countSolutions(board) {
            // 深拷贝棋盘
            const boardCopy = JSON.parse(JSON.stringify(board));
            let solutionCount = 0;
            
            backtrack(boardCopy);
            return solutionCount;
            
            function backtrack(board) {
                const emptyCell = findEmptyCell(board);
                if (!emptyCell) {
                    solutionCount++;
                    return;
                }
                
                // 如果已经有两个解，提前终止
                if (solutionCount >= 2) return;
                
                const [row, col] = emptyCell;
                for (let num = 1; num <= 9; num++) {
                    if (isValidPlacement(board, row, col, num)) {
                        board[row][col] = num;
                        backtrack(board);
                        
                        // 如果已经有两个解，提前终止
                        if (solutionCount >= 2) return;
                        
                        board[row][col] = 0; // 回溯
                    }
                }
            }
        }

        // 移除数字（确保唯一解）
        function removeNumbersWithUniqueCheck() {
            const { min, max } = difficultySettings[gameState.difficulty];
            const targetClues = Math.floor(Math.random() * (max - min + 1)) + min;
            
            // 初始化用户棋盘为完整解
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    gameState.userBoard[i][j] = gameState.solution[i][j];
                    gameState.fixedCells[i][j] = true;
                }
            }
            
            let currentClues = 81;
            let attempts = 0;
            const maxAttempts = 200; // 最大尝试次数
            
            // 逐步移除数字，确保唯一解
            while (currentClues > targetClues && attempts < maxAttempts) {
                // 获取所有非空格子
                const nonEmptyCells = [];
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (gameState.userBoard[row][col] !== 0) {
                            nonEmptyCells.push([row, col]);
                        }
                    }
                }
                
                if (nonEmptyCells.length === 0) break;
                
                // 随机选择一个非空格子
                const randomIndex = Math.floor(Math.random() * nonEmptyCells.length);
                const [row, col] = nonEmptyCells[randomIndex];
                
                // 备份当前值
                const backup = gameState.userBoard[row][col];
                
                // 尝试移除
                gameState.userBoard[row][col] = 0;
                
                // 检查是否仍然有唯一解
                const solutions = countSolutions(gameState.userBoard);
                
                if (solutions === 1) {
                    // 唯一解，保留移除
                    gameState.fixedCells[row][col] = false;
                    currentClues--;
                } else {
                    // 不是唯一解，恢复
                    gameState.userBoard[row][col] = backup;
                }
                
                attempts++;
            }
        }

        // 渲染棋盘
        function renderBoard() {
            document.querySelectorAll('.cell').forEach(cell => {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const value = gameState.userBoard[row][col];
                
                cell.textContent = value === 0 ? '' : value;
                cell.className = 'cell';
                
                // 添加固定格子的样式
                if (gameState.fixedCells[row][col]) {
                    cell.classList.add('fixed');
                } else {
                    cell.classList.add('user-input');
                }
                
                // 添加粗边框
                if (col % 3 === 2 && col < 8) cell.classList.add('border-right');
                if (row % 3 === 2 && row < 8) cell.classList.add('border-bottom');
            });
        }

        // 启动计时器
        function startTimer() {
            // 清除现有计时器
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            gameState.startTime = new Date();
            gameState.timerInterval = setInterval(updateTimer, 1000);
        }

        // 更新计时器显示
        function updateTimer() {
            const currentTime = new Date();
            const elapsed = Math.floor((currentTime - gameState.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            
            document.getElementById('timer').textContent = `${minutes}:${seconds}`;
        }

        // 检查游戏是否完成
        function checkGameCompletion() {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    // 用户输入为0或与解法不一致
                    if (gameState.userBoard[row][col] === 0 || 
                        gameState.userBoard[row][col] !== gameState.solution[row][col]) {
                        return false;
                    }
                }
            }
            
            // 游戏完成
            gameState.gameCompleted = true;
            clearInterval(gameState.timerInterval);
            saveRecord();
            showWinMessage();
            return true;
        }

        // 显示胜利消息
        function showWinMessage() {
            const elapsed = Math.floor((new Date() - gameState.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            
            document.getElementById('win-time').textContent = `${minutes}:${seconds}`;
            document.getElementById('win-mistakes').textContent = gameState.mistakes;
            
            const difficultyText = 
                gameState.difficulty === 'easy' ? '简单' : 
                gameState.difficulty === 'hard' ? '困难' : '中等';
            document.getElementById('win-difficulty').textContent = difficultyText;
            
            document.getElementById('win-message').classList.add('show');
        }

        // 保存成绩记录
        function saveRecord() {
            const elapsed = Math.floor((new Date() - gameState.startTime) / 1000);
            const record = {
                difficulty: gameState.difficulty,
                time: elapsed,
                mistakes: gameState.mistakes,
                date: new Date().toISOString()
            };
            
            // 从localStorage获取现有记录
            let records = JSON.parse(localStorage.getItem('sudokuRecords') || '[]');
            
            // 添加新记录
            records.push(record);
            
            // 按时间排序（时间越短越好）
            records.sort((a, b) => a.time - b.time);
            
            // 只保留前10条记录
            records = records.slice(0, 10);
            
            // 保存回localStorage
            localStorage.setItem('sudokuRecords', JSON.stringify(records));
            
            // 刷新记录显示
            loadRecords();
        }

        // 加载成绩记录
        function loadRecords() {
            const recordsList = document.getElementById('records-list');
            recordsList.innerHTML = '';
            
            const records = JSON.parse(localStorage.getItem('sudokuRecords')) || [];
            
            if (records.length === 0) {
                recordsList.innerHTML = '<div class="record-item" style="justify-content: center; color: rgba(255,255,255,0.7);">暂无记录，开始游戏吧！</div>';
                return;
            }
            
            records.forEach((record, index) => {
                const minutes = Math.floor(record.time / 60).toString().padStart(2, '0');
                const seconds = (record.time % 60).toString().padStart(2, '0');
                
                const difficultyText = 
                    record.difficulty === 'easy' ? '简单' : 
                    record.difficulty === 'hard' ? '困难' : '中等';
                
                const difficultyClass = 
                    record.difficulty === 'easy' ? 'difficulty-easy' : 
                    record.difficulty === 'hard' ? 'difficulty-hard' : 'difficulty-medium';
                
                const date = new Date(record.date);
                const dateStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                
                const recordEl = document.createElement('div');
                recordEl.className = 'record-item';
                recordEl.innerHTML = `
                    <div>
                        <span class="record-difficulty ${difficultyClass}">${difficultyText}</span>
                        <div style="margin-top: 8px; font-size: 0.95rem;">${dateStr}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="record-time">${minutes}:${seconds}</div>
                        <div style="font-size: 0.95rem;">错误: ${record.mistakes}</div>
                    </div>
                `;
                
                recordsList.appendChild(recordEl);
            });
        }

        // 初始化游戏
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
