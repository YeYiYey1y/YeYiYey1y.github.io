<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.85, viewport-fit=cover, user-scalable=no">
    <title>ÊàòÂú∫ÊåáÊå•ÂÆò - ‰ºòÂåñÁâà</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden !important;
            margin: 0;
            background: linear-gradient(135deg, #0c1445, #2c1a5e, #0c1445);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            touch-action: manipulation;
        }

        #game-container {
            position: relative;
            width: min(420px, 100%);
            height: 780px;
            background: linear-gradient(to bottom, #0c2461, #1e3799, #0c2461);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
            border: 4px solid #4a69bd;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            #game-container {
                width: 100%;
                max-width: none;
                margin: 0 auto;
            }
        }

        #level-selector {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-radius: 24px;
        }

        #level-title {
            font-size: 42px;
            color: #f1c40f;
            margin-bottom: 30px;
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.9);
            background: linear-gradient(to right, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #level-title::before { content: "‚öîÔ∏è "; }
        #level-title::after { content: " üè∞"; }

        .level-button {
            background: linear-gradient(to right, #6c5ce7, #a29bfe);
            border: none;
            padding: 15px 30px;
            border-radius: 40px;
            color: #fff;
            font-weight: bold;
            font-size: 20px;
            margin: 10px 0;
            cursor: pointer;
            width: 250px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .level-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .level-button.completed::before {
            content: "‚úì";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #2ecc71;
        }
        .level-button:not(.completed)::before {
            content: "üîí";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #7f8c8d;
        }
        .level-button.hard::after {
            content: "‚ö†Ô∏è";
            margin-left: 8px;
        }

        .level-info {
            font-size: 16px;
            margin-top: 5px;
            color: #a29bfe;
        }

        #game-header {
            height: 70px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            border-bottom: 3px solid #4a69bd;
            z-index: 100;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: bold;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.7);
        }

        .resource i {
            color: #f6b93b;
            text-shadow: 0 0 10px rgba(246, 185, 59, 0.8);
        }
        .resource.gold i::before { content: "üí∞"; }
        .resource.energy i::before { content: "‚ö°"; }
        .resource.diamond i::before { content: "üíé"; }

        #game-board {
            width: 100%;
            height: 580px;
            position: relative;
            overflow: hidden;
            background: rgba(30, 55, 153, 0.3);
            background-image:
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><rect width="120" height="120" fill="none" opacity="0.3"/><path d="M60,0 L60,120 M0,60 L120,60" stroke="%234a69bd" stroke-width="0.8" stroke-dasharray="8,8"/></svg>');
            background-size: 60px 60px;
        }

        #player-base, #enemy-base {
            position: absolute;
            width: 30%;
            max-width: 140px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        #player-base {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        #enemy-base {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .base-building {
            width: 120px;
            height: 80px;
            background: linear-gradient(to bottom, #8e44ad, #6c5ce7);
            border: 4px solid #f1c40f;
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            color: #f1c40f;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
            animation: pulse 2s infinite;
        }
        .base-building.player::before { content: "üè∞ "; }
        .base-building.enemy::before { content: "üèØ "; }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
            50% { box-shadow: 0 0 30px rgba(241, 196, 15, 0.9); }
            100% { box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        }

        .health-bar {
            width: 100%;
            height: 10px;
            background: #444;
            border-radius: 6px;
            margin-top: 8px;
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to right, #e74c3c, #2ecc71);
            transition: width 0.3s ease;
        }
        .health-fill.critical {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            animation: flash 1s infinite;
        }
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #battle-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, transparent, #f1c40f, transparent);
            z-index: 5;
            box-shadow: 0 0 15px #f1c40f;
        }

        #cards-container {
            height: 150px;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 0 10px;
            border-top: 3px solid #4a69bd;
            overflow-x: auto;
        }

        .card {
            flex-shrink: 0;
            width: 80px;
            height: 100px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 3px solid #4a69bd;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.6);
            border-color: #f1c40f;
        }

        .card.selected {
            border-color: #f1c40f;
            box-shadow: 0 0 30px #f1c40f;
            animation: cardPulse 1.5s infinite;
        }

        /* Á≤æÁæéÁöÑÁ≠âÁ∫ßËæπÊ°ÜÊïàÊûú */
        .card.level-1 {
            border: 3px solid #3498db;
            box-shadow: 0 0 10px #3498db;
        }
        .card.level-2 {
            border: 3px solid #2ecc71;
            box-shadow: 0 0 15px #2ecc71, inset 0 0 10px rgba(46, 204, 113, 0.5);
        }
        .card.level-3 {
            border: 3px solid #f1c40f;
            box-shadow: 0 0 20px #f1c40f, inset 0 0 10px rgba(241, 196, 15, 0.5);
        }
        .card.level-4 {
            border: 3px solid #e74c3c;
            box-shadow: 0 0 25px #e74c3c, inset 0 0 10px rgba(231, 76, 60, 0.5);
        }
        .card.level-5 {
            border: 3px solid #9b59b6;
            box-shadow: 0 0 30px #9b59b6, inset 0 0 15px rgba(155, 89, 182, 0.5);
            animation: glow 2s infinite alternate;
        }
        .card.level-6 {
            border: 3px solid;
            border-image: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #80ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080, #ff0000) 1;
            animation: rainbowGlow 3s infinite alternate;
            box-shadow: 0 0 20px rgba(255,255,255,0.7), 0 0 30px rgba(255,0,255,0.5);
        }

        @keyframes rainbowGlow {
            0% { box-shadow: 0 0 10px rgba(255,0,0,0.7), 0 0 20px rgba(255,0,0,0.5); }
            14% { box-shadow: 0 0 10px rgba(255,128,0,0.7), 0 0 20px rgba(255,128,0,0.5); }
            28% { box-shadow: 0 0 10px rgba(255,255,0,0.7), 0 0 20px rgba(255,255,0,0.5); }
            42% { box-shadow: 0 0 10px rgba(0,255,0,0.7), 0 0 20px rgba(0,255,0,0.5); }
            57% { box-shadow: 0 0 10px rgba(0,255,255,0.7), 0 0 20px rgba(0,255,255,0.5); }
            71% { box-shadow: 0 0 10px rgba(0,128,255,0.7), 0 0 20px rgba(0,128,255,0.5); }
            85% { box-shadow: 0 0 10px rgba(0,0,255,0.7), 0 0 20px rgba(0,0,255,0.5); }
            100% { box-shadow: 0 0 10px rgba(128,0,255,0.7), 0 0 20px rgba(128,0,255,0.5); }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 15px #9b59b6, inset 0 0 10px rgba(155, 89, 182, 0.5); }
            100% { box-shadow: 0 0 30px #9b59b6, inset 0 0 20px rgba(155, 89, 182, 0.7); }
        }

        @keyframes cardPulse {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.05); }
            100% { transform: translateY(0) scale(1); }
        }

        .card-cost {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: #f1c40f;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #000;
            font-size: 14px;
            z-index: 2;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        .card-icon {
            font-size: 28px;
            margin-bottom: 8px;
            z-index: 2;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            margin-top: 15px;
        }

        .card-name {
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            z-index: 2;
            padding: 0 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            height: 30px;
            display: flex;
            align-items: center;
        }

        .card-level {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #9b59b6;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .character {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 20;
            transition: transform 0.3s ease;
        }

        .player-character {
            border: 3px solid #2ecc71;
            animation: spawnAnimation 0.7s ease-out;
            cursor: pointer;
        }

        @keyframes spawnAnimation {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            70% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); }
        }

        .enemy-character {
            border: 3px solid #e74c3c;
            animation: enemySpawn 0.7s ease-out;
        }

        @keyframes enemySpawn {
            0% { transform: translateY(-60px) scale(0.5) rotate(0deg); opacity: 0; }
            70% { transform: translateY(10px) scale(1.1) rotate(-10deg); opacity: 1; }
            100% { transform: translateY(0) scale(1) rotate(0deg); }
        }

        .character-health {
            position: absolute;
            bottom: -18px;
            width: 50px;
            height: 8px;
            background: #444;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .health-fill-character {
            height: 100%;
            background: #2ecc71;
            transition: width 0.3s ease;
        }

        .enemy-character .health-fill-character {
            background: #e74c3c;
        }

        .projectile {
            position: absolute;
            z-index: 15;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: projectileFloat 0.5s infinite alternate;
        }

        @keyframes projectileFloat {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }

        /* ÊàòÂ£´ÂâëÊîªÂáªÁâπÊïà */
        .warrior-attack {
            position: absolute;
            width: 60px;
            height: 60px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M10,50 L90,50 M50,10 L50,90" stroke="%233498db" stroke-width="8" stroke-linecap="round"/></svg>');
            background-size: contain;
            animation: swordSlash 0.4s forwards;
            pointer-events: none;
            z-index: 25;
        }

        @keyframes swordSlash {
            0% { transform: scale(0.1) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.5) rotate(45deg); opacity: 1; }
            100% { transform: scale(2) rotate(90deg); opacity: 0; }
        }

        /* Â∞ÑÊâãÁÆ≠ÊîªÂáªÁâπÊïà - ‰ºòÂåñ */
        .archer-projectile {
            width: 30px;
            height: 8px;
            background: linear-gradient(to right, #2ecc71, #27ae60);
            border-radius: 4px;
            box-shadow: 0 0 10px #2ecc71;
            transform-origin: center;
            position: relative;
        }
        
        .archer-projectile.power-shot {
            width: 40px;
            height: 12px;
            background: linear-gradient(to right, #ffd700, #ff8c00);
            box-shadow: 0 0 15px #ffd700;
            z-index: 18;
        }
        
        /* Â∞ÑÊâãÁÆ≠Áü¢Â∞æÁøº */
        .archer-projectile::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            top: -2px;
            left: 0;
            border-top: 4px solid #2ecc71;
            border-right: 4px solid transparent;
            border-bottom: 4px solid #2ecc71;
            border-left: 4px solid transparent;
            transform: rotate(45deg);
        }
        
        .archer-projectile.power-shot::after {
            border-top: 6px solid #ffd700;
            border-bottom: 6px solid #ffd700;
        }
        
        /* Â∞ÑÊâãÁÆ≠Áü¢ËΩ®Ëøπ */
        .archer-trail {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: rgba(46, 204, 113, 0.4);
            animation: trailFade 0.5s forwards;
            pointer-events: none;
            z-index: 14;
        }

        /* Ê≥ïÂ∏àÁÅ´ÁêÉÁâπÊïà - ‰ºòÂåñ */
        .mage-projectile {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: radial-gradient(circle, #ff8800, #ff0000);
            box-shadow: 0 0 20px #ff0000;
            animation: firePulse 0.5s infinite alternate;
        }
        
        /* ÁÅ´ÁêÉÊãñÂ∞æÊïàÊûú */
        .mage-projectile::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #ff8800, transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.7;
            animation: fadeTrail 0.5s forwards;
            z-index: -1;
        }

        @keyframes fadeTrail {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        @keyframes firePulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.2); }
        }

        /* Âà∫ÂÆ¢È£ûÈïñÁâπÊïà */
        .blade-projectile {
            width: 16px;
            height: 16px;
            background: #e74c3c;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            transform: rotate(45deg);
            box-shadow: 0 0 10px #e74c3c;
            animation: spin 0.5s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(45deg); }
            100% { transform: rotate(405deg); }
        }

        /* È™ëÂ£´Âú£ÂÖâÁâπÊïà */
        .paladin-attack {
            position: absolute;
            width: 60px;
            height: 60px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M10,50 L90,50 M50,10 L50,90" stroke="%23f1c40f" stroke-width="8" stroke-linecap="round"/></svg>');
            background-size: contain;
            animation: holyCross 0.5s forwards;
            pointer-events: none;
            z-index: 25;
        }

        @keyframes holyCross {
            0% { transform: scale(0.1); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .damage-effect {
            position: absolute;
            font-size: 18px;
            font-weight: bold;
            animation: floatUp 1.2s forwards;
            z-index: 30;
            pointer-events: none;
            text-shadow: 0 0 8px rgba(0,0,0,0.8);
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-40px); opacity: 0; }
        }

        .heal-effect {
            position: absolute;
            font-size: 16px;
            font-weight: bold;
            color: #2ecc71;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.8);
            animation: floatUp 1.8s forwards;
            z-index: 30;
            pointer-events: none;
        }

        #game-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            z-index: 200;
            border: 3px solid #f1c40f;
            box-shadow: 0 0 40px rgba(241, 196, 15, 0.9);
            display: none;
            animation: messageAppear 0.7s ease-out;
        }

        @keyframes messageAppear {
            0% { opacity: 0; transform: translate(-50%, -60%) scale(0.8); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        #message-title {
            font-size: 42px;
            color: #f1c40f;
            margin-bottom: 15px;
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.9);
        }

        #message-content {
            font-size: 22px;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .game-button {
            background: linear-gradient(to right, #f1c40f, #e67e22);
            border: none;
            padding: 12px 35px;
            border-radius: 40px;
            color: #fff;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            margin: 0 10px;
        }

        .game-button:hover {
            transform: scale(1.08);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        #level-up-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 30px;
            border-radius: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            border: 3px solid #f1c40f;
            z-index: 200;
            display: none;
            animation: slideUp 0.7s ease-out;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            width: 380px;
            justify-content: center;
        }

        @keyframes slideUp {
            0% { bottom: -100px; opacity: 0; }
            100% { bottom: 0; opacity: 1; }
        }

        .level-up-option {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            border: 2px solid #4a69bd;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            min-width: 160px;
        }

        .level-up-option:hover {
            background: linear-gradient(135deg, #2a5298, #3a6bc7);
            border-color: #f1c40f;
            transform: translateY(-3px);
        }

        .character.warrior {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8);
        }
        .character.archer {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.8);
        }
        .character.mage {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.8);
        }
        .character.blade {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.8);
        }
        .character.paladin {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.8);
        }

        .enemy.normal {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            box-shadow: 0 0 15px rgba(149, 165, 166, 0.8);
        }
        .enemy.elite {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.8);
        }
        .enemy.boss {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            box-shadow: 0 0 25px rgba(155, 89, 182, 1);
            animation: bossPulse 2.5s infinite;
            transform: translate(-10px, -10px);
        }
        .enemy.tank {
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            box-shadow: 0 0 15px rgba(52, 73, 94, 0.8);
        }
        .enemy.speedy {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8);
        }
        .enemy.flyer {
            background: linear-gradient(135deg, #1abc9c, #16a085);
            box-shadow: 0 0 15px rgba(26, 188, 156, 0.8);
            animation: flyAnimation 1.5s infinite alternate;
        }
        .enemy.magic-immune {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.8);
            animation: magicPulse 3s infinite alternate;
        }
        .enemy.physical-immune {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            box-shadow: 0 0 15px rgba(52, 73, 94, 0.8);
            animation: physicalPulse 3s infinite alternate;
        }

        @keyframes flyAnimation {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }

        @keyframes bossPulse {
            0% { transform: scale(1) translate(-10px, -10px); box-shadow: 0 0 15px rgba(155, 89, 182, 0.8); }
            50% { transform: scale(1.08) translate(-10px, -10px); box-shadow: 0 0 30px rgba(155, 89, 182, 1); }
            100% { transform: scale(1) translate(-10px, -10px); box-shadow: 0 0 15px rgba(155, 89, 182, 0.8); }
        }

        @keyframes magicPulse {
            0% { box-shadow: 0 0 10px rgba(155, 89, 182, 0.6); }
            50% { box-shadow: 0 0 20px rgba(155, 89, 182, 1); }
            100% { box-shadow: 0 0 10px rgba(155, 89, 182, 0.6); }
        }

        @keyframes physicalPulse {
            0% { box-shadow: 0 0 10px rgba(52, 73, 94, 0.6); }
            50% { box-shadow: 0 0 20px rgba(52, 73, 94, 1); }
            100% { box-shadow: 0 0 10px rgba(52, 73, 94, 0.6); }
        }

        #elixir-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.4);
        }

        #elixir-fill {
            height: 100%;
            background: linear-gradient(to right, #6c5ce7, #a29bfe);
            width: 100%;
            transition: width 0.3s ease;
        }

        #tutorial {
            position: absolute;
            top: 80px;
            left: 25px;
            right: 25px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            z-index: 200;
            border: 3px solid #f1c40f;
            animation: tutorialPulse 3.5s infinite;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        @keyframes tutorialPulse {
            0% { box-shadow: 0 0 10px rgba(241, 196, 15, 0.6); }
            50% { box-shadow: 0 0 25px rgba(241, 196, 15, 0.9); }
            100% { box-shadow: 0 0 10px rgba(241, 196, 15, 0.6); }
        }

        #tutorial h3 {
            color: #f1c40f;
            margin-bottom: 15px;
            font-size: 22px;
            text-align: center;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.8);
        }

        #tutorial p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 10px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        #tutorial-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            color: #f1c40f;
            font-size: 24px;
            cursor: pointer;
            text-shadow: 0 0 8px rgba(241, 196, 15, 0.8);
        }

        #particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            animation: floatParticle 12s infinite linear;
        }

        @keyframes floatParticle {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-120px) translateX(30px); opacity: 0; }
        }

        /* ÊîªÂáªÂä®Áîª */
        .attack-animation {
            animation: attackBlink 0.3s;
        }

        @keyframes attackBlink {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Âè¨ÂõûÊåâÈíÆ */
        #recall-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(231, 76, 60, 0.9);
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            z-index: 150;
            display: none;
            animation: pulse 1.5s infinite;
        }

        #recall-button:hover {
            background: rgba(231, 76, 60, 1);
        }

        #timer-display {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 20px;
            font-weight: bold;
            z-index: 100;
            border: 2px solid #f1c40f;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.5);
            text-shadow: 0 0 8px rgba(241, 196, 15, 0.8);
        }

        /* ÊöÇÂÅúÊåâÈíÆ */
        #pause-button {
            position: absolute;
            top: 75px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 2px solid #f1c40f;
        }

        #pause-button i {
            font-size: 20px;
            color: #f1c40f;
        }

        /* Âç°ÁâáËØ¶ÊÉÖÈù¢Êùø */
        #card-detail {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            width: 300px;
            padding: 25px;
            border-radius: 20px;
            z-index: 250;
            border: 3px solid #4a69bd;
            box-shadow: 0 0 30px rgba(74, 105, 189, 0.8);
            display: none;
        }

        /* Âç°ÁâáËØ¶ÊÉÖËæπÊ°ÜÁ≠âÁ∫ßÊïàÊûú */
        #card-detail.level-1 {
            border: 3px solid #3498db;
            box-shadow: 0 0 10px #3498db;
        }
        #card-detail.level-2 {
            border: 3px solid #2ecc71;
            box-shadow: 0 0 15px #2ecc71, inset 0 0 10px rgba(46, 204, 113, 0.5);
        }
        #card-detail.level-3 {
            border: 3px solid #f1c40f;
            box-shadow: 0 0 20px #f1c40f, inset 0 0 10px rgba(241, 196, 15, 0.5);
        }
        #card-detail.level-4 {
            border: 3px solid #e74c3c;
            box-shadow: 0 0 25px #e74c3c, inset 0 0 10px rgba(231, 76, 60, 0.5);
        }
        #card-detail.level-5 {
            border: 3px solid #9b59b6;
            box-shadow: 0 0 30px #9b59b6, inset 0 0 15px rgba(155, 89, 182, 0.5);
            animation: glow 2s infinite alternate;
        }
        #card-detail.level-6 {
            border: 3px solid;
            border-image: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #80ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080, #ff0000) 1;
            animation: rainbowGlow 3s infinite alternate;
            box-shadow: 0 0 20px rgba(255,255,255,0.7), 0 0 30px rgba(255,0,255,0.5);
        }

        .detail-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .detail-icon {
            font-size: 42px;
            margin-right: 15px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 3px solid #4a69bd;
        }

        .detail-info h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .detail-level {
            font-size: 18px;
            color: #f1c40f;
        }

        .detail-stats {
            margin-top: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-label {
            color: #a29bfe;
        }

        .stat-value {
            font-weight: bold;
        }

        /* Êïå‰∫∫‰ø°ÊÅØÈù¢Êùø */
        #enemy-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            width: 250px;
            padding: 20px;
            border-radius: 15px;
            z-index: 250;
            border: 3px solid #e74c3c;
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.7);
            display: none;
        }

        .enemy-type {
            text-align: center;
            font-size: 22px;
            margin-bottom: 15px;
            color: #e74c3c;
        }

        .enemy-icon {
            font-size: 36px;
            text-align: center;
            margin-bottom: 15px;
        }

        #next-level-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 200;
            border: 3px solid #f1c40f;
            box-shadow: 0 0 40px rgba(241, 196, 15, 0.9);
            display: none;
        }

        #next-level-title {
            font-size: 32px;
            color: #f1c40f;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.9);
        }

        #next-level-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        /* ÊéíË°åÊ¶úÊ†∑Âºè */
        #leaderboard {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            border-radius: 20px;
            z-index: 300;
            border: 3px solid #f1c40f;
            box-shadow: 0 0 40px rgba(241, 196, 15, 0.9);
            display: none;
        }

        #leaderboard-title {
            font-size: 32px;
            color: #f1c40f;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.9);
        }

        #leaderboard-list {
            list-style: none;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 16px;
        }

        .leaderboard-header {
            font-weight: bold;
            color: #f1c40f;
            background: rgba(241, 196, 15, 0.1);
        }

        .leaderboard-rank {
            width: 30px;
            text-align: center;
        }

        .leaderboard-time {
            width: 80px;
            text-align: right;
        }

        .leaderboard-kills {
            width: 60px;
            text-align: right;
        }

        .leaderboard-date {
            width: 100px;
            text-align: right;
        }

        #close-leaderboard {
            margin-top: 20px;
            width: 100%;
        }

        @media (max-height: 750px) {
            #game-container {
                transform: scale(0.85);
            }
        }

        .victory-text {
            color: #f1c40f;
            text-align: center;
            font-size: 18px;
            margin-top: 10px;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.8);
        }

        #game-message-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        #leaderboard-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(74, 105, 189, 0.8);
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            z-index: 150;
        }

        /* ÊäÄËÉΩÂÆπÂô® */
        #skills-container {
            position: absolute;
            bottom: 160px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 10px;
            z-index: 50;
        }

        .skill-button {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }

        .skill-button:hover {
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.5);
        }

        .skill-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Ê≥ïÂäõÊ≥®ÂÖ•ÊåâÈíÆÊñ∞Ê†∑Âºè - ÂúÜÂΩ¢ */
        #elixir-boost {
            position: absolute;
            left: 20px;
            top: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            font-size: 24px;
            animation: pulse 2s infinite;
            opacity: 0.8;
        }

        /* ËßíËâ≤Ê≠ª‰∫°ÁâπÊïà */
        .explosion {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            z-index: 40;
            pointer-events: none;
            animation: explode 0.6s forwards;
        }

        @keyframes explode {
            0% { transform: scale(0.8); opacity: 1; }
            70% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        .explosion-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: particle-explode 0.8s forwards;
            pointer-events: none;
        }

        @keyframes particle-explode {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)); opacity: 0; }
        }

        /* ‰º§ÂÆ≥Á±ªÂûãÊ†áÁ≠æ */
        .damage-type {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .physical-damage {
            background: rgba(52, 152, 219, 0.7);
        }
        .magic-damage {
            background: rgba(155, 89, 182, 0.7);
        }
        .mixed-damage {
            background: linear-gradient(to right, rgba(52, 152, 219, 0.7), rgba(155, 89, 182, 0.7));
        }

        /* Êñ∞Â¢ûÁâπÊïà */
        .hit-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: hitParticleMove 0.7s forwards;
            pointer-events: none;
        }

        @keyframes hitParticleMove {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)); opacity: 0; }
        }

        @keyframes trailFade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }

        /* ÊäÄËÉΩÁâπÊïà */
        .skill-indicator {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 35;
            animation: skillIndicator 0.8s forwards;
        }

        @keyframes skillIndicator {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(1); opacity: 0; }
        }

        /* ËßíËâ≤Ë°®ÊÉÖÁ≥ªÁªü */
        .character-emotion {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            z-index: 30;
            animation: emotionFloat 2s forwards;
            opacity: 0;
            text-shadow: 0 0 8px rgba(0,0,0,0.8);
            padding: 5px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid currentColor;
            box-shadow: 0 0 10px currentColor;
        }

        @keyframes emotionFloat {
            0% { transform: translateX(-50%) translateY(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateX(-50%) translateY(-40px); opacity: 0; }
        }

        .emotion-happy { color: #f1c40f; }
        .emotion-angry { color: #e74c3c; }
        .emotion-sad { color: #3498db; }
        .emotion-proud { color: #2ecc71; }
        .emotion-scared { color: #9b59b6; }
        .emotion-excited { color: #ff6b6b; }
        .emotion-confident { color: #48dbfb; }
        .emotion-amazed { color: #feca57; }
        .emotion-determined { color: #54a0ff; }
        .emotion-annoyed { color: #ff9f43; }
        .emotion-surprised { color: #48dbfb; }
        .emotion-tired { color: #feca57; }
        .emotion-victory { color: #1dd1a1; }
        .emotion-defeat { color: #ff9ff3; }
        .emotion-alert { color: #ff0000; }

        /* Êñ∞Â¢ûÊ≥¢Ê¨°ËÆ°Êï∞Âô®Ê†∑Âºè */
        #wave-counter {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            z-index: 100;
            border: 2px solid #f1c40f;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.5);
            text-shadow: 0 0 8px rgba(241, 196, 15, 0.8);
        }

        /* Êñ∞Â¢ûÊ≥¢Ê¨°ÂÄíËÆ°Êó∂Ê†∑Âºè */
        #wave-timer {
            position: absolute;
            top: 45px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 6px 15px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            z-index: 100;
            border: 2px solid #6c5ce7;
            box-shadow: 0 0 10px rgba(108, 92, 231, 0.5);
            text-shadow: 0 0 5px rgba(108, 92, 231, 0.8);
        }
        
        /* Êñ∞Â¢ûÊ≥¢Ê¨°ÊèêÁ§∫ */
        .wave-alert {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            z-index: 150;
            border: 3px solid #f1c40f;
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.8);
            animation: waveAlert 1.5s forwards;
            text-align: center;
        }
        
        @keyframes waveAlert {
            0% { opacity: 0; transform: translate(-50%, -40%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(0.9); }
        }

        /* Á¢éÁâáÊèêÁ§∫ */
        .fragment-alert {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            z-index: 150;
            border: 3px solid #f1c40f;
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.8);
            animation: waveAlert 1.5s forwards;
            text-align: center;
        }

        /* Á¢éÁâáÊî∂ÈõÜÂô® */
        .fragment-collector {
            position: absolute;
            top: 120px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 15px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 2px solid #f1c40f;
            display: none; /* ÈªòËÆ§ÈöêËóè */
        }

        .fragment-type {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .fragment-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ffd700, #ff8c00);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }
        
        /* Á¢éÁâáÊî∂ÈõÜÂô®ÊåâÈíÆ */
        #toggle-fragments {
            position: absolute;
            top: 120px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #f1c40f;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }
        
        /* Âú£È™ëÂ£´ÂÖâÁéØÁâπÊïà */
        .paladin-halo {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 35;
            animation: haloExpand 0.8s forwards;
            background: radial-gradient(circle, rgba(241, 196, 15, 0.5), transparent 70%);
        }
        
        @keyframes haloExpand {
            0% { transform: scale(0.1); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        /* Âú£È™ëÂ£´Ê≤ªÁñóÁâπÊïà */
        .paladin-heal {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(46, 204, 113, 0.8), transparent);
            animation: healGlow 1s forwards;
            pointer-events: none;
            z-index: 35;
        }
        
        @keyframes healGlow {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        /* ËÉúÂà©ÁâπÊïà */
        .victory-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 180;
            display: none;
        }
        .victory-light {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8), transparent 70%);
            animation: victoryExpand 2s forwards;
        }
        @keyframes victoryExpand {
            0% { width: 0; height: 0; opacity: 0; }
            50% { width: 600px; height: 600px; opacity: 0.8; }
            100% { width: 800px; height: 800px; opacity: 0; }
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 20px;
            animation: confettiFall 3s ease-in forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(800px) rotate(720deg); opacity: 0; }
        }
        
        /* ÊàòÂ£´Âò≤ËÆΩÂÖâÁéØÁâπÊïà */
        .taunt-halo {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 35;
            animation: haloExpand 1s forwards;
            background: radial-gradient(circle, rgba(52, 152, 219, 0.6), transparent 70%);
        }
        
        /* Âà∫ÂÆ¢ÊÆãÂΩ±ÁâπÊïà */
        .blade-shadow {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 30;
            background: rgba(231, 76, 60, 0.6);
            animation: shadowFade 0.5s forwards;
        }
        
        @keyframes shadowFade {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }

        /* Ê≥ïÂ∏àÁàÜÁÇ∏ÁâπÊïà */
        .mage-explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, #ff8800, #ff0000, transparent 70%);
            animation: explode 0.6s forwards;
            pointer-events: none;
            z-index: 35;
        }

        @keyframes explode {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="particles-container"></div>
        <div id="victory-effect" class="victory-effect">
            <div class="victory-light"></div>
        </div>
        
        <!-- ÂÖ≥Âç°ÈÄâÊã©ÁïåÈù¢ -->
        <div id="level-selector">
            <h2 id="level-title">ÊàòÂú∫ÊåáÊå•ÂÆò</h2>
            <div class="level-button completed" data-level="1">ÂÖ≥Âç° 1 - Êñ∞ÊâãËÆ≠ÁªÉ</div>
            <div class="level-info">Êïå‰∫∫Á±ªÂûã: ÊôÆÈÄöÊïå‰∫∫</div>
            <div class="level-button" data-level="2">ÂÖ≥Âç° 2 - Á≤æËã±ÊåëÊàò</div>
            <div class="level-info">Êïå‰∫∫Á±ªÂûã: ÊôÆÈÄö + Á≤æËã±</div>
            <div class="level-button" data-level="3">ÂÖ≥Âç° 3 - Âú∞Áã±Ê®°Âºè</div>
            <div class="level-info">Êïå‰∫∫Á±ªÂûã: Á≤æËã± + Boss + Âù¶ÂÖã</div>
            <div class="level-button" data-level="4">ÂÖ≥Âç° 4 - ÊúÄÁªàÂÜ≥Êàò</div>
            <div class="level-info">Êïå‰∫∫Á±ªÂûã: ÊâÄÊúâÊïå‰∫∫ÁªÑÂêà</div>
            <div class="level-button" data-level="5">ÂÖ≥Âç° 5 - ÊûÅÈôêÊåëÊàò</div>
            <div class="level-info">ÈôêÂà∂4‰∏™ÂèãÂÜõÂçï‰Ωç</div>
            <div class="level-button" data-level="endless">Êó†Â∞ΩÂÖ≥Âç°</div>
            <div class="level-info">ÊâÄÊúâÊïå‰∫∫Á±ªÂûãÔºåÊó†ÈôêÊ≥¢Ê¨°</div>
            <button id="leaderboard-button">ÊéíË°åÊ¶ú</button>
        </div>
        
        <div id="game-header">
            <div class="resource">
                <i class="fas fa-coins"></i>
                <span id="gold-count">250</span>
            </div>
            <div class="resource">
                <i class="fas fa-gem"></i>
                <span id="elixir-count">10/10</span>
            </div>
            <div class="resource" id="endless-stats">
                <i class="fas fa-clock"></i>
                <span id="endless-time">00:00</span>
                <i class="fas fa-skull" style="margin-left: 15px;"></i>
                <span id="kill-count">0</span>
            </div>
        </div>
        
        <div id="game-board">
            <div id="timer-display">03:00</div>
            <div id="wave-counter">Ê≥¢Ê¨°: 0</div>
            <div id="wave-timer">‰∏ã‰∏ÄÊ≥¢: 30Áßí</div>
            
            <div id="enemy-base">
                <div class="base-building">
                    <i class="fas fa-fort-awesome"></i>
                </div>
                <div class="health-bar">
                    <div class="health-fill" id="enemy-health" style="width: 100%"></div>
                </div>
            </div>
            
            <div id="player-base">
                <div class="base-building">
                    <i class="fas fa-home"></i>
                </div>
                <div class="health-bar">
                    <div class="health-fill" id="player-health" style="width: 100%"></div>
                </div>
            </div>
            
            <div id="battle-line"></div>
        </div>
        
        <div id="elixir-bar">
            <div id="elixir-fill"></div>
        </div>
        
        <!-- Á¢éÁâáÊî∂ÈõÜÂô®ÊåâÈíÆ -->
        <button id="toggle-fragments">Á¢éÁâáÊî∂ÈõÜÂô®</button>
        
        <!-- Á¢éÁâáÊî∂ÈõÜÂô® -->
        <div class="fragment-collector">
            <div class="fragment-type">
                <div class="fragment-icon">Êàò</div>
                <span id="warrior-fragments">0/5</span>
            </div>
            <div class="fragment-type">
                <div class="fragment-icon">Â∞Ñ</div>
                <span id="archer-fragments">0/5</span>
            </div>
            <div class="fragment-type">
                <div class="fragment-icon">Ê≥ï</div>
                <span id="mage-fragments">0/5</span>
            </div>
            <div class="fragment-type">
                <div class="fragment-icon">Âà∫</div>
                <span id="blade-fragments">0/5</span>
            </div>
            <div class="fragment-type">
                <div class="fragment-icon">È™ë</div>
                <span id="paladin-fragments">0/5</span>
            </div>
        </div>
        
        <!-- ÊäÄËÉΩÊåâÈíÆ -->
        <button id="elixir-boost" class="skill-button" title="Ê≥ïÂäõÊ≥®ÂÖ• (50ÈáëÂ∏Å)"><i class="fas fa-bolt"></i></button>
        
        <div id="cards-container">
            <div class="card level-1" data-type="warrior">
                <div class="card-cost">4</div>
                <div class="card-icon"><i class="fas fa-shield-alt"></i></div>
                <div class="card-name">Âú£ÁõæÊàòÂ£´</div>
                <div class="card-level">1</div>
            </div>
            <div class="card level-1" data-type="archer">
                <div class="card-cost">3</div>
                <div class="card-icon"><i class="fas fa-bullseye"></i></div>
                <div class="card-name">Á≤æÁÅµÂ∞ÑÊâã</div>
                <div class="card-level">1</div>
            </div>
            <div class="card level-1" data-type="mage">
                <div class="card-cost">4</div>
                <div class="card-icon"><i class="fas fa-hat-wizard"></i></div>
                <div class="card-name">Â••ÊúØÊ≥ïÂ∏à</div>
                <div class="card-level">1</div>
            </div>
            <div class="card level-1" data-type="blade">
                <div class="card-cost">3</div>
                <div class="card-icon"><i class="fas fa-user-ninja"></i></div>
                <div class="card-name">ÂΩ±ÂàÉÂà∫ÂÆ¢</div>
                <div class="card-level">1</div>
            </div>
            <div class="card level-1" data-type="paladin">
                <div class="card-cost">5</div>
                <div class="card-icon"><i class="fas fa-hands-praying"></i></div>
                <div class="card-name">Á•ûÂú£È™ëÂ£´</div>
                <div class="card-level">1</div>
            </div>
        </div>
        
        <div id="level-up-container">
            <div class="victory-text">ËÉúÂà©ÔºÅÈÄâÊã©Ë¶ÅÂçáÁ∫ßÁöÑÂçï‰Ωç</div>
            <div class="level-up-option" data-type="warrior">ÂçáÁ∫ßÂú£ÁõæÊàòÂ£´</div>
            <div class="level-up-option" data-type="archer">ÂçáÁ∫ßÁ≤æÁÅµÂ∞ÑÊâã</div>
            <div class="level-up-option" data-type="mage">ÂçáÁ∫ßÂ••ÊúØÊ≥ïÂ∏à</div>
            <div class="level-up-option" data-type="blade">ÂçáÁ∫ßÂΩ±ÂàÉÂà∫ÂÆ¢</div>
            <div class="level-up-option" data-type="paladin">ÂçáÁ∫ßÁ•ûÂú£È™ëÂ£´</div>
            <button id="back-to-levels-upgrade" class="game-button">ËøîÂõûÂÖ≥Âç°ÈÄâÊã©</button>
        </div>
        
        <div id="game-message">
            <div id="message-title">ËÉúÂà©ÔºÅ</div>
            <div id="message-content">‰Ω†ÊàêÂäüÂùöÊåÅ‰∫Ü3ÂàÜÈíüÔºÅËé∑Âæó100ÈáëÂ∏Å</div>
            <div id="game-message-buttons">
                <button id="restart-button" class="game-button">ÁªßÁª≠ÊàòÊñó</button>
                <button id="back-to-levels" class="game-button">ËøîÂõûÂÖ≥Âç°ÈÄâÊã©</button>
            </div>
        </div>
        
        <div id="tutorial">
            <button id="tutorial-close"><i class="fas fa-times"></i></button>
            <h3>Ê∏∏ÊàèÊåáÂçó</h3>
            <p>1. ÈÄâÊã©Âç°ÁâåÔºåÊîæÁΩÆÂú®ÊàëÊñπÂçäÂú∫</p>
            <p>2. ÁÇπÂáªËßíËâ≤ÂèØÂè¨ÂõûÔºàËøîËøò50%Ê≥ïÂäõÔºâ</p>
            <p>3. ÂùöÊåÅ3ÂàÜÈíüÂç≥ÂèØËé∑ÂæóËÉúÂà©</p>
            <p>4. ËÉúÂà©ÂêéËé∑ÂæóÈáëÂ∏ÅÂçáÁ∫ßËßíËâ≤</p>
            <p>5. ËßíËâ≤Ëá™Âä®ÊàòÊñóÔºåÊó†Ê≥ïÈáçÂè†ÊîæÁΩÆ</p>
            <p>6. ‰ΩøÁî®"Ê≥ïÂäõÊ≥®ÂÖ•"ÊäÄËÉΩËé∑ÂæóÈ¢ùÂ§ñÊ≥ïÂäõ</p>
            <p>7. ÊàòÂ£´/Â∞ÑÊâãÔºöÁâ©ÁêÜ‰º§ÂÆ≥ | Ê≥ïÂ∏à/È™ëÂ£´ÔºöÊ≥ïÊúØ‰º§ÂÆ≥ | Âà∫ÂÆ¢ÔºöÊ∑∑Âêà‰º§ÂÆ≥</p>
            <p>8. Áâ©ÁêÜÂÖçÁñ´ÊÄ™ÔºöÊ≥ïÊúØ‰º§ÂÆ≥ÂáèÂçä | Ê≥ïÊúØÂÖçÁñ´ÊÄ™ÔºöÁâ©ÁêÜ‰º§ÂÆ≥ÂáèÂçä | Âà∫ÂÆ¢ÔºöÊó†ËßÜÊäóÊÄß</p>
            <p>9. ÊØè‰∏™ËßíËâ≤ÈÉΩÊúâÁã¨ÁâπÁöÑËá™Âä®ÊäÄËÉΩÔºÅ</p>
            <p>10. Âú®Êó†Â∞ΩÊ®°Âºè‰∏≠ÔºåÊØèÂáªË¥•50‰∏™Êïå‰∫∫ÂèØËé∑ÂæóËßíËâ≤Á¢éÁâá</p>
            <p>11. Êî∂ÈõÜ5‰∏™Á¢éÁâáÂèØÂçáÁ∫ßËßíËâ≤Ëá≥6Á∫ß</p>
        </div>
        
        <div id="next-level-container">
            <div id="next-level-title">ÂçáÁ∫ßÂÆåÊàêÔºÅ</div>
            <p>ÂáÜÂ§áËøõÂÖ•‰∏ã‰∏ÄÂÖ≥ÂêóÔºü</p>
            <div id="next-level-buttons">
                <button id="next-level-button" class="game-button">ËøõÂÖ•‰∏ã‰∏ÄÂÖ≥</button>
                <button id="replay-level-button" class="game-button">ÈáçÊñ∞ÊåëÊàò</button>
                <button id="back-to-levels-next" class="game-button">ËøîÂõûÂÖ≥Âç°ÈÄâÊã©</button>
            </div>
        </div>
        
        <button id="recall-button">Âè¨ÂõûËßíËâ≤</button>
        
        <!-- ÊöÇÂÅúÊåâÈíÆ -->
        <div id="pause-button">
            <i class="fas fa-pause"></i>
        </div>
        
        <!-- Âç°ÁâáËØ¶ÊÉÖÈù¢Êùø -->
        <div id="card-detail">
            <div class="detail-header">
                <div class="detail-icon"><i class="fas fa-shield-alt"></i></div>
                <div class="detail-info">
                    <h3>Âú£ÁõæÊàòÂ£´</h3>
                    <div class="detail-level">Á≠âÁ∫ß <span id="detail-level">1</span></div>
                </div>
            </div>
            <div class="detail-stats">
                <div class="stat-row">
                    <span class="stat-label">ÁîüÂëΩÂÄº:</span>
                    <span class="stat-value" id="detail-health">350</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ÊîªÂáªÂäõ:</span>
                    <span class="stat-value" id="detail-damage">25</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ÊîªÂáªËåÉÂõ¥:</span>
                    <span class="stat-value" id="detail-range">90</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ÊîªÂáªÈÄüÂ∫¶:</span>
                    <span class="stat-value" id="detail-attackspeed">1.4Áßí</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Ê≥ïÂäõÊ∂àËÄó:</span>
                    <span class="stat-value" id="detail-cost">4</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">‰º§ÂÆ≥Á±ªÂûã:</span>
                    <span class="stat-value" id="detail-damage-type">Áâ©ÁêÜ</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ÊäÄËÉΩ:</span>
                    <span class="stat-value" id="detail-skill">Âò≤ËÆΩ+ÂèçÂºπ‰º§ÂÆ≥</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Á¢éÁâá:</span>
                    <span class="stat-value" id="detail-fragments">0/5</span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="close-detail" class="game-button">ÂÖ≥Èó≠</button>
            </div>
        </div>
        
        <div id="enemy-info">
            <div class="enemy-type" id="enemy-type-name">ÊôÆÈÄöÊïå‰∫∫</div>
            <div class="enemy-icon"><i class="fas fa-skull"></i></div>
            <div class="detail-stats">
                <div class="stat-row">
                    <span class="stat-label">ÁîüÂëΩÂÄº:</span>
                    <span class="stat-value" id="enemy-info-health">120</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ÊîªÂáªÂäõ:</span>
                    <span class="stat-value" id="enemy-info-damage">15</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ÊîªÂáªËåÉÂõ¥:</span>
                    <span class="stat-value" id="enemy-info-range">85</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">‰º§ÂÆ≥ÊäóÊÄß:</span>
                    <span class="stat-value" id="enemy-info-resistance">Êó†</span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="close-enemy-info" class="game-button">ÂÖ≥Èó≠</button>
            </div>
        </div>

        <!-- ÊéíË°åÊ¶ú -->
        <div id="leaderboard">
            <h2 id="leaderboard-title">Êó†Â∞ΩÊ®°ÂºèÊéíË°åÊ¶ú</h2>
            <ul id="leaderboard-list">
                <li class="leaderboard-item leaderboard-header">
                    <span class="leaderboard-rank">#</span>
                    <span class="leaderboard-time">Êó∂Èó¥</span>
                    <span class="leaderboard-kills">ÂáªÊùÄ</span>
                    <span class="leaderboard-date">Êó•Êúü</span>
                </li>
            </ul>
            <button id="close-leaderboard" class="game-button">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Ê∏∏ÊàèÁä∂ÊÄÅ
            // ‰ªélocalStorageÂä†ËΩΩ‰øùÂ≠òÁöÑÊï∞ÊçÆ
            const loadGameData = () => {
                const savedData = localStorage.getItem('battlefieldSaveData');
                return savedData ? JSON.parse(savedData) : null;
            };

            // ‰øùÂ≠òÊï∞ÊçÆÂà∞localStorage
            const saveGameData = () => {
                const saveData = {
                    gold: gameState.gold,
                    completedLevels: gameState.completedLevels,
                    currentLevel: gameState.currentLevel,
                    characterLevels: gameState.characterLevels,
                    fragments: gameState.fragments
                };
                localStorage.setItem('battlefieldSaveData', JSON.stringify(saveData));
            };

            const loadedData = loadGameData();
            const gameState = {
                gold: loadedData?.gold || 250,
                elixir: 10,
                maxElixir: 10,
                playerHealth: 100,
                enemyHealth: 100,
                selectedCard: null,
                playerCharacters: [],
                enemyCharacters: [],
                projectiles: [],
                damageEffects: [],
                healEffects: [],
                attackEffects: [],
                skillEffects: [],
                gameOver: false,
                characterLevels: loadedData?.characterLevels || {
                    warrior: 1,
                    archer: 1,
                    mage: 1,
                    blade: 1,
                    paladin: 1
                },
                fragments: loadedData?.fragments || {
                    warrior: 0,
                    archer: 0,
                    mage: 0,
                    blade: 0,
                    paladin: 0
                },
                characterBaseStats: {
                    warrior: { health: 350, damage: 25, cost: 4, range: 90, attackSpeed: 1400, healPower: 0, speed: 0.35, damageType: 'physical' },
                    archer: { health: 180, damage: 35, cost: 3, range: 220, attackSpeed: 1100, healPower: 0, speed: 0.4, damageType: 'physical' },
                    mage: { health: 150, damage: 55, cost: 4, range: 200, attackSpeed: 1800, healPower: 0, speed: 0.25, damageType: 'magic' },
                    blade: { health: 220, damage: 65, cost: 3, range: 70, attackSpeed: 900, healPower: 0, speed: 0.5, damageType: 'mixed' },
                    paladin: { health: 300, damage: 20, cost: 5, range: 90, attackSpeed: 1600, healPower: 30, speed: 0.3, damageType: 'magic' }
                },
                characterStats: {},
                enemyWaveCount: 0,
                tutorialClosed: localStorage.getItem('tutorialClosed') === 'true',
                lastSpawnTime: 0,
                spawnInterval: 3000,
                gameTime: 0,
                victoryTime: 3 * 60, // 3ÂàÜÈíü
                selectedCharacter: null,
                recallButtonVisible: false,
                paused: false,
                currentLevel: 1,
                maxLevels: {
                    1: 5,
                    2: 5,
                    3: 5,
                    4: 5,
                    5: 5,
                    endless: 6
                },
                completedLevels: loadedData?.completedLevels || [],
                endlessMode: false,
                killCount: 0,
                maxPlayerUnits: 6,
                nextWaveTimer: 0,
                waveInterval: 30000, // 30Áßí‰∏ÄÊ≥¢Êïå‰∫∫
                // Êñ∞Â¢ûÊ≥¢Ê¨°‰ø°ÊÅØ
                waveCount: 0,
                currentRunFragments: [], // ÂΩìÂâçÊ∏∏ÊàèËé∑ÂæóÁöÑÁ¢éÁâá
                lastFragmentKill: 0 // ‰∏äÊ¨°Ëé∑ÂæóÁ¢éÁâáÊó∂ÁöÑÂáªÊùÄÊï∞
            };

            // ÂàùÂßãÂåñËßíËâ≤Â±ûÊÄß
            function initCharacterStats() {
                for (const type in gameState.characterBaseStats) {
                    gameState.characterStats[type] = {...gameState.characterBaseStats[type]};
                    
                    // Ê†πÊçÆÁ≠âÁ∫ßÊèêÂçáÂ±ûÊÄß
                    const level = gameState.characterLevels[type];
                    if (level > 1) {
                        for (let i = 2; i <= level; i++) {
                            gameState.characterStats[type].health = Math.round(gameState.characterStats[type].health * 1.2);
                            gameState.characterStats[type].damage = Math.round(gameState.characterStats[type].damage * 1.15);
                            
                            if (type === 'paladin') {
                                gameState.characterStats[type].healPower = Math.round(gameState.characterStats[type].healPower * 1.15);
                            }
                        }
                    }
                }
            }
            
            // DOM ÂÖÉÁ¥†
            const elements = {
                goldCount: document.getElementById('gold-count'),
                elixirCount: document.getElementById('elixir-count'),
                elixirFill: document.getElementById('elixir-fill'),
                playerHealth: document.getElementById('player-health'),
                enemyHealth: document.getElementById('enemy-health'),
                cards: document.querySelectorAll('.card'),
                gameBoard: document.getElementById('game-board'),
                gameMessage: document.getElementById('game-message'),
                messageTitle: document.getElementById('message-title'),
                messageContent: document.getElementById('message-content'),
                restartButton: document.getElementById('restart-button'),
                backToLevelsButton: document.getElementById('back-to-levels'),
                backToLevelsUpgrade: document.getElementById('back-to-levels-upgrade'),
                backToLevelsNext: document.getElementById('back-to-levels-next'),
                levelUpContainer: document.getElementById('level-up-container'),
                levelUpOptions: document.querySelectorAll('.level-up-option'),
                tutorial: document.getElementById('tutorial'),
                tutorialClose: document.getElementById('tutorial-close'),
                particlesContainer: document.getElementById('particles-container'),
                recallButton: document.getElementById('recall-button'),
                timerDisplay: document.getElementById('timer-display'),
                levelSelector: document.getElementById('level-selector'),
                levelButtons: document.querySelectorAll('.level-button'),
                pauseButton: document.getElementById('pause-button'),
                cardDetail: document.getElementById('card-detail'),
                detailLevel: document.getElementById('detail-level'),
                detailHealth: document.getElementById('detail-health'),
                detailDamage: document.getElementById('detail-damage'),
                detailRange: document.getElementById('detail-range'),
                detailAttackSpeed: document.getElementById('detail-attackspeed'),
                detailCost: document.getElementById('detail-cost'),
                enemyInfo: document.getElementById('enemy-info'),
                enemyTypeName: document.getElementById('enemy-type-name'),
                enemyInfoHealth: document.getElementById('enemy-info-health'),
                enemyInfoDamage: document.getElementById('enemy-info-damage'),
                enemyInfoRange: document.getElementById('enemy-info-range'),
                nextLevelContainer: document.getElementById('next-level-container'),
                nextLevelButton: document.getElementById('next-level-button'),
                replayLevelButton: document.getElementById('replay-level-button'),
                closeDetail: document.getElementById('close-detail'),
                closeEnemyInfo: document.getElementById('close-enemy-info'),
                endlessStats: document.getElementById('endless-stats'),
                endlessTime: document.getElementById('endless-time'),
                killCount: document.getElementById('kill-count'),
                leaderboard: document.getElementById('leaderboard'),
                leaderboardList: document.getElementById('leaderboard-list'),
                leaderboardButton: document.getElementById('leaderboard-button'),
                closeLeaderboard: document.getElementById('close-leaderboard'),
                elixirBoostButton: document.getElementById('elixir-boost'),
                damageType: document.getElementById('detail-damage-type'),
                enemyResistance: document.getElementById('enemy-info-resistance'),
                detailSkill: document.getElementById('detail-skill'),
                detailFragments: document.getElementById('detail-fragments'),
                // Êñ∞Â¢ûÂÖÉÁ¥†
                waveCounter: document.getElementById('wave-counter'),
                waveTimer: document.getElementById('wave-timer'),
                // Á¢éÁâáÂÖÉÁ¥†
                warriorFragments: document.getElementById('warrior-fragments'),
                archerFragments: document.getElementById('archer-fragments'),
                mageFragments: document.getElementById('mage-fragments'),
                bladeFragments: document.getElementById('blade-fragments'),
                paladinFragments: document.getElementById('paladin-fragments'),
                // Á¢éÁâáÊî∂ÈõÜÂô®
                fragmentCollector: document.querySelector('.fragment-collector'),
                toggleFragments: document.getElementById('toggle-fragments'),
                victoryEffect: document.getElementById('victory-effect')
            };

            // ÂàùÂßãÂåñÊ∏∏Êàè
            function initGame() {
                initCharacterStats();
                
                // Êõ¥Êñ∞UI
                updateUI();
                setupEventListeners();
                
                // ÊòæÁ§∫ÊïôÁ®ãÔºàÂ¶ÇÊûúÊú™ÂÖ≥Èó≠Ôºâ
                if (!gameState.tutorialClosed) {
                    elements.tutorial.style.display = 'block';
                } else {
                    elements.tutorial.style.display = 'none';
                }
                
                // ÂàùÂßãÂåñÂÖ≥Âç°ÈÄâÊã©ÊåâÈíÆÁä∂ÊÄÅ
                updateLevelSelector();
                
                // ÂºÄÂßãÊ∏∏ÊàèÂæ™ÁéØ
                startGameLoop();
            }
            
            // Êõ¥Êñ∞ÂÖ≥Âç°ÈÄâÊã©Âô®Áä∂ÊÄÅ
            function updateLevelSelector() {
                elements.levelButtons.forEach(button => {
                    const level = button.dataset.level;
                    if (gameState.completedLevels.includes(level)) {
                        button.classList.add('completed');
                    } else {
                        button.classList.remove('completed');
                    }
                });
            }

            // ÂºÄÂßãÂÖ≥Âç°
            function startLevel(level) {
                gameState.currentLevel = level;
                saveGameData();
                gameState.endlessMode = (level === 'endless');
                gameState.maxPlayerUnits = (level === '5') ? 4 : 
                                        (level === 'endless') ? 5 : 4;
                elements.endlessStats.style.display = gameState.endlessMode ? 'flex' : 'none';
                
                if (level === 'endless') {
                    gameState.victoryTime = Infinity;
                    gameState.killCount = 0;
                    elements.killCount.textContent = '0';
                    gameState.currentRunFragments = [];
                    gameState.lastFragmentKill = 0;
                }
                
                // ÈáçÁΩÆÊ≥¢Ê¨°ËÆ°Êï∞Âô®
                gameState.waveCount = 0;
                elements.waveCounter.textContent = `Ê≥¢Ê¨°: ${gameState.waveCount}`;
                
                // ËÆæÁΩÆÊ≥¢Ê¨°Èó¥ÈöîÔºà30ÁßíÔºâ
                gameState.waveInterval = 30000;
                
                elements.levelSelector.style.display = 'none';
                resetGame();
            }

            // ËøîÂõûÂÖ≥Âç°ÈÄâÊã©
            function backToLevels() {
                elements.gameMessage.style.display = 'none';
                elements.levelUpContainer.style.display = 'none';
                elements.nextLevelContainer.style.display = 'none';
                elements.levelSelector.style.display = 'flex';
                gameState.gameOver = true;
            }

            // ÂàõÂª∫ËÉåÊôØÁ≤íÂ≠ê
            function createParticles() {
                for (let i = 0; i < 60; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.animationDelay = `${Math.random() * 6}s`;
                    particle.style.opacity = Math.random() * 0.6 + 0.3;
                    
                    // ÈöèÊú∫È¢úËâ≤Á≤íÂ≠ê
                    const colors = ['#f1c40f', '#3498db', '#2ecc71', '#9b59b6', '#e74c3c'];
                    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                    
                    elements.particlesContainer.appendChild(particle);
                }
            }

            // ÂàõÂª∫ÂëΩ‰∏≠Á≤íÂ≠êÊïàÊûú
            function createHitParticles(x, y, count, color) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'hit-particle';
                    particle.style.background = color;
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;
                    
                    // ÈöèÊú∫ÊñπÂêë
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 25 + Math.random() * 40;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;
                    
                    particle.style.setProperty('--tx', `${tx}px`);
                    particle.style.setProperty('--ty', `${ty}px`);
                    
                    elements.gameBoard.appendChild(particle);
                    
                    // Ëá™Âä®ÁßªÈô§
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 700);
                }
            }

            // ÂàõÂª∫ËßíËâ≤Ê≠ª‰∫°ÁâπÊïà
            function createDeathEffect(x, y, isPlayer) {
                // ‰∏ªÁàÜÁÇ∏ÊïàÊûú
                const explosion = document.createElement('div');
                explosion.className = 'explosion';
                explosion.style.left = `${x - 30}px`;
                explosion.style.top = `${y - 30}px`;
                explosion.style.background = isPlayer ? 
                    'radial-gradient(circle, #3498db, transparent)' : 
                    'radial-gradient(circle, #e74c3c, transparent)';
                explosion.style.boxShadow = isPlayer ? 
                    '0 0 30px #3498db' : 
                    '0 0 30px #e74c3c';
                
                elements.gameBoard.appendChild(explosion);
                
                // ÂàõÂª∫Á≤íÂ≠ê
                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'explosion-particle';
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;
                    particle.style.background = isPlayer ? '#3498db' : '#e74c3c';
                    
                    // ÈöèÊú∫ÊñπÂêë
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 60 + Math.random() * 60;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;
                    
                    particle.style.setProperty('--tx', `${tx}px`);
                    particle.style.setProperty('--ty', `${ty}px`);
                    
                    elements.gameBoard.appendChild(particle);
                    
                    // Ëá™Âä®ÁßªÈô§
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 800);
                }
                
                // ÁßªÈô§ÁàÜÁÇ∏ÊïàÊûú
                setTimeout(() => {
                    if (explosion.parentNode) {
                        explosion.parentNode.removeChild(explosion);
                    }
                }, 600);
            }

            // Ê£ÄÊü•ËßíËâ≤Á¢∞Êíû
            function checkCharacterCollision(x, y, radius = 30) {
                // Ê£ÄÊü•Áé©ÂÆ∂ËßíËâ≤Á¢∞Êíû
                for (const char of gameState.playerCharacters) {
                    const dx = x - char.x;
                    const dy = y - char.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < radius) {
                        return true;
                    }
                }
                
                // Ê£ÄÊü•Êïå‰∫∫ËßíËâ≤Á¢∞Êíû
                for (const enemy of gameState.enemyCharacters) {
                    const dx = x - enemy.x;
                    const dy = y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < radius) {
                        return true;
                    }
                }
                
                return false;
            }

            // Êõ¥Êñ∞UI
            function updateUI() {
                elements.goldCount.textContent = gameState.gold;
                elements.elixirCount.textContent = `${Math.floor(gameState.elixir)}/${gameState.maxElixir}`;
                elements.elixirFill.style.width = `${(gameState.elixir / gameState.maxElixir) * 100}%`;
                elements.playerHealth.style.width = `${gameState.playerHealth}%`;
                elements.enemyHealth.style.width = `${gameState.enemyHealth}%`;
                
                // Êõ¥Êñ∞Âç°ÁâåÁ≠âÁ∫ßÊòæÁ§∫
                elements.cards.forEach(card => {
                    const type = card.dataset.type;
                    const level = gameState.characterLevels[type];
                    card.querySelector('.card-level').textContent = level;
                    
                    // Êõ¥Êñ∞Âç°ÁâáÁ≠âÁ∫ßËæπÊ°Ü
                    card.className = `card level-${level}`;
                    
                    // Á¶ÅÁî®Êó†Ê≥ï‰ΩøÁî®ÁöÑÂç°Áâå
                    const cost = gameState.characterStats[type].cost;
                    if (gameState.elixir < cost) {
                        card.style.opacity = '0.6';
                    } else {
                        card.style.opacity = '1';
                    }
                });
                
                // Êõ¥Êñ∞ËÆ°Êó∂Âô®
                if (!gameState.endlessMode) {
                    const remainingTime = Math.max(0, gameState.victoryTime - gameState.gameTime);
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = Math.floor(remainingTime % 60);
                    elements.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    // Êó†Â∞ΩÊ®°ÂºèÊòæÁ§∫Ê∏∏ÊàèÊó∂Èó¥
                    const minutes = Math.floor(gameState.gameTime / 60);
                    const seconds = Math.floor(gameState.gameTime % 60);
                    elements.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    elements.endlessTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // Êõ¥Êñ∞Ê≥¢Ê¨°ËÆ°Êï∞Âô®
                elements.waveCounter.textContent = `Ê≥¢Ê¨°: ${gameState.waveCount}`;
                
                // Êõ¥Êñ∞‰∏ã‰∏ÄÊ≥¢ÂÄíËÆ°Êó∂
                if (gameState.nextWaveTimer > 0) {
                    const timeLeft = Math.max(0, gameState.nextWaveTimer - Date.now());
                    const secondsLeft = Math.ceil(timeLeft / 1000);
                    elements.waveTimer.textContent = `‰∏ã‰∏ÄÊ≥¢: ${secondsLeft}Áßí`;
                } else {
                    elements.waveTimer.textContent = "‰∏ã‰∏ÄÊ≥¢: ÂáÜÂ§á‰∏≠";
                }
                
                // Êõ¥Êñ∞ÊäÄËÉΩÊåâÈíÆÁä∂ÊÄÅ
                elements.elixirBoostButton.disabled = gameState.gold < 50;
                
                // Êõ¥Êñ∞Á¢éÁâáÊòæÁ§∫
                elements.warriorFragments.textContent = `${gameState.fragments.warrior}/5`;
                elements.archerFragments.textContent = `${gameState.fragments.archer}/5`;
                elements.mageFragments.textContent = `${gameState.fragments.mage}/5`;
                elements.bladeFragments.textContent = `${gameState.fragments.blade}/5`;
                elements.paladinFragments.textContent = `${gameState.fragments.paladin}/5`;
            }

            // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
            function setupEventListeners() {
                // Âç°ÁâåÈÄâÊã©
                elements.cards.forEach(card => {
                    card.addEventListener('click', () => {
                        if (gameState.gameOver || gameState.paused) return;
                        
                        const type = card.dataset.type;
                        const cost = gameState.characterStats[type].cost;
                        
                        if (gameState.elixir >= cost) {
                            // ÂèñÊ∂à‰πãÂâçÁöÑÈÄâÊã©
                            elements.cards.forEach(c => c.classList.remove('selected'));
                            card.classList.add('selected');
                            gameState.selectedCard = type;
                        }
                    });
                });
                
                // Ê∏∏ÊàèÊùøÁÇπÂáªÔºàÊîæÁΩÆËßíËâ≤Ôºâ
                elements.gameBoard.addEventListener('click', (e) => {
                    if (gameState.gameOver || gameState.paused || !gameState.selectedCard) return;
                    
                    const rect = elements.gameBoard.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Âè™ËÉΩÊîæÁΩÆÂú®‰∏ãÂçäÈÉ®ÂàÜ
                    if (y > 290 && gameState.playerCharacters.length < gameState.maxPlayerUnits) {
                        // Ê£ÄÊü•Á¢∞Êíû
                        if (!checkCharacterCollision(x, y)) {
                            placeCharacter(gameState.selectedCard, x, y);
                        }
                    }
                });
                
                // ÈáçÊñ∞ÂºÄÂßãÊåâÈíÆ
                elements.restartButton.addEventListener('click', () => {
                    elements.gameMessage.style.display = 'none';
                    resetGame();
                });
                
                // ËøîÂõûÂÖ≥Âç°ÈÄâÊã©ÊåâÈíÆ
                elements.backToLevelsButton.addEventListener('click', backToLevels);
                elements.backToLevelsUpgrade.addEventListener('click', backToLevels);
                elements.backToLevelsNext.addEventListener('click', backToLevels);
                
                // ÂçáÁ∫ßÈÄâÈ°π
                elements.levelUpOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const type = option.dataset.type;
                        upgradeCharacter(type);
                    });
                });
                
                // ÂÖ≥Èó≠ÊïôÁ®ã
                elements.tutorialClose.addEventListener('click', () => {
                    elements.tutorial.style.display = 'none';
                    gameState.tutorialClosed = true;
                    localStorage.setItem('tutorialClosed', 'true');
                });
                
                // Âè¨ÂõûÊåâÈíÆ
                elements.recallButton.addEventListener('click', recallCharacter);
                
                // ËßíËâ≤ÈÄâÊã©
                elements.gameBoard.addEventListener('click', (e) => {
                    if (gameState.gameOver || gameState.paused) return;
                    
                    const rect = elements.gameBoard.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÁé©ÂÆ∂ËßíËâ≤
                    for (const char of gameState.playerCharacters) {
                        const dx = x - char.x;
                        const dy = y - char.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 30) {
                            gameState.selectedCharacter = char;
                            elements.recallButton.style.display = 'block';
                            elements.recallButton.style.left = `${char.x - 40}px`;
                            elements.recallButton.style.top = `${char.y - 70}px`;
                            return;
                        }
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÊïå‰∫∫
                    for (const enemy of gameState.enemyCharacters) {
                        const dx = x - enemy.x;
                        const dy = y - enemy.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 30) {
                            // ÊòæÁ§∫Êïå‰∫∫‰ø°ÊÅØ
                            showEnemyInfo(enemy);
                            return;
                        }
                    }
                    
                    // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèÂè¨ÂõûÊåâÈíÆÂíåÊïå‰∫∫‰ø°ÊÅØ
                    elements.recallButton.style.display = 'none';
                    elements.enemyInfo.style.display = 'none';
                    gameState.selectedCharacter = null;
                });
                
                // ÂÖ≥Âç°ÈÄâÊã©ÊåâÈíÆ
                elements.levelButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const level = button.dataset.level;
                        startLevel(level);
                    });
                });
                
                // ÊöÇÂÅúÊåâÈíÆ
                elements.pauseButton.addEventListener('click', togglePause);
                
                // Âç°ÁâáÁÇπÂáªÔºàÊöÇÂÅúÁä∂ÊÄÅ‰∏ãÔºâ
                elements.cards.forEach(card => {
                    card.addEventListener('click', () => {
                        if (gameState.paused) {
                            const type = card.dataset.type;
                            showCardDetail(type);
                        }
                    });
                });
                
                // ‰∏ã‰∏ÄÂÖ≥ÊåâÈíÆ
                elements.nextLevelButton.addEventListener('click', () => {
                    const nextLevel = (gameState.currentLevel === 'endless') ? 'endless' : parseInt(gameState.currentLevel) + 1;
                    if (nextLevel <= 5 || nextLevel === 'endless') {
                        startLevel(nextLevel);
                    } else {
                        // Â∑≤ÁªèÊòØÊúÄÂêé‰∏ÄÂÖ≥
                        elements.nextLevelContainer.style.display = 'none';
                        elements.gameMessage.style.display = 'block';
                        elements.messageTitle.textContent = "ÊÅ≠ÂñúÈÄöÂÖ≥ÔºÅ";
                        elements.messageContent.textContent = "‰Ω†Â∑≤ÂÆåÊàêÊâÄÊúâÂÖ≥Âç°ÔºÅ";
                    }
                });
                
                // ÈáçÊñ∞ÊåëÊàòÊåâÈíÆ
                elements.replayLevelButton.addEventListener('click', () => {
                    elements.nextLevelContainer.style.display = 'none';
                    resetGame();
                });
                
                // ÂÖ≥Èó≠ËØ¶ÊÉÖÈù¢Êùø
                elements.closeDetail.addEventListener('click', () => {
                    elements.cardDetail.style.display = 'none';
                });
                
                // ÂÖ≥Èó≠Êïå‰∫∫‰ø°ÊÅØÈù¢Êùø
                elements.closeEnemyInfo.addEventListener('click', () => {
                    elements.enemyInfo.style.display = 'none';
                });
                
                // ÊéíË°åÊ¶úÊåâÈíÆ
                elements.leaderboardButton.addEventListener('click', showLeaderboard);
                elements.closeLeaderboard.addEventListener('click', () => {
                    elements.leaderboard.style.display = 'none';
                });
                
                // Ê≥ïÂäõÊ≥®ÂÖ•ÊäÄËÉΩ
                elements.elixirBoostButton.addEventListener('click', () => {
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        saveGameData();
                        gameState.elixir = Math.min(gameState.maxElixir, gameState.elixir + 5);
                        updateUI();
                        
                        // ÂàõÂª∫ÁâπÊïà
                        createHealEffect(210, 560, "+5Ê≥ïÂäõ");
                        createEmotion(210, 560, 'confident');
                    }
                });
                
                // Á¢éÁâáÊî∂ÈõÜÂô®ÊåâÈíÆ
                elements.toggleFragments.addEventListener('click', () => {
                    elements.fragmentCollector.style.display = 
                        elements.fragmentCollector.style.display === 'none' ? 'flex' : 'none';
                });
            }

            // ÊòæÁ§∫ÊéíË°åÊ¶ú
            function showLeaderboard() {
                elements.leaderboard.style.display = 'block';
                updateLeaderboard();
            }

            // Êõ¥Êñ∞ÊéíË°åÊ¶ú
            function updateLeaderboard() {
                const leaderboardData = JSON.parse(localStorage.getItem('leaderboard') || '[]');
                elements.leaderboardList.innerHTML = '<li class="leaderboard-item leaderboard-header"><span class="leaderboard-rank">#</span><span class="leaderboard-time">Êó∂Èó¥</span><span class="leaderboard-kills">ÂáªÊùÄ</span><span class="leaderboard-date">Êó•Êúü</span></li>';
                
                // Âè™ÊòæÁ§∫Ââç10Âêç
                leaderboardData.slice(0, 10).forEach((entry, index) => {
                    const li = document.createElement('li');
                    li.className = 'leaderboard-item';
                    
                    const minutes = Math.floor(entry.time / 60);
                    const seconds = Math.floor(entry.time % 60);
                    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    const date = new Date(entry.timestamp).toLocaleDateString();
                    
                    li.innerHTML = `
                        <span class="leaderboard-rank">${index + 1}</span>
                        <span class="leaderboard-time">${timeString}</span>
                        <span class="leaderboard-kills">${entry.kills}</span>
                        <span class="leaderboard-date">${date}</span>
                    `;
                    
                    elements.leaderboardList.appendChild(li);
                });
            }

            // ‰øùÂ≠òÊéíË°åÊ¶úÊï∞ÊçÆ
            function saveToLeaderboard() {
                if (!gameState.endlessMode) return;
                
                const leaderboardData = JSON.parse(localStorage.getItem('leaderboard') || '[]');
                const newEntry = {
                    time: Math.floor(gameState.gameTime),
                    kills: gameState.killCount,
                    timestamp: Date.now(),
                    fragments: gameState.currentRunFragments.length
                };
                
                leaderboardData.push(newEntry);
                
                // ÊåâÊó∂Èó¥ÈôçÂ∫èÊéíÂ∫è
                leaderboardData.sort((a, b) => b.time - a.time);
                
                // Âè™‰øùÁïôÂâç20Âêç
                if (leaderboardData.length > 20) {
                    leaderboardData.length = 20;
                }
                
                localStorage.setItem('leaderboard', JSON.stringify(leaderboardData));
            }

            // ÊòæÁ§∫Âç°ÁâáËØ¶ÊÉÖ
            function showCardDetail(type) {
                const stats = gameState.characterStats[type];
                const level = gameState.characterLevels[type];

                // Êõ¥Êñ∞ËØ¶ÊÉÖÈù¢Êùø
                elements.detailLevel.textContent = level;
                elements.detailHealth.textContent = stats.health;
                elements.detailDamage.textContent = stats.damage;
                elements.detailRange.textContent = stats.range;
                elements.detailAttackSpeed.textContent = (stats.attackSpeed / 1000).toFixed(1) + 'Áßí';
                elements.detailCost.textContent = stats.cost;
                elements.detailFragments.textContent = `${gameState.fragments[type]}/5`;
                elements.damageType.textContent =
                    stats.damageType === 'physical' ? 'Áâ©ÁêÜ' :
                    stats.damageType === 'magic' ? 'Ê≥ïÊúØ' : 'Ê∑∑Âêà';

                // Êõ¥Êñ∞ÊäÄËÉΩÊèèËø∞
                let skillDesc = '';
                switch(type) {
                    case 'warrior':
                        skillDesc = 'Âò≤ËÆΩ+ÂèçÂºπ‰º§ÂÆ≥';
                        break;
                    case 'archer':
                        skillDesc = 'Âº∫ÂäõÁÆ≠(2ÂÄç‰º§ÂÆ≥)';
                        break;
                    case 'mage':
                        skillDesc = 'ËåÉÂõ¥‰º§ÂÆ≥';
                        break;
                    case 'blade':
                        skillDesc = 'ÂÜ≤Âà∫ÊîªÂáª(1.5ÂÄç‰º§ÂÆ≥)';
                        break;
                    case 'paladin':
                        skillDesc = 'Âú£ÂÖâÊ≤ªÁñó';
                        break;
                }
                elements.detailSkill.textContent = skillDesc;

                // Êõ¥Êñ∞ÂõæÊ†á
                const icon = elements.cardDetail.querySelector('.detail-icon i');
                icon.className = `fas fa-${getCharacterIcon(type)}`;

                // Êõ¥Êñ∞Ê†áÈ¢ò
                const title = elements.cardDetail.querySelector('.detail-info h3');
                switch(type) {
                    case 'warrior': title.textContent = 'Âú£ÁõæÊàòÂ£´'; break;
                    case 'archer': title.textContent = 'Á≤æÁÅµÂ∞ÑÊâã'; break;
                    case 'mage': title.textContent = 'Â••ÊúØÊ≥ïÂ∏à'; break;
                    case 'blade': title.textContent = 'ÂΩ±ÂàÉÂà∫ÂÆ¢'; break;
                    case 'paladin': title.textContent = 'Á•ûÂú£È™ëÂ£´'; break;
                }

                // Ê∑ªÂä†Á≠âÁ∫ßËæπÊ°Ü
                elements.cardDetail.classList.remove('level-1', 'level-2', 'level-3', 'level-4', 'level-5', 'level-6');
                elements.cardDetail.classList.add(`level-${level}`);

                // ÊòæÁ§∫Èù¢Êùø
                elements.cardDetail.style.display = 'block';
            }

            // ÊòæÁ§∫Êïå‰∫∫‰ø°ÊÅØ
            function showEnemyInfo(enemy) {
                elements.enemyTypeName.textContent =
                    enemy.type === 'boss' ? 'Boss' :
                    enemy.type === 'elite' ? 'Á≤æËã±Êïå‰∫∫' :
                    enemy.type === 'tank' ? 'Âù¶ÂÖãÊïå‰∫∫' :
                    enemy.type === 'speedy' ? 'Âø´ÈÄüÊïå‰∫∫' :
                    enemy.type === 'flyer' ? 'È£ûË°åÊïå‰∫∫' :
                    enemy.type === 'magic-immune' ? 'Ê≥ïÊúØÂÖçÁñ´ÊÄ™' :
                    enemy.type === 'physical-immune' ? 'Áâ©ÁêÜÂÖçÁñ´ÊÄ™' : 'ÊôÆÈÄöÊïå‰∫∫';

                elements.enemyInfoHealth.textContent = enemy.health;
                elements.enemyInfoDamage.textContent = enemy.damage;
                elements.enemyInfoRange.textContent = enemy.attackRange;

                // Êõ¥Êñ∞ÊäóÊÄß‰ø°ÊÅØ
                if (enemy.type === 'magic-immune') {
                    elements.enemyResistance.textContent = 'Ê≥ïÊúØ‰º§ÂÆ≥ÂáèÂçä';
                } else if (enemy.type === 'physical-immune') {
                    elements.enemyResistance.textContent = 'Áâ©ÁêÜ‰º§ÂÆ≥ÂáèÂçä';
                } else {
                    elements.enemyResistance.textContent = 'Êó†';
                }

                // Êõ¥Êñ∞ÂõæÊ†á
                const icon = elements.enemyInfo.querySelector('.enemy-icon i');
                if (enemy.type === 'boss') {
                    icon.className = 'fas fa-dragon';
                } else if (enemy.type === 'elite') {
                    icon.className = 'fas fa-skull-crossbones';
                } else if (enemy.type === 'tank') {
                    icon.className = 'fas fa-shield-alt';
                } else if (enemy.type === 'speedy') {
                    icon.className = 'fas fa-bolt';
                } else if (enemy.type === 'flyer') {
                    icon.className = 'fas fa-dove';
                } else if (enemy.type === 'magic-immune') {
                    icon.className = 'fas fa-hat-wizard';
                } else if (enemy.type === 'physical-immune') {
                    icon.className = 'fas fa-shield-alt';
                } else {
                    icon.className = 'fas fa-skull';
                }

                elements.enemyInfo.style.display = 'block';
            }

            // ÂàáÊç¢ÊöÇÂÅúÁä∂ÊÄÅ
            function togglePause() {
                gameState.paused = !gameState.paused;
                const icon = elements.pauseButton.querySelector('i');
                
                if (gameState.paused) {
                    icon.className = 'fas fa-play';
                    elements.timerDisplay.textContent = 'ÊöÇÂÅú‰∏≠';
                } else {
                    icon.className = 'fas fa-pause';
                    // ÊÅ¢Â§çËÆ°Êó∂Âô®ÊòæÁ§∫
                    if (gameState.endlessMode) {
                        const minutes = Math.floor(gameState.gameTime / 60);
                        const seconds = Math.floor(gameState.gameTime % 60);
                        elements.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    } else {
                        const remainingTime = Math.max(0, gameState.victoryTime - gameState.gameTime);
                        const minutes = Math.floor(remainingTime / 60);
                        const seconds = Math.floor(remainingTime % 60);
                        elements.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
                
                // ÈöêËóèËØ¶ÊÉÖÈù¢Êùø
                elements.cardDetail.style.display = 'none';
                elements.enemyInfo.style.display = 'none';
            }

            // Âè¨ÂõûËßíËâ≤
            function recallCharacter() {
                if (gameState.selectedCharacter) {
                    const char = gameState.selectedCharacter;
                    const charEl = document.querySelector(`.player-character[data-id="${char.id}"]`);
                    
                    // ËøîËøòÈÉ®ÂàÜÊ≥ïÂäõÂÄº
                    gameState.elixir += Math.floor(gameState.characterStats[char.type].cost * 0.35);
                    
                    // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§
                    gameState.playerCharacters = gameState.playerCharacters.filter(c => c.id !== char.id);
                    
                    // ÁßªÈô§DOMÂÖÉÁ¥†
                    if (charEl) charEl.remove();
                    
                    // ÈöêËóèÂè¨ÂõûÊåâÈíÆ
                    elements.recallButton.style.display = 'none';
                    gameState.selectedCharacter = null;
                    
                    updateUI();
                    
                    // ÊòæÁ§∫Áñ≤ÊÉ´Ë°®ÊÉÖ
                    createEmotion(char.x, char.y, 'tired');
                }
            }

            // ÊîæÁΩÆËßíËâ≤
            function placeCharacter(type, x, y) {
                const stats = gameState.characterStats[type];
                
                if (gameState.elixir < stats.cost || gameState.playerCharacters.length >= gameState.maxPlayerUnits) return;
                
                gameState.elixir -= stats.cost;
                
                const character = {
                    id: Date.now(),
                    type: type,
                    x: x,
                    y: y,
                    health: stats.health,
                    maxHealth: stats.health,
                    damage: stats.damage,
                    range: stats.range,
                    attackSpeed: stats.attackSpeed,
                    healPower: stats.healPower,
                    speed: stats.speed,
                    damageType: stats.damageType,
                    lastAttackTime: 0,
                    lastHealTime: 0,
                    lastSkillTime: 0,
                    lastEmotionTime: 0,
                    skillCooldown: type === 'warrior' ? 3000 : 
                                   type === 'archer' ? 8000 : 
                                   type === 'blade' ? 5000 : 
                                   type === 'paladin' ? 2000 : 0,
                    target: null,
                    moving: false,
                    nextAttackDouble: false,
                    reflectDamage: false
                };
                
                gameState.playerCharacters.push(character);
                
                // ÂàõÂª∫ËßíËâ≤ÂÖÉÁ¥†
                const charEl = document.createElement('div');
                charEl.className = `character player-character ${type}`;
                charEl.style.left = `${character.x - 25}px`;
                charEl.style.top = `${character.y - 25}px`;
                charEl.innerHTML = `
                    <i class="fas fa-${getCharacterIcon(type)}"></i>
                    <div class="character-health">
                        <div class="health-fill-character" style="width:100%"></div>
                    </div>
                    <div class="damage-type ${
                        stats.damageType === 'physical' ? 'physical-damage' : 
                        stats.damageType === 'magic' ? 'magic-damage' : 'mixed-damage'
                    }">
                        ${stats.damageType === 'physical' ? 'Áâ©ÁêÜ' : 
                          stats.damageType === 'magic' ? 'Ê≥ïÊúØ' : 'Ê∑∑Âêà'}
                    </div>
                `;
                charEl.dataset.id = character.id;
                elements.gameBoard.appendChild(charEl);
                
                // ÊòæÁ§∫Ëá™Ë±™Ë°®ÊÉÖ
                createEmotion(character.x, character.y, 'proud');
                
                // ÂèñÊ∂àÈÄâÊã©
                elements.cards.forEach(card => card.classList.remove('selected'));
                gameState.selectedCard = null;
                
                updateUI();
            }

            // ÁîüÊàêÊïå‰∫∫Ê≥¢Ê¨°
            function spawnEnemyWave() {
                if (gameState.gameOver || gameState.paused) return;
                
                gameState.enemyWaveCount++;
                gameState.waveCount++;
                
                // ÊòæÁ§∫Ê≥¢Ê¨°ÊèêÁ§∫
                const waveAlert = document.createElement('div');
                waveAlert.className = 'wave-alert';
                waveAlert.textContent = `Á¨¨ ${gameState.waveCount} Ê≥¢Êïå‰∫∫Êù•Ë¢≠!`;
                elements.gameBoard.appendChild(waveAlert);
                
                // Ëá™Âä®ÁßªÈô§ÊèêÁ§∫
                setTimeout(() => {
                    if (waveAlert.parentNode) {
                        waveAlert.parentNode.removeChild(waveAlert);
                    }
                }, 1500);
                
                // Ê†πÊçÆÂÖ≥Âç°Ë∞ÉÊï¥ÈöæÂ∫¶
                let normalCount = 2;
                let eliteCount = 0;
                let bossCount = 0;
                let tankCount = 0;
                let speedyCount = 0;
                let flyerCount = 0;
                let magicImmuneCount = 0;
                let physicalImmuneCount = 0;
                
                // ÂÖ≥Âç°ÈöæÂ∫¶Á≥ªÊï∞
                // Â§ÑÁêÜÊó†Â∞ΩÊ®°ÂºèÁöÑÈöæÂ∫¶Á≥ªÊï∞
                const levelMultiplier = gameState.currentLevel === 'endless' ? 2 : 1 + (parseInt(gameState.currentLevel) - 1) * 0.3;
                
                // Ê≥¢Ê¨°ÈöæÂ∫¶Á≥ªÊï∞ÔºàÊØèÊ≥¢Â¢ûÂä†Ôºâ
                const waveMultiplier = Math.min(1 + (gameState.waveCount - 1) * 0.3, 5);
                
                switch(gameState.currentLevel) {
                    case "1":
                        normalCount = Math.round(2 * waveMultiplier);
                        break;
                    case "2":
                        normalCount = Math.round(2 * waveMultiplier);
                        eliteCount = Math.round(1 * waveMultiplier);
                        break;
                    case "3":
                        normalCount = Math.round(2 * waveMultiplier);
                        eliteCount = Math.round(2 * waveMultiplier);
                        bossCount = Math.round(1 * waveMultiplier);
                        tankCount = Math.round(1 * waveMultiplier);
                        break;
                    case "4":
                    case "5":
                    case "endless":
                        normalCount = Math.round(3 * waveMultiplier);
                        eliteCount = Math.round(2 * waveMultiplier);
                        bossCount = Math.round(1 * waveMultiplier);
                        tankCount = Math.round(1 * waveMultiplier);
                        speedyCount = Math.round(2 * waveMultiplier);
                        flyerCount = Math.round(1 * waveMultiplier);
                        magicImmuneCount = Math.round(1 * waveMultiplier);
                        physicalImmuneCount = Math.round(1 * waveMultiplier);
                        break;
                }
                
                // ÁîüÊàêÊôÆÈÄöÊïå‰∫∫
                for (let i = 0; i < normalCount; i++) {
                    setTimeout(() => {
                        spawnEnemyAtRandomPosition('normal');
                    }, i * 2000);
                }
                
                // ÁîüÊàêÁ≤æËã±Êïå‰∫∫
                for (let i = 0; i < eliteCount; i++) {
                    setTimeout(() => {
                        spawnEnemyAtRandomPosition('elite');
                    }, (i + normalCount) * 2000);
                }
                
                // ÁîüÊàêBoss
                for (let i = 0; i < bossCount; i++) {
                    setTimeout(() => {
                        spawnEnemy('boss', 210, 60);
                    }, (i + normalCount + eliteCount) * 2000);
                }
                
                // ÁîüÊàêÂù¶ÂÖãÊïå‰∫∫
                for (let i = 0; i < tankCount; i++) {
                    setTimeout(() => {
                        spawnEnemyAtRandomPosition('tank');
                    }, (i + normalCount + eliteCount + bossCount) * 2000);
                }
                
                // ÁîüÊàêÂø´ÈÄüÊïå‰∫∫
                for (let i = 0; i < speedyCount; i++) {
                    setTimeout(() => {
                        spawnEnemyAtRandomPosition('speedy');
                    }, (i + normalCount + eliteCount + bossCount + tankCount) * 2000);
                }
                
                // ÁîüÊàêÈ£ûË°åÊïå‰∫∫
                for (let i = 0; i < flyerCount; i++) {
                    setTimeout(() => {
                        spawnEnemyAtRandomPosition('flyer');
                    }, (i + normalCount + eliteCount + bossCount + tankCount + speedyCount) * 2000);
                }
                
                // ÁîüÊàêÊ≥ïÊúØÂÖçÁñ´ÊÄ™
                for (let i = 0; i < magicImmuneCount; i++) {
                    setTimeout(() => {
                        spawnEnemyAtRandomPosition('magic-immune');
                    }, (i + normalCount + eliteCount + bossCount + tankCount + speedyCount + flyerCount) * 2000);
                }
                
                // ÁîüÊàêÁâ©ÁêÜÂÖçÁñ´ÊÄ™
                for (let i = 0; i < physicalImmuneCount; i++) {
                    setTimeout(() => {
                        spawnEnemyAtRandomPosition('physical-immune');
                    }, (i + normalCount + eliteCount + bossCount + tankCount + speedyCount + flyerCount + magicImmuneCount) * 2000);
                }
                
                // ‰∏ã‰∏ÄÊ≥¢Ôºà30ÁßíÂêéÔºâ
                gameState.nextWaveTimer = Date.now() + gameState.waveInterval;

            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÊïå‰∫∫Â∑≤Ë¢´Ê∂àÁÅ≠
            if (gameState.enemyCharacters.length === 0 && !gameState.gameOver) {
                gameState.nextWaveTimer = Date.now() + 5000; // 5ÁßíÂêéÁîüÊàê‰∏ã‰∏ÄÊ≥¢
            }
            }
            
            // Âú®ÈöèÊú∫‰ΩçÁΩÆÁîüÊàêÊïå‰∫∫
            function spawnEnemyAtRandomPosition(type) {
                let x, y;
                let validPosition = false;
                
                while (!validPosition) {
                    x = Math.random() * 350 + 35;
                    y = 60;
                    if (!checkCharacterCollision(x, y)) {
                        validPosition = true;
                    }
                }
                
                spawnEnemy(type, x, y);
            }

            // ÁîüÊàêÊïå‰∫∫
            function spawnEnemy(type, x, y) {
                if (gameState.gameOver || gameState.paused) return;
                
                let health, damage, speed, attackRange, attackSpeed;
                
                // ÂÖ≥Âç°ÈöæÂ∫¶Á≥ªÊï∞
                // Â§ÑÁêÜÊó†Â∞ΩÊ®°ÂºèÁöÑÈöæÂ∫¶Á≥ªÊï∞
                const levelMultiplier = gameState.currentLevel === 'endless' ? 2 : 1 + (parseInt(gameState.currentLevel) - 1) * 0.3;
                
                // Ê≥¢Ê¨°ÈöæÂ∫¶Á≥ªÊï∞
                const waveMultiplier = Math.min(1 + (gameState.waveCount - 1) * 0.2, 3);
                
                switch (type) {
                    case 'normal':
                        health = Math.round(120 * levelMultiplier * waveMultiplier);
                        damage = Math.round(15 * levelMultiplier * waveMultiplier);
                        speed = 0.45;
                        attackRange = 85;
                        attackSpeed = 1900;
                        break;
                    case 'elite':
                        health = Math.round(250 * levelMultiplier * waveMultiplier);
                        damage = Math.round(25 * levelMultiplier * waveMultiplier);
                        speed = 0.35;
                        attackRange = 105;
                        attackSpeed = 1400;
                        break;
                    case 'boss':
                        health = Math.round(600 * levelMultiplier * waveMultiplier);
                        damage = Math.round(35 * levelMultiplier * waveMultiplier);
                        speed = 0.25;
                        attackRange = 130;
                        attackSpeed = 900;
                        break;
                    case 'tank':
                        health = Math.round(400 * levelMultiplier * waveMultiplier);
                        damage = Math.round(20 * levelMultiplier * waveMultiplier);
                        speed = 0.2;
                        attackRange = 100;
                        attackSpeed = 2000;
                        break;
                    case 'speedy':
                        health = Math.round(100 * levelMultiplier * waveMultiplier);
                        damage = Math.round(10 * levelMultiplier * waveMultiplier);
                        speed = 0.7;
                        attackRange = 70;
                        attackSpeed = 800;
                        break;
                    case 'flyer':
                        health = Math.round(150 * levelMultiplier * waveMultiplier);
                        damage = Math.round(30 * levelMultiplier * waveMultiplier);
                        speed = 0.4;
                        attackRange = 90;
                        attackSpeed = 1200;
                        break;
                    case 'magic-immune':
                        health = Math.round(200 * levelMultiplier * waveMultiplier);
                        damage = Math.round(20 * levelMultiplier * waveMultiplier);
                        speed = 0.3;
                        attackRange = 95;
                        attackSpeed = 1500;
                        break;
                    case 'physical-immune':
                        health = Math.round(180 * levelMultiplier * waveMultiplier);
                        damage = Math.round(25 * levelMultiplier * waveMultiplier);
                        speed = 0.35;
                        attackRange = 90;
                        attackSpeed = 1400;
                        break;
                }
                
                const enemy = {
                    id: Date.now(),
                    type: type,
                    x: x,
                    y: y,
                    health: health,
                    maxHealth: health,
                    damage: damage,
                    speed: speed,
                    attackRange: attackRange,
                    attackSpeed: attackSpeed,
                    lastAttackTime: 0,
                    lastEmotionTime: 0,
                    target: null,
                    moving: true
                };
                
                gameState.enemyCharacters.push(enemy);
                
                // ÂàõÂª∫Êïå‰∫∫ÂÖÉÁ¥†
                const enemyEl = document.createElement('div');
                enemyEl.className = `character enemy-character enemy ${type}`;
                enemyEl.style.left = `${x - 25}px`;
                enemyEl.style.top = `${y - 25}px`;
                enemyEl.innerHTML = `
                    <i class="fas fa-${getEnemyIcon(type)}"></i>
                    <div class="character-health">
                        <div class="health-fill-character" style="width:100%"></div>
                    </div>
                `;
                enemyEl.dataset.id = enemy.id;
                elements.gameBoard.appendChild(enemyEl);
                
                // ÊòæÁ§∫ÊåëË°ÖË°®ÊÉÖ
                createEmotion(x, y, 'angry');
            }

            // ÂçáÁ∫ßËßíËâ≤
            function upgradeCharacter(type) {
                const maxLevel = gameState.maxLevels[gameState.currentLevel];
                const currentLevel = gameState.characterLevels[type];
                
                if (currentLevel >= maxLevel) {
                    alert(`ÂΩìÂâçÂÖ≥Âç°ÊúÄÂ§öÂè™ËÉΩÂçáÁ∫ßÂà∞${maxLevel}Á∫ßÔºÅ`);
                    return;
                }
                
                if (gameState.gold >= 50) {
                    gameState.gold -= 50;
                    gameState.characterLevels[type]++;
                    
                    // ÊèêÂçáÂ±ûÊÄß
                    gameState.characterStats[type].health = Math.round(gameState.characterStats[type].health * 1.2);
                    gameState.characterStats[type].damage = Math.round(gameState.characterStats[type].damage * 1.15);
                    
                    if (type === 'paladin') {
                        gameState.characterStats[type].healPower = Math.round(gameState.characterStats[type].healPower * 1.15);
                    }
                    
                    // Êõ¥Êñ∞ËßíËâ≤Á≠âÁ∫ßÊòæÁ§∫
                    document.querySelectorAll(`.card[data-type="${type}"] .card-level`).forEach(el => {
                        el.textContent = gameState.characterLevels[type];
                    });
                    
                    // Êõ¥Êñ∞Âç°ÁâáËæπÊ°Ü
                    document.querySelectorAll(`.card[data-type="${type}"]`).forEach(card => {
                        card.className = `card level-${gameState.characterLevels[type]}`;
                    });
                    
                    updateUI();
                    
                    // ‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆ
                    saveGameData();
                    
                    // ÈöêËóèÂçáÁ∫ßÁïåÈù¢
                    elements.levelUpContainer.style.display = 'none';
                    
                    // ÊòæÁ§∫‰∏ã‰∏ÄÂÖ≥ÈÄâÊã©ÁïåÈù¢
                    elements.nextLevelContainer.style.display = 'block';
                    
                    // ÊòæÁ§∫ÂÖ¥Â•ãË°®ÊÉÖ
                    createEmotion(210, 560, 'amazed');
                    
                    // Ê†áËÆ∞ÂÖ≥Âç°ÂÆåÊàê
                    if (!gameState.completedLevels.includes(gameState.currentLevel)) {
                        gameState.completedLevels.push(gameState.currentLevel);
                        saveGameData();
                        // Êõ¥Êñ∞ÂÖ≥Âç°ÈÄâÊã©ÁïåÈù¢
                        updateLevelSelector();
                    }
                }
            }
            
            // ÂçáÁ∫ßËßíËâ≤Âà∞6Á∫ßÔºà‰ΩøÁî®Á¢éÁâáÔºâ
            function upgradeToLevel6(type) {
                // Ê£ÄÊü•ÂΩìÂâçÁ≠âÁ∫ßÊòØÂê¶‰∏∫5Á∫ß
                if (gameState.characterLevels[type] !== 5) {
                    alert('ËØ•ËÅå‰∏öÂ∞öÊú™ËææÂà∞5Á∫ßÔºåÊó†Ê≥ï‰ΩøÁî®Á¢éÁâáÂçáÁ∫ßÔºÅ');
                    return;
                }
                
                if (gameState.fragments[type] < 5) {
                    alert('Á¢éÁâá‰∏çË∂≥ÔºÅ');
                    return;
                }
                
                gameState.fragments[type] -= 5;
                gameState.characterLevels[type] = 6;
                
                // ÊèêÂçáÂ±ûÊÄß
                gameState.characterStats[type].health = Math.round(gameState.characterStats[type].health * 1.2);
                gameState.characterStats[type].damage = Math.round(gameState.characterStats[type].damage * 1.15);
                
                if (type === 'paladin') {
                    gameState.characterStats[type].healPower = Math.round(gameState.characterStats[type].healPower * 1.15);
                }
                
                // Êõ¥Êñ∞ËßíËâ≤Á≠âÁ∫ßÊòæÁ§∫
                document.querySelectorAll(`.card[data-type="${type}"] .card-level`).forEach(el => {
                    el.textContent = gameState.characterLevels[type];
                });
                
                // Êõ¥Êñ∞Âç°ÁâáËæπÊ°Ü
                document.querySelectorAll(`.card[data-type="${type}"]`).forEach(card => {
                    card.className = `card level-${gameState.characterLevels[type]}`;
                });
                
                updateUI();
                saveGameData();
                
                // ÊòæÁ§∫ÂÖ¥Â•ãË°®ÊÉÖ
                createEmotion(210, 560, 'amazed');
            }

            // Ê∏∏Êàè‰∏ªÂæ™ÁéØ
            function startGameLoop() {
                let lastTime = 0;
                let lastElixirTime = 0;
                let lastFragmentCheck = 0;
                
                function gameLoop(timestamp) {
                    try {
                        const deltaTime = timestamp - lastTime;
                        lastTime = timestamp;
                        
                        // Êõ¥Êñ∞Ê∏∏ÊàèÊó∂Èó¥ÔºàÂ¶ÇÊûúÊú™ÊöÇÂÅúÔºâ
                        if (!gameState.paused) {
                            gameState.gameTime += deltaTime / 1000;
                        }
                        
                        if (!gameState.gameOver) {
                            // ÊÅ¢Â§çÊ≥ïÂäõÂÄºÔºàÂ¶ÇÊûúÊú™ÊöÇÂÅúÔºâ
                            if (!gameState.paused && timestamp - lastElixirTime > 1000) {
                                gameState.elixir = Math.min(gameState.maxElixir, gameState.elixir + 0.6);
                                lastElixirTime = timestamp;
                            }
                            
                            // Ê£ÄÊü•ÊòØÂê¶ËØ•ÁîüÊàê‰∏ã‰∏ÄÊ≥¢Êïå‰∫∫
                            if (gameState.nextWaveTimer && timestamp > gameState.nextWaveTimer) {
                                spawnEnemyWave();
                            }
                            
                            // Ê£ÄÊü•Á¢éÁâáÂ•ñÂä±ÔºàÊØèÂáªË¥•50‰∏™Êïå‰∫∫Ôºâ
                            if (gameState.endlessMode && gameState.killCount >= gameState.lastFragmentKill + 50) {
                                gameState.lastFragmentKill = gameState.killCount;
                                awardRandomFragment();
                            }
                            
                            // Êõ¥Êñ∞ËßíËâ≤ÔºàÂ¶ÇÊûúÊú™ÊöÇÂÅúÔºâ
                            if (!gameState.paused) {
                                updateCharacters(deltaTime, timestamp);
                                
                                // Êõ¥Êñ∞ÊäõÂ∞ÑÁâ©
                                updateProjectiles(deltaTime);
                                
                                // Êõ¥Êñ∞‰º§ÂÆ≥ÊïàÊûú
                                updateDamageEffects(deltaTime);
                                
                                // Êõ¥Êñ∞Ê≤ªÁñóÊïàÊûú
                                updateHealEffects(deltaTime);
                                
                                // Êõ¥Êñ∞ÊîªÂáªÁâπÊïà
                                updateAttackEffects(deltaTime);
                                
                                // Êõ¥Êñ∞ÊäÄËÉΩÁâπÊïà
                                updateSkillEffects(deltaTime);
                                
                                // Êõ¥Êñ∞UI
                                updateUI();
                                
                                // Ê£ÄÊü•Ê∏∏ÊàèÁä∂ÊÄÅ
                                checkGameState();
                            }
                        }
                    } catch (error) {
                        console.error('Ê∏∏ÊàèÂæ™ÁéØÈîôËØØ:', error);
                        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØÁªôÁé©ÂÆ∂
                        const errorEl = document.createElement('div');
                        errorEl.className = 'game-error';
                        errorEl.textContent = 'Ê∏∏ÊàèÂèëÁîüÈîôËØØ: ' + error.message;
                        errorEl.style.position = 'absolute';
                        errorEl.style.top = '50%';
                        errorEl.style.left = '50%';
                        errorEl.style.transform = 'translate(-50%, -50%)';
                        errorEl.style.backgroundColor = 'rgba(231, 76, 60, 0.9)';
                        errorEl.style.color = 'white';
                        errorEl.style.padding = '20px';
                        errorEl.style.borderRadius = '5px';
                        errorEl.style.zIndex = '1000';
                        if (elements.gameBoard) {
                            elements.gameBoard.appendChild(errorEl);
                            // 3ÁßíÂêéËá™Âä®ÁßªÈô§ÈîôËØØÊèêÁ§∫
                            setTimeout(() => {
                                if (errorEl.parentNode) {
                                    errorEl.parentNode.removeChild(errorEl);
                                }
                            }, 3000);
                        }
                    } finally {
                        requestAnimationFrame(gameLoop);
                    }
                }
                
                requestAnimationFrame(gameLoop);
            }
            
            // Â•ñÂä±ÈöèÊú∫Á¢éÁâá
            function awardRandomFragment() {
                // Ëé∑ÂèñÊâÄÊúâËÅå‰∏ö
                const types = ['warrior', 'archer', 'mage', 'blade', 'paladin'];
                // ËøáÊª§Âá∫Á¢éÁâáÊú™Êª°ÁöÑËÅå‰∏öÔºà<5Ôºâ
                const availableTypes = types.filter(type => gameState.fragments[type] < 5);
                
                if (availableTypes.length === 0) {
                    return; // ÊâÄÊúâËÅå‰∏öÁ¢éÁâáÂ∑≤Êª°
                }
                
                // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ËÅå‰∏ö
                const randomType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                
                // Â¢ûÂä†Á¢éÁâá
                gameState.fragments[randomType]++;
                gameState.currentRunFragments.push(randomType);
                
                // ÊòæÁ§∫Ëé∑ÂæóÁ¢éÁâáÊèêÁ§∫
                const fragmentAlert = document.createElement('div');
                fragmentAlert.className = 'fragment-alert';
                fragmentAlert.textContent = `Ëé∑Âæó${getCharacterName(randomType)}Á¢éÁâá!`;
                elements.gameBoard.appendChild(fragmentAlert);
                
                // Ëá™Âä®ÁßªÈô§ÊèêÁ§∫
                setTimeout(() => {
                    if (fragmentAlert.parentNode) {
                        fragmentAlert.parentNode.removeChild(fragmentAlert);
                    }
                }, 1500);
                
                // ÊòæÁ§∫ÂÖ¥Â•ãË°®ÊÉÖ
                createEmotion(210, 560, 'amazed');
                
                // Êõ¥Êñ∞UI
                updateUI();
                saveGameData();
            }
            
            // Ëé∑ÂèñËßíËâ≤ÂêçÁß∞
            function getCharacterName(type) {
                switch(type) {
                    case 'warrior': return 'Âú£ÁõæÊàòÂ£´';
                    case 'archer': return 'Á≤æÁÅµÂ∞ÑÊâã';
                    case 'mage': return 'Â••ÊúØÊ≥ïÂ∏à';
                    case 'blade': return 'ÂΩ±ÂàÉÂà∫ÂÆ¢';
                    case 'paladin': return 'Á•ûÂú£È™ëÂ£´';
                }
            }

            // ËÆ°ÁÆóÂÆûÈôÖ‰º§ÂÆ≥ÔºàËÄÉËôëÊäóÊÄßÔºâ
            function calculateDamage(damage, damageType, enemyType) {
                // Âà∫ÂÆ¢ÁöÑÊ∑∑Âêà‰º§ÂÆ≥Êó†ËßÜÊâÄÊúâÊäóÊÄß
                if (damageType === 'mixed') {
                    return damage;
                }
                
                // Áâ©ÁêÜÂÖçÁñ´ÊÄ™ÔºöÊ≥ïÊúØ‰º§ÂÆ≥ÂáèÂçä
                if (enemyType === 'physical-immune') {
                    if (damageType === 'magic') return damage * 0.5;
                    if (damageType === 'physical') return damage * 0.5;
                }
                
                // Ê≥ïÊúØÂÖçÁñ´ÊÄ™ÔºöÁâ©ÁêÜ‰º§ÂÆ≥ÂáèÂçä
                if (enemyType === 'magic-immune') {
                    if (damageType === 'physical') return damage * 0.5;
                    if (damageType === 'magic') return damage * 0.5;
                }
                
                return damage;
            }

            // Êõ¥Êñ∞ËßíËâ≤
            function updateCharacters(deltaTime, timestamp) {
                // Êõ¥Êñ∞Áé©ÂÆ∂ËßíËâ≤
                gameState.playerCharacters.forEach((character) => {
                    // Êõ¥Êñ∞ËßíËâ≤‰ΩçÁΩÆ
                    const charEl = document.querySelector(`.player-character[data-id="${character.id}"]`);
                    if (charEl) {
                        charEl.style.left = `${character.x - 25}px`;
                        charEl.style.top = `${character.y - 25}px`;
                    }
                    
                    // Âú£È™ëÂ£´Ê≤ªÁñóÈÄªËæë
                    if (character.type === 'paladin' && timestamp - character.lastHealTime > 3000) {
                        character.lastHealTime = timestamp;
                        
                        // ÂØªÊâæÈúÄË¶ÅÊ≤ªÁñóÁöÑÂèãÂÜõ
                        gameState.playerCharacters.forEach(friend => {
                            if (friend.id !== character.id && friend.health < friend.maxHealth) {
                                const dx = character.x - friend.x;
                                const dy = character.y - friend.y;
                                const distance = Math.sqrt(dx * dx + dy * dy);
                                
                                if (distance <= character.range) {
                                    // Ê≤ªÁñóÂèãÂÜõ
                                    friend.health = Math.min(friend.maxHealth, friend.health + character.healPower);
                                    
                                    // Êõ¥Êñ∞Ë°ÄÊù°
                                    const friendEl = document.querySelector(`.player-character[data-id="${friend.id}"]`);
                                    if (friendEl) {
                                        const healthBar = friendEl.querySelector('.health-fill-character');
                                        if (healthBar) {
                                            healthBar.style.width = `${(friend.health / friend.maxHealth) * 100}%`;
                                        }
                                    }
                                    
                                    // ÂàõÂª∫Ê≤ªÁñóÊïàÊûú
                                    createHealEffect(friend.x, friend.y, `+${character.healPower}`);
                                    
                                    // ÂàõÂª∫Ê≤ªÁñóÁ≤íÂ≠ê
                                    createHitParticles(friend.x, friend.y, 6, '#2ecc71');
                                    
                                    // ÊòæÁ§∫È´òÂÖ¥Ë°®ÊÉÖ
                                    if (timestamp - friend.lastEmotionTime > 3000) {
                                        createEmotion(friend.x, friend.y, 'happy');
                                        friend.lastEmotionTime = timestamp;
                                    }
                                    
                                    // ÂàõÂª∫Ê≤ªÁñóÁâπÊïà
                                    const healEffect = document.createElement('div');
                                    healEffect.className = 'paladin-heal';
                                    healEffect.style.left = `${friend.x - 20}px`;
                                    healEffect.style.top = `${friend.y - 20}px`;
                                    elements.gameBoard.appendChild(healEffect);
                                    
                                    setTimeout(() => {
                                        if (healEffect.parentNode) {
                                            healEffect.parentNode.removeChild(healEffect);
                                        }
                                    }, 1000);
                                }
                            }
                        });
                        
                        // ÂàõÂª∫ÂÖâÁéØÁâπÊïà
                        const haloEffect = document.createElement('div');
                        haloEffect.className = 'paladin-halo';
                        haloEffect.style.left = `${character.x - 50}px`;
                        haloEffect.style.top = `${character.y - 50}px`;
                        elements.gameBoard.appendChild(haloEffect);
                        
                        setTimeout(() => {
                            if (haloEffect.parentNode) {
                                haloEffect.parentNode.removeChild(haloEffect);
                            }
                        }, 800);
                    }
                    
                    // ËßíËâ≤ÊäÄËÉΩËß¶Âèë
                    if (character.skillCooldown > 0 && timestamp - character.lastSkillTime > character.skillCooldown) {
                        triggerCharacterSkill(character, timestamp);
                    }
                    
                    // ÂØªÊâæÊúÄËøëÁöÑÊïå‰∫∫
                    if (!character.target || character.target.health <= 0) {
                        let closestEnemy = null;
                        let minDistance = Infinity;
                        
                        gameState.enemyCharacters.forEach(enemy => {
                            if (enemy.health > 0) {
                                const dx = character.x - enemy.x;
                                const dy = character.y - enemy.y;
                                const distance = Math.sqrt(dx * dx + dy * dy);
                                
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    closestEnemy = enemy;
                                }
                            }
                        });
                        
                        character.target = closestEnemy;
                    }
                    
                    // Â¶ÇÊûúÊúâÁõÆÊ†á
                    if (character.target) {
                        const dx = character.x - character.target.x;
                        const dy = character.y - character.target.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance <= character.range) {
                            // Âú®Â∞ÑÁ®ãÂÜÖÔºåÊîªÂáª
                            character.moving = false;
                            
                            if (timestamp - character.lastAttackTime > character.attackSpeed) {
                                character.lastAttackTime = timestamp;
                                
                                // ÂàõÂª∫ÊäõÂ∞ÑÁâ©ÊàñÊîªÂáªÁâπÊïà
                                if (character.type === 'warrior' || character.type === 'paladin') {
                                    createAttackEffect(character.target.x, character.target.y, character.type, character.damageType);
                                } else {
                                    let actualDamage = character.damage;
                                    
                                    // Â∞ÑÊâãÂº∫ÂäõÁÆ≠ÊïàÊûú
                                    if (character.type === 'archer' && character.nextAttackDouble) {
                                        actualDamage *= 2;
                                        character.nextAttackDouble = false;
                                    }
                                    
                                    if (character.target && character.target.health > 0) {
                        createProjectile(
                            character.x, 
                            character.y, 
                            character.target.x, 
                            character.target.y,
                            actualDamage,
                            character.type,
                            character.damageType,
                            character.nextAttackDouble
                        );
                    }
                                }
                                
                                // ÊòæÁ§∫ÂÖ¥Â•ãË°®ÊÉÖ
                                if (timestamp - character.lastEmotionTime > 3000) {
                                    createEmotion(character.x, character.y, character.type === 'warrior' ? 'confident' : character.type === 'archer' ? 'amazed' : 'excited');
                                    character.lastEmotionTime = timestamp;
                                }
                            }
                        } else {
                            // ‰∏çÂú®Â∞ÑÁ®ãÂÜÖÔºåÂêëÁõÆÊ†áÁßªÂä®
                            character.moving = true;
                            
                            // ËÆ°ÁÆóÁßªÂä®ÊñπÂêë
                            const angle = Math.atan2(character.target.y - character.y, character.target.x - character.x);
                            character.x += Math.cos(angle) * character.speed * (deltaTime / 16);
                            character.y += Math.sin(angle) * character.speed * (deltaTime / 16);
                        }
                    }
                });
                
                // Êõ¥Êñ∞Êïå‰∫∫
                gameState.enemyCharacters.forEach((enemy, index) => {
                    // ÂØªÊâæÁõÆÊ†áÔºà‰ºòÂÖàÁé©ÂÆ∂ËßíËâ≤Ôºâ
                    if (!enemy.target || enemy.target.health <= 0) {
                        let closestPlayer = null;
                        let minDistance = Infinity;
                        
                        gameState.playerCharacters.forEach(player => {
                            if (player.health > 0) {
                                const dx = enemy.x - player.x;
                                const dy = enemy.y - player.y;
                                const distance = Math.sqrt(dx * dx + dy * dy);
                                
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    closestPlayer = player;
                                }
                            }
                        });
                        
                        // Â¶ÇÊûúÁé©ÂÆ∂ËßíËâ≤Âú®ÊîªÂáªËåÉÂõ¥ÂÜÖÔºåÂàôËÆæ‰∏∫ÁõÆÊ†á
                        if (closestPlayer && minDistance <= enemy.attackRange) {
                            enemy.target = closestPlayer;
                            enemy.moving = false;
                        } else {
                            enemy.target = null;
                            enemy.moving = true;
                        }
                    }
                    
                    // Â¶ÇÊûúÁõÆÊ†áÂú®ÊîªÂáªËåÉÂõ¥ÂÜÖÔºåÂàôÊîªÂáª
                    if (enemy.target) {
                        const dx = enemy.x - enemy.target.x;
                        const dy = enemy.y - enemy.target.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance <= enemy.attackRange) {
                            enemy.moving = false;
                            
                            if (timestamp - enemy.lastAttackTime > enemy.attackSpeed) {
                                enemy.lastAttackTime = timestamp;
                                
                                // Ê∑ªÂä†ÊîªÂáªÂä®Áîª
                                const enemyEl = document.querySelector(`.enemy-character[data-id="${enemy.id}"]`);
                                if (enemyEl) {
                                    enemyEl.classList.add('attack-animation');
                                    setTimeout(() => { const el = document.querySelector(`.enemy-character[data-id="${enemy.id}"]`); if (el) el.classList.remove('attack-animation'); }, 300);
                                }
                                
                                // ÂØπÁõÆÊ†áÈÄ†Êàê‰º§ÂÆ≥
                                const damage = enemy.damage;
                                enemy.target.health -= damage;
                                
                                // ÊòæÁ§∫ÁóõËã¶Ë°®ÊÉÖ
                                if (timestamp - enemy.target.lastEmotionTime > 3000) {
                                    if (enemy.target.health / enemy.target.maxHealth < 0.3) {
                                        createEmotion(enemy.target.x, enemy.target.y, 'annoyed');
                                    } else {
                                        createEmotion(enemy.target.x, enemy.target.y, 'surprised');
                                    }
                                    enemy.target.lastEmotionTime = timestamp;
                                }
                                
                                // Â§ÑÁêÜÊàòÂ£´ÂèçÂºπ‰º§ÂÆ≥
                                if (enemy.target.type === 'warrior' && enemy.target.reflectDamage) {
                                    const reflectDamage = damage * 0.2;
                                    enemy.health -= reflectDamage;
                                    
                                    // ÂàõÂª∫ÂèçÂºπ‰º§ÂÆ≥ÊïàÊûú
                                    createDamageEffect(enemy.x, enemy.y, `-${Math.round(reflectDamage)}`, '#3498db');
                                    
                                    // ÂàõÂª∫ÂèçÂºπÁâπÊïà
                                    const reflectEl = document.createElement('div');
                                    reflectEl.className = 'reflect-effect';
                                    reflectEl.style.left = `${enemy.x - 30}px`;
                                    reflectEl.style.top = `${enemy.y - 30}px`;
                                    elements.gameBoard.appendChild(reflectEl);
                                    
                                    setTimeout(() => {
                                        if (reflectEl.parentNode) {
                                            reflectEl.parentNode.removeChild(reflectEl);
                                        }
                                    }, 500);
                                    
                                    // ÊòæÁ§∫Ëá™‰ø°Ë°®ÊÉÖ
                                    if (timestamp - enemy.target.lastEmotionTime > 3000) {
                                        createEmotion(enemy.target.x, enemy.target.y, 'confident');
                                        enemy.target.lastEmotionTime = timestamp;
                                    }
                                }
                                
                                // Â§ÑÁêÜÈ™ëÂ£´Ê≤ªÁñó
                                if (enemy.target.type === 'paladin' && timestamp - enemy.target.lastSkillTime > enemy.target.skillCooldown) {
                                    // È™ëÂ£´Ëá™Ë∫´Ê≤ªÁñó
                                    enemy.target.health = Math.min(enemy.target.maxHealth, enemy.target.health + damage * 0.5);
                                    
                                    // ÈôÑËøëÂèãÂÜõÊ≤ªÁñó
                                    gameState.playerCharacters.forEach(friend => {
                                        if (friend.id !== enemy.target.id) {
                                            const dx = enemy.target.x - friend.x;
                                            const dy = enemy.target.y - friend.y;
                                            const distance = Math.sqrt(dx * dx + dy * dy);
                                            
                                            if (distance < 120) {
                                                friend.health = Math.min(friend.maxHealth, friend.health + damage * 0.25);
                                                
                                                // ÂàõÂª∫Ê≤ªÁñóÊïàÊûú
                                                createHealEffect(friend.x, friend.y, `+${Math.round(damage * 0.25)}`);
                                                
                                                // ÊòæÁ§∫È´òÂÖ¥Ë°®ÊÉÖ
                                                if (timestamp - friend.lastEmotionTime > 3000) {
                                                    createEmotion(friend.x, friend.y, 'happy');
                                                    friend.lastEmotionTime = timestamp;
                                                }
                                            }
                                        }
                                    });
                                    
                                    // ÂàõÂª∫Ê≤ªÁñóÁâπÊïà
                                    const holyLight = document.createElement('div');
                                    holyLight.className = 'holy-light';
                                    holyLight.style.left = `${enemy.target.x - 40}px`;
                                    holyLight.style.top = `${enemy.target.y - 40}px`;
                                    elements.gameBoard.appendChild(holyLight);
                                    
                                    setTimeout(() => {
                                        if (holyLight.parentNode) {
                                            holyLight.parentNode.removeChild(holyLight);
                                        }
                                    }, 800);
                                    
                                    enemy.target.lastSkillTime = timestamp;
                                    
                                    // ÊòæÁ§∫ÂùöÂÆöË°®ÊÉÖ
                                    if (timestamp - enemy.target.lastEmotionTime > 3000) {
                                        createEmotion(enemy.target.x, enemy.target.y, 'determined');
                                        enemy.target.lastEmotionTime = timestamp;
                                    }
                                }
                                
                                // ÂàõÂª∫‰º§ÂÆ≥ÊïàÊûú
                                createDamageEffect(enemy.target.x, enemy.target.y, `-${damage}`, '#e74c3c');
                                
                                // ÂàõÂª∫ÂëΩ‰∏≠Á≤íÂ≠êÊïàÊûú
                                createHitParticles(enemy.target.x, enemy.target.y, 10, '#e74c3c');
                                
                                // Êõ¥Êñ∞Ë°ÄÊù°
                                const targetEl = document.querySelector(`.player-character[data-id="${enemy.target.id}"]`);
                                if (targetEl) {
                                    const healthBar = targetEl.querySelector('.health-fill-character');
                                    if (healthBar) {
                                        healthBar.style.width = `${(enemy.target.health / enemy.target.maxHealth) * 100}%`;
                                    }
                                }
                            }
                        } else {
                            // ÁõÆÊ†áË∂ÖÂá∫ËåÉÂõ¥ÔºåÁªßÁª≠ÁßªÂä®
                            enemy.moving = true;
                        }
                    } else {
                        enemy.moving = true;
                    }
                    
                    // ÁßªÂä®Êïå‰∫∫
                    if (enemy.moving) {
                        enemy.y += enemy.speed * (deltaTime / 16);
                    }
                    
                    // Êõ¥Êñ∞‰ΩçÁΩÆ
                    const enemyEl = document.querySelector(`.enemy-character[data-id="${enemy.id}"]`);
                    if (enemyEl) {
                        enemyEl.style.top = `${enemy.y}px`;
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÁé©ÂÆ∂Âü∫Âú∞
                    if (enemy.y > 540) {
                        gameState.playerHealth -= enemy.damage;
                        enemy.health = 0;
                        
                        // ÂàõÂª∫‰º§ÂÆ≥ÊïàÊûú
                        createDamageEffect(210, 560, `-${enemy.damage}`, '#e74c3c');
                        
                        // ÊòæÁ§∫Â§±Ë¥•Ë°®ÊÉÖ
                        createEmotion(210, 560, 'defeat');
                        
                        // ÁßªÈô§Êïå‰∫∫
                        if (enemyEl) enemyEl.remove();
                        gameState.enemyCharacters.splice(index, 1);
                    }
                });
                
                // Ê∏ÖÁêÜÊ≠ª‰∫°ËßíËâ≤
                gameState.playerCharacters = gameState.playerCharacters.filter(character => {
                    if (character.health <= 0) {
                        const charEl = document.querySelector(`.player-character[data-id="${character.id}"]`);
                        if (charEl) {
                            // ÊòæÁ§∫ÊÇ≤‰º§Ë°®ÊÉÖ
                            createEmotion(character.x, character.y, 'sad');
                            
                            // ÂàõÂª∫Ê≠ª‰∫°ÁâπÊïà
                            createDeathEffect(character.x, character.y, true);
                            charEl.remove();
                        }
                        return false;
                    }
                    return true;
                });
                
                gameState.enemyCharacters = gameState.enemyCharacters.filter(enemy => {
                    if (enemy.health <= 0) {
                        const enemyEl = document.querySelector(`.enemy-character[data-id="${enemy.id}"]`);
                        if (enemyEl) {
                            // ÊòæÁ§∫ÊÇ≤‰º§Ë°®ÊÉÖ
                            createEmotion(enemy.x, enemy.y, 'sad');
                            
                            // ÂàõÂª∫Ê≠ª‰∫°ÁâπÊïà
                            createDeathEffect(enemy.x, enemy.y, false);
                            enemyEl.remove();
                        }
                        
                        // Â¢ûÂä†ÂáªÊùÄËÆ°Êï∞ÔºàÊó†Â∞ΩÊ®°ÂºèÔºâ
                        if (gameState.endlessMode) {
                            gameState.killCount++;
                            elements.killCount.textContent = gameState.killCount;
                        }
                        
                        // ÊòæÁ§∫ËÉúÂà©Ë°®ÊÉÖ
                        if (enemy.type === 'boss') {
                            gameState.playerCharacters.forEach(char => {
                                if (Date.now() - char.lastEmotionTime > 3000) {
                                    createEmotion(char.x, char.y, 'victory');
                                    char.lastEmotionTime = Date.now();
                                }
                            });
                        }
                        
                        return false;
                    }
                    return true;
                });
            }
            
            // Ëß¶ÂèëËßíËâ≤ÊäÄËÉΩ
            function triggerCharacterSkill(character, timestamp) {
                character.lastSkillTime = timestamp;
                
                // ÊàòÂ£´ÊäÄËÉΩÔºöÂò≤ËÆΩ+ÂèçÂºπ‰º§ÂÆ≥
                if (character.type === 'warrior') {
                    // Âò≤ËÆΩÊïàÊûúÔºöÂê∏ÂºïÈôÑËøëÊïå‰∫∫
                    gameState.enemyCharacters.forEach(enemy => {
                        const dx = character.x - enemy.x;
                        const dy = character.y - enemy.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 150) {
                            enemy.target = character;
                        }
                    });
                    
                    // ËÆæÁΩÆÂèçÂºπ‰º§ÂÆ≥Áä∂ÊÄÅ
                    character.reflectDamage = true;
                    
                    // ÂàõÂª∫Âò≤ËÆΩÁâπÊïà
                    const tauntEl = document.createElement('div');
                    tauntEl.className = 'taunt-halo';
                    tauntEl.style.left = `${character.x - 60}px`;
                    tauntEl.style.top = `${character.y - 60}px`;
                    elements.gameBoard.appendChild(tauntEl);
                    
                    setTimeout(() => {
                        if (tauntEl.parentNode) {
                            tauntEl.parentNode.removeChild(tauntEl);
                        }
                    }, 1000);
                    
                    // ÂàõÂª∫ÊÑüÂèπÂè∑Ë°®ÊÉÖ
                    createEmotion(character.x, character.y, 'alert');
                    
                    // ÂèçÂºπÁä∂ÊÄÅÊåÅÁª≠3Áßí
                    setTimeout(() => {
                        character.reflectDamage = false;
                    }, 3000);
                    
                    // ÊòæÁ§∫ÂÖ¥Â•ãË°®ÊÉÖ
                    if (timestamp - character.lastEmotionTime > 3000) {
                        createEmotion(character.x, character.y, 'determined');
                        character.lastEmotionTime = timestamp;
                    }
                }
                
                // Â∞ÑÊâãÊäÄËÉΩÔºöÂº∫ÂäõÁÆ≠Ôºà‰∏ã‰∏ÄÊ¨°ÊîªÂáªÂèåÂÄç‰º§ÂÆ≥Ôºâ
                if (character.type === 'archer') {
                    character.nextAttackDouble = true;
                    
                    // ÂàõÂª∫ÊäÄËÉΩÁâπÊïà
                    const skillIndicator = document.createElement('div');
                    skillIndicator.className = 'skill-indicator';
                    skillIndicator.style.background = 'radial-gradient(circle, #ffd700, transparent)';
                    skillIndicator.style.boxShadow = '0 0 20px #ffd700';
                    skillIndicator.style.left = `${character.x - 30}px`;
                    skillIndicator.style.top = `${character.y - 30}px`;
                    elements.gameBoard.appendChild(skillIndicator);
                    
                    setTimeout(() => {
                        if (skillIndicator.parentNode) {
                            skillIndicator.parentNode.removeChild(skillIndicator);
                        }
                    }, 800);
                    
                    // ÊòæÁ§∫ÂÖ¥Â•ãË°®ÊÉÖ
                    if (timestamp - character.lastEmotionTime > 3000) {
                        createEmotion(character.x, character.y, 'amazed');
                        character.lastEmotionTime = timestamp;
                    }
                }
                
                // Âà∫ÂÆ¢ÊäÄËÉΩÔºöÂÜ≤Âà∫ÊîªÂáª
                if (character.type === 'blade' && character.target) {
                    // ÂàõÂª∫ÊÆãÂΩ±
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            const shadow = document.createElement('div');
                            shadow.className = 'blade-shadow';
                            shadow.style.left = `${character.x - 20}px`;
                            shadow.style.top = `${character.y - 20}px`;
                            elements.gameBoard.appendChild(shadow);
                            
                            setTimeout(() => {
                                if (shadow.parentNode) {
                                    shadow.parentNode.removeChild(shadow);
                                }
                            }, 500);
                        }, i * 100);
                    }
                    
                    // Áû¨Èó¥ÁßªÂä®Âà∞ÁõÆÊ†áÈôÑËøë
                    const angle = Math.atan2(character.target.y - character.y, character.target.x - character.x);
                    character.x = character.target.x - Math.cos(angle) * 40;
                    character.y = character.target.y - Math.sin(angle) * 40;
                    
                    // ÂàõÂª∫ÂÜ≤Âà∫ÁâπÊïà
                    const dashEl = document.createElement('div');
                    dashEl.className = 'blade-dash';
                    dashEl.style.setProperty('--dash-width', '100px');
                    dashEl.style.left = `${character.x}px`;
                    dashEl.style.top = `${character.y}px`;
                    dashEl.style.transform = `rotate(${angle}rad)`;
                    elements.gameBoard.appendChild(dashEl);
                    
                    setTimeout(() => {
                        if (dashEl.parentNode) {
                            dashEl.parentNode.removeChild(dashEl);
                        }
                    }, 300);
                    
                    // Á´ãÂç≥ËøõË°å‰∏ÄÊ¨°1.5ÂÄç‰º§ÂÆ≥ÁöÑÊîªÂáª
                    const actualDamage = character.damage * 1.5;
                    character.target.health -= actualDamage;
                    
                    // ÂàõÂª∫‰º§ÂÆ≥ÊïàÊûú
                    createDamageEffect(character.target.x, character.target.y, `-${Math.round(actualDamage)}`, '#e74c3c');
                    
                    // ÂàõÂª∫ÂëΩ‰∏≠Á≤íÂ≠êÊïàÊûú
                    createHitParticles(character.target.x, character.target.y, 15, '#e74c3c');
                    
                    // ÈáçÁΩÆÊîªÂáªËÆ°Êó∂Âô®
                    character.lastAttackTime = timestamp;
                    
                    // ÊòæÁ§∫ÂÖ¥Â•ãË°®ÊÉÖ
                    if (timestamp - character.lastEmotionTime > 3000) {
                        createEmotion(character.x, character.y, 'excited');
                        character.lastEmotionTime = timestamp;
                    }
                }
            }

            // ÂàõÂª∫ÊäõÂ∞ÑÁâ©ÔºàÂ∏¶ÁâπÊïàÔºâ
            function createProjectile(startX, startY, endX, endY, damage, type, damageType, isDouble) {
                let projectileClass = '';

                // Ê†πÊçÆËßíËâ≤Á±ªÂûãËÆæÁΩÆ‰∏çÂêåÁöÑÁâπÊïà
                switch (type) {
                    case 'archer':
                        projectileClass = isDouble ? 'archer-projectile power-shot' : 'archer-projectile';
                        break;
                    case 'mage':
                        projectileClass = 'mage-projectile';
                        break;
                    case 'blade':
                        projectileClass = 'blade-projectile';
                        break;
                    default:
                        projectileClass = 'physical';
                }

                const projectile = {
                    id: Date.now(),
                    x: startX,
                    y: startY,
                    startX: startX,
                    startY: startY,
                    endX: endX,
                    endY: endY,
                    damage: damage,
                    type: type,
                    damageType: damageType,
                    progress: 0,
                    speed: 0.06
                };

                gameState.projectiles.push(projectile);

                // ÂàõÂª∫ÊäõÂ∞ÑÁâ©ÂÖÉÁ¥†
                const projEl = document.createElement('div');
                projEl.className = `projectile ${projectileClass}`;
                projEl.style.left = `${startX - 15}px`;
                projEl.style.top = `${startY - 15}px`;
                projEl.dataset.id = projectile.id;

                // ËÆ°ÁÆóËßíÂ∫¶Âπ∂ÊóãËΩ¨ÊäõÂ∞ÑÁâ©
                const dx = endX - startX;
                const dy = endY - startY;
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                projEl.style.transform = `rotate(${angle}deg)`;

                elements.gameBoard.appendChild(projEl);
                
                // ‰∏∫Â∞ÑÊâãÁÆ≠Áü¢Ê∑ªÂä†ËΩ®ËøπÊïàÊûú
                if (type === 'archer' && Math.random() < 0.3) {
                    const trail = document.createElement('div');
                    trail.className = 'archer-trail';
                    trail.style.left = `${startX - 7}px`;
                    trail.style.top = `${startY - 7}px`;
                    trail.style.background = isDouble ? 'rgba(255, 215, 0, 0.4)' : 'rgba(46, 204, 113, 0.4)';
                    elements.gameBoard.appendChild(trail);

                    setTimeout(() => {
                        if (trail.parentNode) {
                            trail.parentNode.removeChild(trail);
                        }
                    }, 500);
                }
            }
            
            // ÂàõÂª∫ÊîªÂáªÁâπÊïàÔºàÊàòÂ£´ÂíåÈ™ëÂ£´Ôºâ
            function createAttackEffect(x, y, type, damageType) {
                let effectClass = '';
                if (type === 'warrior') {
                    effectClass = 'warrior-attack';
                } else if (type === 'paladin') {
                    effectClass = 'paladin-attack';
                }

                const effect = {
                    id: Date.now(),
                    x: x,
                    y: y,
                    type: type,
                    damageType: damageType,
                    lifetime: 400
                };

                gameState.attackEffects.push(effect);

                // ÂàõÂª∫ÁâπÊïàÂÖÉÁ¥†
                const effectEl = document.createElement('div');
                effectEl.className = effectClass;
                effectEl.style.left = `${x - 30}px`;
                effectEl.style.top = `${y - 30}px`;
                effectEl.dataset.id = effect.id;
                elements.gameBoard.appendChild(effectEl);
            }

            // Êõ¥Êñ∞ÊäõÂ∞ÑÁâ©
            function updateProjectiles(deltaTime) {
                for (let i = gameState.projectiles.length - 1; i >= 0; i--) {
                    const projectile = gameState.projectiles[i];
                    projectile.progress += projectile.speed * (deltaTime / 16);

                    if (projectile.progress >= 1) {
                        // ÊäõÂ∞ÑÁâ©Âà∞ËææÁõÆÊ†á
                        const projEl = document.querySelector(`.projectile[data-id="${projectile.id}"]`);
                        if (projEl) projEl.remove();
                        gameState.projectiles.splice(i, 1);

                        // Â∫îÁî®‰º§ÂÆ≥
                        gameState.enemyCharacters.forEach(enemy => {
                            if (Math.abs(enemy.x - projectile.endX) < 40 &&
                                Math.abs(enemy.y - projectile.endY) < 40) {

                                const actualDamage = calculateDamage(projectile.damage, projectile.damageType, enemy.type);
                                enemy.health -= actualDamage;

                                // Ê≥ïÂ∏àÂáèÈÄüÊïàÊûú - ‰∏ªÁõÆÊ†á
                                if (projectile.type === 'mage') {
                                    if (enemy.slowTimer) clearTimeout(enemy.slowTimer);
                                    const originalSpeed = enemy.speed;
                                    enemy.speed *= 0.8; // ÂáèÈÄü20%
                                    enemy.slowTimer = setTimeout(() => {
                                        enemy.speed = originalSpeed;
                                        enemy.slowTimer = null;
                                    }, 3000);
                                }

                                // Ê≥ïÂ∏àËåÉÂõ¥‰º§ÂÆ≥
                                if (projectile.type === 'mage') {
                                    // Ê∑ªÂä†ÁàÜÁÇ∏ÊïàÊûú
                                    const explosion = document.createElement('div');
                                    explosion.className = 'mage-explosion';
                                    explosion.style.left = `${projectile.endX - 50}px`;
                                    explosion.style.top = `${projectile.endY - 50}px`;
                                    elements.gameBoard.appendChild(explosion);

                                    setTimeout(() => {
                                        if (explosion.parentNode) {
                                            explosion.parentNode.removeChild(explosion);
                                        }
                                    }, 500);

                                    // ÂØπÈôÑËøëÊïå‰∫∫ÈÄ†Êàê‰º§ÂÆ≥
                                    gameState.enemyCharacters.forEach(nearbyEnemy => {
                                        if (nearbyEnemy.id !== enemy.id) {
                                            const dx = nearbyEnemy.x - projectile.endX;
                                            const dy = nearbyEnemy.y - projectile.endY;
                                            const distance = Math.sqrt(dx * dx + dy * dy);

                                            if (distance < 50) {
                                                const splashDamage = actualDamage * 0.8;
                                                nearbyEnemy.health -= splashDamage;

                                                // Ê≥ïÂ∏àÂáèÈÄüÊïàÊûú - ËåÉÂõ¥‰º§ÂÆ≥
                                                if (nearbyEnemy.slowTimer) clearTimeout(nearbyEnemy.slowTimer);
                                                const originalSpeed = nearbyEnemy.speed;
                                                nearbyEnemy.speed *= 0.8; // ÂáèÈÄü20%
                                                nearbyEnemy.slowTimer = setTimeout(() => {
                                                    nearbyEnemy.speed = originalSpeed;
                                                    nearbyEnemy.slowTimer = null;
                                                }, 3000);

                                                // ÂàõÂª∫‰º§ÂÆ≥ÊïàÊûú
                                                createDamageEffect(nearbyEnemy.x, nearbyEnemy.y, `-${Math.round(splashDamage)}`, '#ff0000');
                                                createHitParticles(nearbyEnemy.x, nearbyEnemy.y, 8, '#ff0000');
                                            }
                                        }
                                    });
                                }

                                // Êõ¥Êñ∞Ë°ÄÊù°
                                const enemyEl = document.querySelector(`.enemy-character[data-id="${enemy.id}"]`);
                                if (enemyEl) {
                                    const healthBar = enemyEl.querySelector('.health-fill-character');
                                    if (healthBar) {
                                        healthBar.style.width = `${(enemy.health / enemy.maxHealth) * 100}%`;
                                    }
                                }

                                // ÂàõÂª∫‰º§ÂÆ≥ÊïàÊûú
                                createDamageEffect(projectile.endX, projectile.endY, `-${Math.round(actualDamage)}`, '#e74c3c');

                                // ÂàõÂª∫ÂëΩ‰∏≠Á≤íÂ≠êÊïàÊûúÔºàÊ†πÊçÆÊîªÂáªÁ±ªÂûã‰∏çÂêåÈ¢úËâ≤Ôºâ
                                let particleColor = '#f1c40f';
                                if (projectile.type === 'mage') particleColor = '#ff0000';
                                if (projectile.type === 'archer') particleColor = projectile.isDouble ? '#ffd700' : '#2ecc71';
                                if (projectile.type === 'blade') particleColor = '#e74c3c';

                                createHitParticles(projectile.endX, projectile.endY, 8, particleColor);
                            }
                        });
                    } else {
                        // Êõ¥Êñ∞ÊäõÂ∞ÑÁâ©‰ΩçÁΩÆ
                        projectile.x = projectile.startX + (projectile.endX - projectile.startX) * projectile.progress;
                        projectile.y = projectile.startY + (projectile.endY - projectile.startY) * projectile.progress;

                        const projEl = document.querySelector(`.projectile[data-id="${projectile.id}"]`);
                        if (projEl) {
                            projEl.style.left = `${projectile.x - 15}px`;
                            projEl.style.top = `${projectile.y - 15}px`;
                        }

                        // Ê∑ªÂä†ÊãñÂ∞æÊïàÊûúÔºàÊ≥ïÂ∏àÁÅ´ÁêÉÔºâ
                        if (projectile.type === 'mage' && Math.random() < 0.5) {
                            const trail = document.createElement('div');
                            trail.className = 'trail';
                            trail.style.left = `${projectile.x - 7}px`;
                            trail.style.top = `${projectile.y - 7}px`;
                            trail.style.background = 'radial-gradient(circle, #ff8800, transparent)';
                            elements.gameBoard.appendChild(trail);

                            setTimeout(() => {
                                if (trail.parentNode) {
                                    trail.parentNode.removeChild(trail);
                                }
                            }, 500);
                        }
                    }
                }
            }
            
            // Êõ¥Êñ∞ÊîªÂáªÁâπÊïà
            function updateAttackEffects(deltaTime) {
                for (let i = gameState.attackEffects.length - 1; i >= 0; i--) {
                    const effect = gameState.attackEffects[i];
                    effect.lifetime -= deltaTime;

                    if (effect.lifetime <= 0) {
                        const effectEl = document.querySelector(`.${effect.type === 'warrior' ? 'warrior-attack' : 'paladin-attack'}[data-id="${effect.id}"]`);
                        if (effectEl) effectEl.remove();
                        gameState.attackEffects.splice(i, 1);

                        // Â∫îÁî®‰º§ÂÆ≥
                        gameState.enemyCharacters.forEach(enemy => {
                            if (Math.abs(enemy.x - effect.x) < 40 &&
                                Math.abs(enemy.y - effect.y) < 40) {

                                const damage = effect.type === 'warrior' ?
                                    gameState.characterStats.warrior.damage :
                                    gameState.characterStats.paladin.damage;

                                const actualDamage = calculateDamage(damage, effect.damageType, enemy.type);
                                enemy.health -= actualDamage;

                                // Êõ¥Êñ∞Ë°ÄÊù°
                                const enemyEl = document.querySelector(`.enemy-character[data-id="${enemy.id}"]`);
                                if (enemyEl) {
                                    const healthBar = enemyEl.querySelector('.health-fill-character');
                                    if (healthBar) {
                                        healthBar.style.width = `${(enemy.health / enemy.maxHealth) * 100}%`;
                                    }
                                }

                                // ÂàõÂª∫‰º§ÂÆ≥ÊïàÊûú
                                createDamageEffect(effect.x, effect.y, `-${Math.round(actualDamage)}`, '#e74c3c');

                                // ÂàõÂª∫ÂëΩ‰∏≠Á≤íÂ≠êÊïàÊûú
                                createHitParticles(effect.x, effect.y, 8, effect.type === 'warrior' ? '#3498db' : '#f1c40f');
                            }
                        });
                    }
                }
            }
            
            // Êõ¥Êñ∞ÊäÄËÉΩÁâπÊïà
            function updateSkillEffects(deltaTime) {
                for (let i = gameState.skillEffects.length - 1; i >= 0; i--) {
                    const effect = gameState.skillEffects[i];
                    effect.lifetime -= deltaTime;

                    if (effect.lifetime <= 0) {
                        const effectEl = document.querySelector(`.skill-effect[data-id="${effect.id}"]`);
                        if (effectEl) effectEl.remove();
                        gameState.skillEffects.splice(i, 1);
                    }
                }
            }

            // ÂàõÂª∫‰º§ÂÆ≥ÊïàÊûú
            function createDamageEffect(x, y, text, color) {
                const effect = {
                    id: Date.now(),
                    x: x,
                    y: y,
                    text: text,
                    color: color,
                    lifetime: 1200
                };

                gameState.damageEffects.push(effect);

                // ÂàõÂª∫ÊïàÊûúÂÖÉÁ¥†
                const effectEl = document.createElement('div');
                effectEl.className = 'damage-effect';
                effectEl.textContent = text;
                effectEl.style.color = color;
                effectEl.style.left = `${x}px`;
                effectEl.style.top = `${y}px`;
                effectEl.dataset.id = effect.id;
                elements.gameBoard.appendChild(effectEl);
            }

            // Êõ¥Êñ∞‰º§ÂÆ≥ÊïàÊûú
            function updateDamageEffects(deltaTime) {
                for (let i = gameState.damageEffects.length - 1; i >= 0; i--) {
                    const effect = gameState.damageEffects[i];
                    effect.lifetime -= deltaTime;

                    if (effect.lifetime <= 0) {
                        const effectEl = document.querySelector(`.damage-effect[data-id="${effect.id}"]`);
                        if (effectEl) effectEl.remove();
                        gameState.damageEffects.splice(i, 1);
                    }
                }
            }

            // ÂàõÂª∫Ê≤ªÁñóÊïàÊûú
            function createHealEffect(x, y, text) {
                const effect = {
                    id: Date.now(),
                    x: x,
                    y: y,
                    text: text,
                    lifetime: 1800
                };

                gameState.healEffects.push(effect);

                // ÂàõÂª∫ÊïàÊûúÂÖÉÁ¥†
                const effectEl = document.createElement('div');
                effectEl.className = 'heal-effect';
                effectEl.textContent = text;
                effectEl.style.left = `${x}px`;
                effectEl.style.top = `${y}px`;
                effectEl.dataset.id = effect.id;
                elements.gameBoard.appendChild(effectEl);
            }

            // Êõ¥Êñ∞Ê≤ªÁñóÊïàÊûú
            function updateHealEffects(deltaTime) {
                for (let i = gameState.healEffects.length - 1; i >= 0; i--) {
                    const effect = gameState.healEffects[i];
                    effect.lifetime -= deltaTime;

                    if (effect.lifetime <= 0) {
                        const effectEl = document.querySelector(`.heal-effect[data-id="${effect.id}"]`);
                        if (effectEl) effectEl.remove();
                        gameState.healEffects.splice(i, 1);
                    }
                }
            }
            
            // ÂàõÂª∫Ë°®ÊÉÖÊïàÊûúÔºàÂ∏¶ËæπÊ°ÜÔºâ
            function createEmotion(x, y, type) {
                let icon = '';
                let className = '';
                
                switch(type) {
                    case 'happy':
                        icon = 'fa-smile';
                        className = 'emotion-happy';
                        break;
                    case 'angry':
                        icon = 'fa-angry';
                        className = 'emotion-angry';
                        break;
                    case 'sad':
                        icon = 'fa-sad-cry';
                        className = 'emotion-sad';
                        break;
                    case 'proud':
                        icon = 'fa-crown';
                        className = 'emotion-proud';
                        break;
                    case 'scared':
                        icon = 'fa-surprise';
                        className = 'emotion-scared';
                        break;
                    case 'excited':
                        icon = 'fa-star';
                        className = 'emotion-excited';
                        break;
                    case 'confident':
                        icon = 'fa-check-circle';
                        className = 'emotion-confident';
                        break;
                    case 'amazed':
                        icon = 'fa-star';
                        className = 'emotion-amazed';
                        break;
                    case 'determined':
                        icon = 'fa-fist-raised';
                        className = 'emotion-determined';
                        break;
                    case 'annoyed':
                        icon = 'fa-frown';
                        className = 'emotion-annoyed';
                        break;
                    case 'surprised':
                        icon = 'fa-surprise';
                        className = 'emotion-surprised';
                        break;
                    case 'tired':
                        icon = 'fa-tired';
                        className = 'emotion-tired';
                        break;
                    case 'victory':
                        icon = 'fa-trophy';
                        className = 'emotion-victory';
                        break;
                    case 'defeat':
                        icon = 'fa-skull';
                        className = 'emotion-defeat';
                        break;
                    case 'alert':
                        icon = 'fa-exclamation';
                        className = 'emotion-alert';
                        break;
                }
                
                const emotionEl = document.createElement('div');
                emotionEl.className = `character-emotion ${className}`;
                emotionEl.innerHTML = `<i class="fas ${icon}"></i>`;
                emotionEl.style.left = `${x}px`;
                emotionEl.style.top = `${y}px`;
                elements.gameBoard.appendChild(emotionEl);
                
                // Ëá™Âä®ÁßªÈô§
                setTimeout(() => {
                    if (emotionEl.parentNode) {
                        emotionEl.parentNode.removeChild(emotionEl);
                    }
                }, 2000);
            }
            
            // ÂàõÂª∫ËÉúÂà©ÁâπÊïà
            function createVictoryEffect() {
                elements.victoryEffect.style.display = 'block';
                
                // ÂàõÂª∫ÂΩ©Ëâ≤Á∫∏Â±ë
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.animationDelay = `${Math.random() * 2}s`;
                    
                    // ÈöèÊú∫È¢úËâ≤
                    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    
                    elements.victoryEffect.appendChild(confetti);
                    
                    // Ëá™Âä®ÁßªÈô§
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 3000);
                }
                
                // 3ÁßíÂêéÈöêËóèÁâπÊïà
                setTimeout(() => {
                    elements.victoryEffect.style.display = 'none';
                }, 3000);
            }

            // Ê£ÄÊü•Ê∏∏ÊàèÁä∂ÊÄÅ
            function checkGameState() {
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÁîüÊàêÊñ∞Ê≥¢Ê¨°
                if (Date.now() > gameState.nextWaveTimer && gameState.enemyCharacters.length === 0 && !gameState.gameOver) {
                    spawnEnemyWave();
                }
            
                if (gameState.playerHealth <= 0) {
                    gameState.gameOver = true;
                    if (gameState.endlessMode) {
                        saveToLeaderboard();
                        let content = `ÂùöÊåÅ‰∫Ü: ${Math.floor(gameState.gameTime / 60)}ÂàÜ${Math.floor(gameState.gameTime % 60)}Áßí\nÂáªÊùÄ: ${gameState.killCount}‰∏™Êïå‰∫∫`;
                        if (gameState.currentRunFragments.length > 0) {
                            content += `\nËé∑ÂæóÁ¢éÁâá: ${gameState.currentRunFragments.length}‰∏™`;
                        }
                        showGameMessage('Ê∏∏ÊàèÁªìÊùü!', content);
                    } else {
                        showGameMessage('Â§±Ë¥•!', 'Âü∫Âú∞Ë¢´ÊëßÊØÅ‰∫Ü...');
                    }
                    return;
                }
                
                // Êó∂Èó¥ËÉúÂà©Êù°‰ª∂Ôºà3ÂàÜÈíüÔºâ
                if (!gameState.endlessMode && gameState.gameTime >= gameState.victoryTime) {
                    gameState.gameOver = true;
                    gameState.gold += 100;
                    saveGameData();
                    
                    // ÊòæÁ§∫ËÉúÂà©Ë°®ÊÉÖ
                    gameState.playerCharacters.forEach(char => {
                        createEmotion(char.x, char.y, 'victory');
                    });
                    createEmotion(210, 560, 'victory');
                    
                    // ÂàõÂª∫ËÉúÂà©ÁâπÊïà
                    createVictoryEffect();
                    
                    // Âª∂Ëøü2ÁßíÊòæÁ§∫ÂçáÁ∫ßÁïåÈù¢
                    setTimeout(() => {
                        elements.levelUpContainer.style.display = 'flex';
                        elements.gameMessage.style.display = 'none';
                    }, 2000);
                }
            }

            // ÊòæÁ§∫Ê∏∏ÊàèÊ∂àÊÅØ
            function showGameMessage(title, content) {
                elements.messageTitle.textContent = title;
                elements.messageContent.textContent = content;
                elements.gameMessage.style.display = 'block';
            }

            // ÈáçÁΩÆÊ∏∏Êàè
            function resetGame() {
                gameState.playerHealth = 100;
                gameState.enemyHealth = 100;
                gameState.elixir = 10;
                gameState.playerCharacters = [];
                gameState.enemyCharacters = [];
                gameState.projectiles = [];
                gameState.damageEffects = [];
                gameState.healEffects = [];
                gameState.attackEffects = [];
                gameState.skillEffects = [];
                gameState.gameOver = false;
                gameState.enemyWaveCount = 0;
                gameState.waveCount = 0;
                gameState.gameTime = 0;
                gameState.paused = false;
                gameState.killCount = 0;
                gameState.nextWaveTimer = 0;
                // ËÆæÁΩÆÊó†Â∞ΩÊ®°ÂºèÊ†áÂøóÂíåËÉúÂà©Êó∂Èó¥
                gameState.endlessMode = gameState.currentLevel === 'endless';
                gameState.victoryTime = gameState.endlessMode ? Infinity : 180; // ÊôÆÈÄöÂÖ≥Âç°ËÉúÂà©Êó∂Èó¥‰∏∫3ÂàÜÈíü(180Áßí)

                // Ê∏ÖÈô§Ê∏∏ÊàèÊùø
                document.querySelectorAll('.character, .projectile, .damage-effect, .heal-effect, .warrior-attack, .paladin-attack, .hit-particle').forEach(el => el.remove());
                
                // ÂèñÊ∂àÂç°ÁâåÈÄâÊã©
                elements.cards.forEach(card => card.classList.remove('selected'));
                gameState.selectedCard = null;
                
                // ÈöêËóèÂè¨ÂõûÊåâÈíÆ
                elements.recallButton.style.display = 'none';
                gameState.selectedCharacter = null;
                
                // ÈöêËóèÂçáÁ∫ßÁïåÈù¢
                elements.levelUpContainer.style.display = 'none';
                elements.nextLevelContainer.style.display = 'none';
                
                // ÊÅ¢Â§çÊöÇÂÅúÊåâÈíÆÁä∂ÊÄÅ
                const icon = elements.pauseButton.querySelector('i');
                icon.className = 'fas fa-pause';
                
                updateUI();
                
                // ÁîüÊàêÁ¨¨‰∏ÄÊ≥¢Êïå‰∫∫ÔºàÁ´ãÂç≥ÁîüÊàêÔºâ
                spawnEnemyWave();
            }

            // ËæÖÂä©ÂáΩÊï∞
            function getCharacterIcon(type) {
                switch (type) {
                    case 'warrior': return 'shield-alt';
                    case 'archer': return 'bullseye';
                    case 'mage': return 'hat-wizard';
                    case 'blade': return 'user-ninja';
                    case 'paladin': return 'hands-praying';
                    default: return 'user';
                }
            }

            function getEnemyIcon(type) {
                switch (type) {
                    case 'normal': return 'skull';
                    case 'elite': return 'skull-crossbones';
                    case 'boss': return 'dragon';
                    case 'tank': return 'shield-alt';
                    case 'speedy': return 'bolt';
                    case 'flyer': return 'dove';
                    case 'magic-immune': return 'hat-wizard';
                    case 'physical-immune': return 'shield-alt';
                    default: return 'ghost';
                }
            }

            // ÂêØÂä®Ê∏∏Êàè
            createParticles();
            initGame();
        });
    </script>
</body>
</html>