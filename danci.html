<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂçïËØçÂÆàÊä§ËÄÖ - ÂÑøÁ´•Ëã±ËØ≠Â≠¶‰π†Ê∏∏Êàè</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- ÂºïÂÖ•SheetJSÂ∫ìÁî®‰∫éËß£ÊûêXLSXÊñá‰ª∂ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Marker Felt', 'Chalkboard SE', sans-serif;
            touch-action: manipulation;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            color: white;
            overflow-x: hidden;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
            max-width: 95%;
        }

        .header h1 {
            font-size: 2.8rem;
            text-shadow: 3px 3px 0 #ff6b6b, 6px 6px 0 #4ecdc4;
            letter-spacing: 1px;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #ffd166, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 8s linear infinite;
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .header p {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 50px;
            border: 2px solid #ffd166;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 900px;
            background: rgba(25, 42, 86, 0.85);
            border-radius: 20px;
            padding: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 5px solid #ffd166;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }

        /* È°∂ÈÉ®Âå∫Âüü - ÂõõÂÖÉÁ¥†Ê∞¥Âπ≥ÊéíÂàó */
        .top-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            width: 100%;
        }

        .top-section-item {
            flex: 1;
            min-width: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 12px;
            border: 2px solid #ffd166;
        }

        .top-section-title {
            font-size: 1.1rem;
            color: #ffd166;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        .monster-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            width: 100%;
        }

        .monster-canvas {
            width: 140px;
            height: 140px;
            position: relative;
            z-index: 5;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5));
            animation: floatMonster 4s ease-in-out infinite;
        }

        @keyframes floatMonster {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .monster-health {
            position: absolute;
            top: 8px;
            left: 10%;
            width: 80%;
            background: rgba(0, 0, 0, 0.5);
            height: 18px;
            border-radius: 10px;
            border: 2px solid #ff6b6b;
            display: flex;
            overflow: hidden;
            z-index: 6; /* ÊèêÈ´òÂ±ÇÁ∫ßÁ°Æ‰øùÂú®ÊÄ™ÂÖΩ‰∏äÊñπ */
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .health-segment {
            flex: 1;
            height: 100%;
            background: #4ecdc4;
            border-right: 1px solid rgba(0, 0, 0, 0.3);
            transition: background-color 0.5s ease;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }

        .health-segment:last-child {
            border-right: none;
        }

        .health-segment.lost {
            background: #ff6b6b;
        }

        .word-image-container {
            display: flex;
            justify-content: center;
            height: 160px;
            margin: 8px 0;
        }

        .word-image {
            width: 160px;
            height: 160px;
            background: white;
            border-radius: 15px;
            border: 4px solid #ffd166;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            background: rgba(255,255,255,0.9);
            transition: transform 0.3s ease;
            position: relative;
        }

        .word-image:hover {
            transform: scale(1.05);
        }

        .word-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .image-fallback {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            width: 100%;
            height: 100%;
        }
        
        .image-fallback i {
            font-size: 3rem;
            color: #4ecdc4;
            margin-bottom: 10px;
        }
        
        .image-fallback span {
            font-size: 1.4rem;
            font-weight: bold;
            color: #1a2a6c;
        }

        .word-shield {
            height: 90px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 8px 0;
            border: 3px dashed #ffd166;
            font-size: 2.8rem;
            font-weight: bold;
            letter-spacing: 8px;
            color: white;
            text-shadow: 0 0 10px #4ecdc4;
            transition: all 0.5s ease;
            padding: 0 15px;
            text-align: center;
            box-shadow: inset 0 0 20px rgba(78, 205, 196, 0.5), 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 280px;
            position: relative;
        }

        .letter-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
            min-height: 90px;
            position: relative;
            width: 100%;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 10px;
            border: 2px dashed #ffd166;
        }

        .letter {
            width: 55px;
            height: 55px;
            background: linear-gradient(145deg, #ffd166, #ffb700);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2rem;
            font-weight: bold;
            color: #1a2a6c;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            user-select: none;
            border: 3px solid #ff6b6b;
            position: absolute;
            will-change: transform;
        }

        .letter:hover, .letter:active {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .letter.selected {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            z-index: 100;
            border: 3px solid #4ecdc4;
        }

        .target-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            min-height: 65px;
            width: 100%;
        }

        .target {
            width: 55px;
            height: 55px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 2px dashed #4ecdc4;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            will-change: transform;
            cursor: pointer;
        }

        .target.filled {
            border: 2px solid #ffd700;
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            transform: scale(1.05);
        }

        .target.correct {
            border: 2px solid #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.7);
        }

        .target.incorrect {
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
            animation: shake 0.3s ease-in-out;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.7);
        }

        .player-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            min-width: 70px;
            margin: 5px;
        }

        .stat-value {
            font-size: 1.7rem;
            font-weight: bold;
            color: #ffd166;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .heart {
            color: #ff6b6b;
            margin: 0 2px;
            font-size: 1.7rem;
            text-shadow: 0 0 5px rgba(255, 107, 107, 0.8);
        }

        .stat-label {
            font-size: 0.95rem;
            color: #4ecdc4;
            text-shadow: 0 0 5px rgba(78, 205, 196, 0.5);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 13px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            background: linear-gradient(to right, #ff6b6b, #ffd166);
            color: #1a2a6c;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            min-width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #ffd166, #ff6b6b);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        button:hover::before {
            opacity: 1;
        }

        button:active {
            transform: translateY(1px);
        }

        button#fireBtn.active {
            background: linear-gradient(to right, #4ecdc4, #1a9e94);
            box-shadow: 0 0 15px #4ecdc4;
            color: white;
        }

        .laser {
            position: absolute;
            height: 5px;
            background: linear-gradient(to right, rgba(255, 255, 255, 0), #ff6b6b, rgba(255, 255, 255, 0));
            box-shadow: 0 0 10px #ff6b6b;
            top: 170px;
            z-index: 10;
        }

        .monster-laser {
            position: absolute;
            height: 8px;
            background: linear-gradient(to right, rgba(255, 255, 255, 0), #4ecdc4, rgba(255, 255, 255, 0));
            box-shadow: 0 0 15px #4ecdc4;
            z-index: 10;
            transform-origin: left center;
            border-radius: 4px;
        }

        .strong-laser {
            background: linear-gradient(to right, rgba(255, 255, 255, 0), #ff0000, rgba(255, 255, 255, 0));
            box-shadow: 0 0 20px #ff0000;
            height: 15px;
        }

        .super-strong-laser {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), #ff0000, rgba(255, 255, 255, 0));
            box-shadow: 0 0 30px #ff0000;
            height: 100%;
            width: 25px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        @keyframes shake-container {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-5px, -5px); }
            20% { transform: translate(5px, 5px); }
            30% { transform: translate(-7px, 0); }
            40% { transform: translate(7px, 0); }
            50% { transform: translate(-5px, 5px); }
            60% { transform: translate(5px, -5px); }
            70% { transform: translate(-7px, -7px); }
            80% { transform: translate(7px, 7px); }
            90% { transform: translate(-5px, 0); }
            100% { transform: translate(0, 0); }
        }

        .shake {
            animation: shake 5s ease-in-out;
        }

        .shake-container {
            animation: shake-container 0.5s ease;
        }

        .floating {
            animation: floating 6s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        .damage {
            position: absolute;
            color: #ff6b6b;
            font-weight: bold;
            font-size: 1.4rem;
            animation: damage-fly 1.5s forwards;
            z-index: 20;
            pointer-events: none;
            text-shadow: 0 0 5px white;
        }

        @keyframes damage-fly {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        .level-up {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            z-index: 100;
            display: none;
            width: 90%;
            max-width: 400px;
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .level-up h2 {
            color: #ff6b6b;
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        .level-up p {
            color: #1a2a6c;
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99;
            display: none;
        }

        .scatter {
            animation: scatter 0.8s forwards cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        @keyframes scatter {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }
            100% {
                transform: translate(var(--tx), var(--ty)) rotate(var(--rot));
            }
        }

        .bounce {
            animation: bounce 0.8s forwards;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .attack-letter {
            position: absolute;
            z-index: 15;
            animation: fly-to-monster 0.8s forwards;
        }

        @keyframes fly-to-monster {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }

        .monster-attack {
            animation: monster-attack 1s forwards;
        }

        @keyframes monster-attack {
            0%, 100% { transform: translateY(0); }
            30% { transform: translateY(-20px); }
            50% { transform: translateY(0) scale(1.1); }
        }

        .defeated {
            animation: defeatedAnimation 1.5s forwards;
        }

        @keyframes defeatedAnimation {
            0% {
                transform: translateY(0) rotate(0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translateY(-30px) rotate(-180deg) scale(0.7);
                opacity: 0.7;
            }
            100% {
                transform: translateY(100px) rotate(-360deg) scale(0.1);
                opacity: 0;
            }
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ffd166;
            pointer-events: none;
            z-index: 20;
            animation: particleAnim 1.5s forwards;
            box-shadow: 0 0 5px #ffd166;
        }

        @keyframes particleAnim {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--p-tx), var(--p-ty));
                opacity: 0;
            }
        }

        .mobile-drag-hint {
            position: absolute;
            bottom: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            color: #ffd166;
            opacity: 0.8;
        }

        /* ÂØπÊàòÁßòÁ±çÂºπÁ™óÊ†∑Âºè */
        .word-info-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #1a2a6c, #4ecdc4);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            z-index: 101;
            display: none;
            width: 90%;
            max-width: 500px;
            color: white;
            text-align: center;
            border: 3px solid #ffd166;
            animation: popIn 0.5s ease;
        }

        .word-info-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ffd166;
        }

        .word-info-header h2 {
            font-size: 2.5rem;
            color: #ffd166;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .word-info-content {
            margin-bottom: 25px;
            text-align: left;
        }

        .word-info-row {
            display: flex;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .word-info-label {
            font-weight: bold;
            color: #ffd166;
            min-width: 80px;
        }

        .word-info-value {
            flex: 1;
        }

        .word-info-examples {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ffd166;
        }

        .word-info-example {
            margin-bottom: 10px;
            font-style: italic;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: left;
        }

        .word-info-translation {
            color: #ffd166;
            font-size: 0.9rem;
            margin-top: 5px;
            padding-left: 15px;
            border-left: 2px solid #ffd166;
        }

        .word-info-close {
            background: linear-gradient(to right, #ff6b6b, #ffd166);
            color: #1a2a6c;
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .word-info-close:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* Á∫ßÂà´ÈÄâÊã© */
        .level-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            padding: 10px;
            border-radius: 15px;
        }

        .level-btn {
            padding: 8px 12px;
            background: linear-gradient(to bottom, #4ecdc4, #1a9e94);
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .level-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .level-btn.active {
            background: linear-gradient(to bottom, #ffd166, #ffb700);
            color: #1a2a6c;
            box-shadow: 0 0 10px #ffd166;
        }

        /* ÊåëÊàòËøõÂ∫¶ */
        .challenge-progress {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            border-radius: 15px;
        }

        .progress-item {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .progress-item.active {
            background: linear-gradient(to bottom, #ffd166, #ffb700);
            color: #1a2a6c;
            transform: scale(1.2);
        }

        .progress-item.completed {
            background: linear-gradient(to bottom, #4ecdc4, #1a9e94);
            color: white;
        }

        .progress-item.failed {
            background: linear-gradient(to bottom, #ff6b6b, #d84a4a);
            color: white;
        }

        /* Â•ñÂä±ÂºπÁ™ó */
        .reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #ffd166, #ff6b6b);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            z-index: 101;
            display: none;
            width: 90%;
            max-width: 500px;
            color: #1a2a6c;
            text-align: center;
            border: 3px solid #ffd166;
            animation: popIn 0.5s ease;
        }

        .reward-content {
            margin: 20px 0;
        }

        .reward-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #1a2a6c;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .reward-title {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .reward-details {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .reward-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .reward-stat {
            background: rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
            min-width: 100px;
        }

        .reward-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .reward-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .gold-badge {
            position: relative;
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(45deg, #ffd700, #ffb700);
            color: #1a2a6c;
            border-radius: 20px;
            font-weight: bold;
            margin: 0 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .gold-badge::before {
            content: 'üí∞';
            margin-right: 5px;
        }

        .hit-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: 30;
        }

        .hit-animation {
            animation: hitEffect 0.6s ease-out;
        }

        @keyframes hitEffect {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* ‰∏ä‰º†Âå∫Âüü */
        .upload-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            width: 100%;
            text-align: center;
            border: 2px dashed #ffd166;
        }

        .upload-btn {
            background: linear-gradient(to right, #4CAF50, #2E7D32);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .file-input {
            display: none;
        }

        .upload-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #ffd166;
        }

        .current-wordset {
            margin-top: 15px;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
        }

        /* ÊàêÂ∞±ÂæΩÁ´† */
        .achievements {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        
        .badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background: linear-gradient(145deg, #ffd166, #ffb700);
            color: #1a2a6c;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .badge.locked {
            background: linear-gradient(145deg, #607d8b, #455a64);
            color: rgba(255,255,255,0.5);
        }
        
        .badge-info {
            position: absolute;
            bottom: -25px;
            font-size: 0.7rem;
            white-space: nowrap;
            background: rgba(0,0,0,0.7);
            padding: 2px 5px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .badge:hover .badge-info {
            opacity: 1;
        }

        /* ÁßªÂä®ËÆæÂ§á‰ºòÂåñ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
                text-shadow: 2px 2px 0 #ff6b6b, 4px 4px 0 #4ecdc4;
            }

            .word-shield {
                font-size: 2rem;
                letter-spacing: 5px;
                height: 80px;
            }

            .letter {
                width: 45px;
                height: 45px;
                font-size: 1.8rem;
            }

            .target {
                width: 45px;
                height: 45px;
                font-size: 1.8rem;
            }

            .stat-value {
                font-size: 1.4rem;
            }

            .word-image {
                width: 140px;
                height: 140px;
            }

            .monster-canvas {
                width: 140px;
                height: 140px;
            }

            button {
                padding: 12px 20px;
                font-size: 1rem;
                min-width: 130px;
            }

            .word-info-popup {
                padding: 20px;
            }

            .word-info-header h2 {
                font-size: 2rem;
            }
            
            .controls {
                gap: 12px;
            }
            
            .letter, .target {
                width: 48px;
                height: 48px;
            }
            
            .top-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .top-section-item {
                min-width: 100%;
            }
            
            .level-selector {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .challenge-progress {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .word-shield {
                font-size: 1.6rem;
                height: 70px;
                letter-spacing: 3px;
                padding: 0 10px;
            }

            .letter {
                width: 40px;
                height: 40px;
                font-size: 1.6rem;
            }

            .target {
                width: 40px;
                height: 40px;
                font-size: 1.6rem;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .word-image {
                width: 120px;
                height: 120px;
            }

            .monster-canvas {
                width: 120px;
                height: 120px;
            }

            button {
                padding: 10px 15px;
                font-size: 0.95rem;
                min-width: 110px;
                gap: 5px;
            }

            .controls {
                gap: 10px;
            }

            .word-info-popup {
                padding: 15px;
            }

            .word-info-header h2 {
                font-size: 1.6rem;
            }

            .word-info-row {
                flex-direction: column;
            }

            .word-info-label {
                margin-bottom: 5px;
            }
            
            .game-container {
                padding: 12px;
            }
            
            .letter, .target {
                width: 44px;
                height: 44px;
            }
            
            button {
                min-width: 140px;
                padding: 12px 18px;
            }
            
            .player-stats {
                padding: 10px;
            }
            
            .stat-item {
                min-width: 65px;
                margin: 3px;
            }
            
            .mobile-drag-hint {
                font-size: 1rem;
                bottom: -22px;
            }
        }
        
        /* ÊåâÈíÆÊ†∑Âºè‰ºòÂåñ */
        #startBtn {
            background: linear-gradient(to right, #4CAF50, #2E7D32) !important;
        }
        
        #fireBtn {
            background: linear-gradient(to right, #f44336, #c62828) !important;
        }
        
        #hintBtn {
            background: linear-gradient(to right, #2196F3, #1565C0) !important;
        }
        
        #soundBtn {
            background: linear-gradient(to right, #9C27B0, #6A1B9A) !important;
        }
        
        #exitBtn {
            background: linear-gradient(to right, #607D8B, #455A64) !important;
        }
        
        #uploadTrigger {
            background: linear-gradient(to right, #FF9800, #EF6C00) !important;
        }
        
        .level-btn {
            background: linear-gradient(to bottom, #4ecdc4, #1a9e94) !important;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
        }
        
        button {
            padding: 13px 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            min-width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            z-index: 1;
            flex: 1 1 auto;
            max-width: 200px;
            text-align: center;
        }
        
        .level-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            width: 100%;
        }
        
        .level-btn {
            padding: 10px 15px;
            font-size: 0.9rem;
            min-width: 80px;
        }
        
        .upload-container {
            margin-top: 20px;
            text-align: center;
        }
        
        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .controls {
                gap: 10px;
            }
            
            button {
                padding: 12px 15px;
                font-size: 1rem;
                min-width: 120px;
            }
            
            .level-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                min-width: 70px;
            }
        }
        
        @media (max-width: 480px) {
            button {
                padding: 12px 15px;
                font-size: 0.95rem;
                min-width: 140px;
            }
            
            .level-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
                min-width: 65px;
            }
            
            .letter:active {
                transform: scale(1.15);
                transition: transform 0.1s ease;
                z-index: 100;
            }
            
            .target.filled {
                transform: scale(1.1);
            }
        }
        
        /* ÁßªÂä®ËÆæÂ§áËß¶Êë∏ÂèçÈ¶à‰ºòÂåñ */
        .letter.touch-active {
            transform: scale(1.2) !important;
            z-index: 100;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        /* ‰ºòÂåñÂ∏ÉÂ±Ä */
        .monster-label {
            position: absolute;
            bottom: -20px;
            font-size: 1.2rem;
            color: #ffd166;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
        }
        
        .stat-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        
        /* ‰øÆÂ§çÂ∞èÊÄ™ÂÖΩÈÅÆÊå°Ë°ÄÊù°ÈóÆÈ¢ò */
        .monster-area {
            position: relative;
        }
        
        /* Êñ∞Ê∑ªÂä†ÁöÑÊàêÂ∞±Âå∫ */
        .achievement-area {
            margin-top: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #ffd166;
        }
        
        .achievement-title {
            text-align: center;
            color: #ffd166;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        
        /* ‰∏ä‰º†Áä∂ÊÄÅÊåáÁ§∫Âô® */
        .upload-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            display: none;
        }
        
        .upload-status.success {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            display: block;
        }
        
        .upload-status.error {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ÂçïËØçÂÆàÊä§ËÄÖ</h1>
        <p>‰øùÊä§ÂçïËØçÊä§ÁõæÔºåÊãºÂá∫Ê≠£Á°ÆÂçïËØçÔºåÂáªË¥•ÊÄ™ÂÖΩËé∑ÂèñÁªèÈ™åÂÄºÂíåÈáëÂ∏ÅÔºÅ</p>
    </div>
    
    <div class="game-container">
        <!-- È°∂ÈÉ®Âå∫Âüü - ÂõõÂÖÉÁ¥†Ê∞¥Âπ≥ÊéíÂàó -->
        <div class="top-section">
            <!-- ÊåëÊàòËøõÂ∫¶ -->
            <div class="top-section-item">
                <div class="top-section-title">ÊåëÊàòËøõÂ∫¶</div>
                <div class="challenge-progress" id="challengeProgress">
                    <!-- ÊåëÊàòËøõÂ∫¶ÁÇπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            
            <!-- ÂçïËØçÊÄ™ÂÖΩ -->
            <div class="top-section-item">
                <div class="top-section-title">ÂçïËØçÊÄ™ÂÖΩ</div>
                <div class="monster-area">
                    <div class="monster-health" id="monsterHealthBar"></div>
                    <canvas class="monster-canvas" id="monsterCanvas"></canvas>
                    <div class="monster-label" id="monsterName">Â∞èÊÄ™ÂÖΩ</div>
                </div>
            </div>
            
            <!-- Á∫ßÂà´ÈÄâÊã©Âô® -->
            <div class="top-section-item">
                <div class="top-section-title">ÈÄâÊã©Á∫ßÂà´</div>
                <div class="level-selector" id="levelSelector">
                    <button class="level-btn" data-level="1">Á∫ßÂà´ 1</button>
                    <button class="level-btn" data-level="2">Á∫ßÂà´ 2</button>
                    <button class="level-btn" data-level="3">Á∫ßÂà´ 3</button>
                    <button class="level-btn" data-level="4">Á∫ßÂà´ 4</button>
                    <button class="level-btn" data-level="5">Á∫ßÂà´ 5</button>
                    <button class="level-btn active" data-level="mix">Â§ßÊ∑∑Êàò</button>
                </div>
            </div>
            
            <!-- Áä∂ÊÄÅÊ†è -->
            <div class="top-section-item">
                <div class="top-section-title">Áé©ÂÆ∂Áä∂ÊÄÅ</div>
                <div class="stat-container">
                    <div class="stat-item">
                        <div class="stat-value" id="level">1</div>
                        <div class="stat-label">Á≠âÁ∫ß</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="exp">0</div>
                        <div class="stat-label">ÁªèÈ™åÂÄº</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="monstersDefeated">0</div>
                        <div class="stat-label">ÂáªË¥•ÊÄ™ÂÖΩ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                        <div class="stat-label">ÁîüÂëΩÂÄº</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value"><span class="gold-badge" id="gold">0</span></div>
                        <div class="stat-label">ÈáëÂ∏Å</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="word-shield" id="wordShield">SHIELD</div>
        
        <div class="word-image-container">
            <div class="word-image">
                <img id="wordImage" src="" alt="ÂçïËØçÂõæÁâá" onerror="handleImageError(this)">
            </div>
        </div>
        
        <div class="game-area">
            <div class="target-container" id="targetContainer">
                <!-- ÁõÆÊ†á‰ΩçÁΩÆÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                <div class="mobile-drag-hint">ÁÇπÂáªÂ≠óÊØçÁÑ∂ÂêéÁÇπÂáªÊ≠§Â§ÑÊîæÁΩÆ</div>
            </div>
            
            <div class="letter-container" id="letterContainer">
                <!-- Â≠óÊØçÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn"><i class="fas fa-play"></i> ÂºÄÂßãÊåëÊàò</button>
            <button id="fireBtn"><i class="fas fa-bolt"></i> ÂèëÂ∞ÑÊîªÂáª</button>
            <button id="hintBtn"><i class="fas fa-book"></i> ÂØπÊàòÁßòÁ±ç</button>
            <button id="soundBtn"><i class="fas fa-volume-up"></i> ÂçïËØçÂèëÈü≥</button>
            <button id="exitBtn"><i class="fas fa-sign-out-alt"></i> ÈÄÄÂá∫ÊåëÊàò</button>
            <input type="file" id="wordFileInput" class="file-input" accept=".xlsx">
        </div>
        
        <div class="upload-container">
            <div class="current-wordset" id="currentWordsetInfo">ÂΩìÂâçÂçïËØçÈõÜ: ÈªòËÆ§ÂçïËØçÈõÜ (10‰∏™ÂçïËØç)</div>
            <div class="upload-btn" id="uploadTrigger">
                <i class="fas fa-cloud-upload-alt"></i> ÈÄâÊã©ÂçïËØçXLSXÊñá‰ª∂
            </div>
            <div class="upload-info">‰∏ä‰º†Ëá™ÂÆö‰πâÂçïËØçXLSXÊñá‰ª∂Êâ©Â±ïÊÇ®ÁöÑËØçÊ±áÂ∫ì</div>
            <div class="upload-status" id="uploadStatus"></div>
        </div>
        
        <!-- ÊàêÂ∞±Âå∫Âüü -->
        <div class="achievement-area">
            <div class="achievement-title">ÊàêÂ∞±ÂæΩÁ´†</div>
            <div class="achievements" id="achievementsContainer">
                <div class="badge">
                    <i class="fas fa-star"></i>
                    <div class="badge-info">ÂçïËØçÂ§ßÂ∏à</div>
                </div>
                <div class="badge locked">
                    <i class="fas fa-trophy"></i>
                    <div class="badge-info">ÊÄ™ÂÖΩÂÖãÊòü</div>
                </div>
                <div class="badge locked">
                    <i class="fas fa-medal"></i>
                    <div class="badge-info">ÊãºÂÜôÁéãËÄÖ</div>
                </div>
                <div class="badge locked">
                    <i class="fas fa-crown"></i>
                    <div class="badge-info">ÂÆàÊä§‰πãÁ•û</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div class="level-up" id="levelUpPopup">
        <h2>ÂçáÁ∫ßÂï¶ÔºÅ</h2>
        <p>ÊÅ≠Âñú‰Ω†ÂçáÂà∞‰∫Ü <span id="newLevel">2</span> Á∫ßÔºÅ</p>
        <p>Ëß£ÈîÅ‰∫ÜÊñ∞ËÉΩÂäõÂíåÊõ¥Âº∫Â§ßÁöÑÂçïËØçÔºÅ</p>
        <button id="continueBtn"><i class="fas fa-arrow-right"></i> ÁªßÁª≠ÊåëÊàò</button>
    </div>
    
    <!-- ÂØπÊàòÁßòÁ±çÂºπÁ™ó -->
    <div class="word-info-popup" id="wordInfoPopup">
        <div class="word-info-header">
            <h2 id="wordTitle">ÂçïËØçÁßòÁ±ç</h2>
        </div>
        <div class="word-info-content">
            <div class="word-info-row">
                <span class="word-info-label">ÂçïËØçÔºö</span>
                <span class="word-info-value" id="wordInfoWord">-</span>
            </div>
            <div class="word-info-row">
                <span class="word-info-label">Èü≥Ê†áÔºö</span>
                <span class="word-info-value" id="wordInfoPhonetic">-</span>
            </div>
            <div class="word-info-row">
                <span class="word-info-label">ÁøªËØëÔºö</span>
                <span class="word-info-value" id="wordInfoTranslation">-</span>
            </div>
            <div class="word-info-examples">
                <h3>ÂÆûÁî®‰æãÂè•Ôºö</h3>
                <div class="word-info-example" id="wordInfoExample1">-</div>
                <div class="word-info-translation" id="wordInfoExample1Trans">-</div>
                
                <div class="word-info-example" id="wordInfoExample2">-</div>
                <div class="word-info-translation" id="wordInfoExample2Trans">-</div>
            </div>
        </div>
        <button class="word-info-close" id="closeWordInfoBtn"><i class="fas fa-times"></i> ÂÖ≥Èó≠ÁßòÁ±ç</button>
    </div>
    
    <!-- Â•ñÂä±ÂºπÁ™ó -->
    <div class="reward-popup" id="rewardPopup">
        <div class="reward-icon">üèÜ</div>
        <div class="reward-title">ÊåëÊàòÊàêÂäüÔºÅ</div>
        <div class="reward-content">
            <p>ÊÅ≠Âñú‰Ω†ÂÆåÊàê‰∫Ü10‰∏™ÂçïËØçÁöÑÊåëÊàòÔºÅ</p>
            <p>‰Ω†Ëé∑Âæó‰∫Ü‰ª•‰∏ãÂ•ñÂä±Ôºö</p>
        </div>
        <div class="reward-stats">
            <div class="reward-stat">
                <div class="reward-label">ÈáëÂ∏Å</div>
                <div class="reward-value" id="rewardGold">+50</div>
            </div>
            <div class="reward-stat">
                <div class="reward-label">ÁªèÈ™åÂÄº</div>
                <div class="reward-value" id="rewardExp">+100</div>
            </div>
            <div class="reward-stat">
                <div class="reward-label">ÂæΩÁ´†</div>
                <div class="reward-value">ü•á</div>
            </div>
        </div>
        <button class="word-info-close" id="closeRewardBtn"><i class="fas fa-check"></i> ÁªßÁª≠Ê∏∏Êàè</button>
    </div>
    
    <script>
        // Ê∏∏ÊàèÊï∞ÊçÆ
        const gameData = {
            playerLevel: 1,
            exp: 0,
            expToNextLevel: 100,
            monstersDefeated: 0,
            currentWord: "",
            wordShieldHP: 100,
            maxHP: 100,
            gameActive: false,
            currentMonster: 0,
            playerLives: 3,
            monsterHealth: 0,
            monsterAttackTimer: null,
            monsterHasAttacked: false,
            selectedLevel: "mix",
            challengeWords: [],
            currentChallengeIndex: 0,
            challengeAttempts: 0,
            gold: 0,
            words: [],
            wordsetName: "ÈªòËÆ§ÂçïËØçÈõÜ",
            selectedLetter: null
        };
        
        // DOMÂÖÉÁ¥†
        const wordShield = document.getElementById('wordShield');
        const wordImage = document.getElementById('wordImage');
        const letterContainer = document.getElementById('letterContainer');
        const targetContainer = document.getElementById('targetContainer');
        const startBtn = document.getElementById('startBtn');
        const fireBtn = document.getElementById('fireBtn');
        const hintBtn = document.getElementById('hintBtn');
        const soundBtn = document.getElementById('soundBtn');
        const exitBtn = document.getElementById('exitBtn');
        const uploadTrigger = document.getElementById('uploadTrigger');
        const wordFileInput = document.getElementById('wordFileInput');
        const levelDisplay = document.getElementById('level');
        const expDisplay = document.getElementById('exp');
        const monstersDisplay = document.getElementById('monstersDefeated');
        const livesDisplay = document.getElementById('lives');
        const levelUpPopup = document.getElementById('levelUpPopup');
        const overlay = document.getElementById('overlay');
        const newLevelDisplay = document.getElementById('newLevel');
        const continueBtn = document.getElementById('continueBtn');
        const monsterCanvas = document.getElementById('monsterCanvas');
        const monsterHealthBar = document.getElementById('monsterHealthBar');
        const wordInfoPopup = document.getElementById('wordInfoPopup');
        const wordInfoWord = document.getElementById('wordInfoWord');
        const wordInfoPhonetic = document.getElementById('wordInfoPhonetic');
        const wordInfoTranslation = document.getElementById('wordInfoTranslation');
        const wordInfoExample1 = document.getElementById('wordInfoExample1');
        const wordInfoExample2 = document.getElementById('wordInfoExample2');
        const wordInfoExample1Trans = document.getElementById('wordInfoExample1Trans');
        const wordInfoExample2Trans = document.getElementById('wordInfoExample2Trans');
        const closeWordInfoBtn = document.getElementById('closeWordInfoBtn');
        const wordTitle = document.getElementById('wordTitle');
        const levelSelector = document.getElementById('levelSelector');
        const challengeProgress = document.getElementById('challengeProgress');
        const goldDisplay = document.getElementById('gold');
        const rewardPopup = document.getElementById('rewardPopup');
        const rewardGold = document.getElementById('rewardGold');
        const rewardExp = document.getElementById('rewardExp');
        const closeRewardBtn = document.getElementById('closeRewardBtn');
        const currentWordsetInfo = document.getElementById('currentWordsetInfo');
        const monsterNameLabel = document.getElementById('monsterName');
        const uploadStatus = document.getElementById('uploadStatus');
        
        // Â§ÑÁêÜÂõæÁâáÂä†ËΩΩÂ§±Ë¥•
        function handleImageError(img) {
            const wordImageContainer = img.parentNode;
            const currentWord = gameData.challengeWords[gameData.currentChallengeIndex];
            
            if (!currentWord) return;
            
            // ÂàõÂª∫ÂõûÈÄÄÂÜÖÂÆπ
            const fallback = document.createElement('div');
            fallback.className = 'image-fallback';
            fallback.innerHTML = `
                <i class="fas fa-image"></i>
                <span>${currentWord.translation}</span>
            `;
            
            // ÈöêËóèÂõæÁâáÂπ∂ÊòæÁ§∫ÂõûÈÄÄÂÜÖÂÆπ
            img.style.display = 'none';
            wordImageContainer.appendChild(fallback);
        }
        
        // ÊÄ™ÂÖΩÁ±ª
        class Monster {
            constructor(canvas, type) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.type = type || Math.floor(Math.random() * 3);
                this.color = this.getRandomColor();
                this.width = canvas.width;
                this.height = canvas.height;
                this.x = this.width / 2;
                this.y = this.height / 2;
                this.size = Math.min(this.width, this.height) * 0.4;
                this.eyeSize = this.size * 0.2;
                this.mouthSize = this.size * 0.15;
                this.animationState = 'idle';
                this.animationTimer = 0;
                this.blinkTimer = 0;
                this.blinkState = false;
                this.blinkDuration = 10;
                this.animationSpeed = 0.05;
                this.attackState = false;
                this.attackTimer = 0;
                this.attackDuration = 30;
                this.name = this.getRandomName();
            }
            
            getRandomColor() {
                const colors = [
                    '#FF6B6B', // Á∫¢Ëâ≤
                    '#4ECDC4', // ÈùíËâ≤
                    '#FFD166', // ÈªÑËâ≤
                    '#A855F7', // Á¥´Ëâ≤
                    '#06B6D4'  // ËìùËâ≤
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            getRandomName() {
                const names = ['Â≠óÊØçÂêûÂô¨ËÄÖ', 'ÂçïËØçÁ†¥ÂùèËÄÖ', 'ÊãºÂÜôÊÄ™ÂÖΩ', 'Â≠¶‰π†Âπ≤Êâ∞ÂÖΩ', 'ËØçÊ±áÁ†¥ÂùèÁéã'];
                return names[Math.floor(Math.random() * names.length)];
            }
            
            draw() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                // ÁªòÂà∂Ë∫´‰Ωì
                this.ctx.fillStyle = this.color;
                
                switch(this.type) {
                    case 0: // ÂúÜÂΩ¢ÊÄ™ÂÖΩ
                        this.ctx.beginPath();
                        this.ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        this.ctx.fill();
                        break;
                    case 1: // ÊñπÂΩ¢ÊÄ™ÂÖΩ
                        this.ctx.fillRect(this.x - this.size, this.y - this.size, this.size * 2, this.size * 2);
                        break;
                    case 2: // ‰∏âËßíÂΩ¢ÊÄ™ÂÖΩ
                        this.ctx.beginPath();
                        this.ctx.moveTo(this.x, this.y - this.size);
                        this.ctx.lineTo(this.x - this.size, this.y + this.size);
                        this.ctx.lineTo(this.x + this.size, this.y + this.size);
                        this.ctx.closePath();
                        this.ctx.fill();
                        break;
                }
                
                // ÁªòÂà∂ÁúºÁùõ
                this.ctx.fillStyle = 'white';
                const eyeOffset = this.size * 0.3;
                
                // Â∑¶Áúº
                this.ctx.beginPath();
                this.ctx.arc(this.x - eyeOffset, this.y - this.size * 0.1, this.eyeSize, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Âè≥Áúº
                this.ctx.beginPath();
                this.ctx.arc(this.x + eyeOffset, this.y - this.size * 0.1, this.eyeSize, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Áû≥Â≠î
                this.ctx.fillStyle = 'black';
                const pupilOffset = this.size * 0.05;
                const pupilSize = this.eyeSize * 0.5;
                
                // Â∑¶Áû≥Â≠î
                this.ctx.beginPath();
                this.ctx.arc(this.x - eyeOffset - pupilOffset, this.y - this.size * 0.1, pupilSize, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Âè≥Áû≥Â≠î
                this.ctx.beginPath();
                this.ctx.arc(this.x + eyeOffset - pupilOffset, this.y - this.size * 0.1, pupilSize, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Áú®ÁúºÊïàÊûú
                if (this.blinkState) {
                    this.ctx.fillStyle = this.color;
                    this.ctx.fillRect(this.x - eyeOffset - this.eyeSize, this.y - this.size * 0.1 - this.eyeSize/2, 
                                    this.eyeSize * 2, this.eyeSize/2);
                    this.ctx.fillRect(this.x + eyeOffset - this.eyeSize, this.y - this.size * 0.1 - this.eyeSize/2, 
                                    this.eyeSize * 2, this.eyeSize/2);
                }
                
                // ÁªòÂà∂Âò¥Â∑¥
                this.ctx.fillStyle = 'black';
                this.ctx.beginPath();
                
                if (this.attackState) {
                    // ÊîªÂáªÁä∂ÊÄÅÁöÑÂò¥Â∑¥ÔºàÂº†ÂºÄÔºâ
                    this.ctx.arc(this.x, this.y + this.size * 0.2, this.mouthSize * 1.5, 0, Math.PI);
                } else {
                    // ÊôÆÈÄöÁä∂ÊÄÅÁöÑÂò¥Â∑¥ÔºàÂæÆÁ¨ëÔºâ
                    this.ctx.arc(this.x, this.y + this.size * 0.2, this.mouthSize, 0, Math.PI);
                }
                
                this.ctx.stroke();
                
                // ÁªòÂà∂ÁâôÈΩøÔºàÊîªÂáªÁä∂ÊÄÅÔºâ
                if (this.attackState) {
                    this.ctx.fillStyle = 'white';
                    const toothWidth = this.mouthSize * 0.2;
                    const toothHeight = this.mouthSize * 0.4;
                    
                    // Â∑¶‰∏äÁâôÈΩø
                    this.ctx.fillRect(this.x - toothWidth, this.y + this.size * 0.2 - toothHeight/2, toothWidth, toothHeight);
                    
                    // Âè≥‰∏äÁâôÈΩø
                    this.ctx.fillRect(this.x, this.y + this.size * 0.2 - toothHeight/2, toothWidth, toothHeight);
                }
            }
            
            update() {
                // Êõ¥Êñ∞Áú®ÁúºËÆ°Êó∂Âô®
                this.blinkTimer++;
                if (this.blinkTimer > 100) {
                    this.blinkState = true;
                    if (this.blinkTimer > 100 + this.blinkDuration) {
                        this.blinkState = false;
                        this.blinkTimer = 0;
                    }
                }
                
                // Êõ¥Êñ∞ÊîªÂáªÁä∂ÊÄÅËÆ°Êó∂Âô®
                if (this.attackState) {
                    this.attackTimer++;
                    if (this.attackTimer > this.attackDuration) {
                        this.attackState = false;
                        this.attackTimer = 0;
                    }
                }
                
                // Ê†πÊçÆÂä®ÁîªÁä∂ÊÄÅÊõ¥Êñ∞‰ΩçÁΩÆ
                switch(this.animationState) {
                    case 'idle':
                        // Á©∫Èó≤Áä∂ÊÄÅ‰∏çÊµÆÂä®ÔºàÊµÆÂä®Âä®ÁîªÁî±CSSÂ§ÑÁêÜÔºâ
                        break;
                    case 'attack':
                        // ÊîªÂáªÂä®Áîª
                        this.y = this.height / 2 + Math.sin(Date.now() * this.animationSpeed * 3) * 10;
                        break;
                }
                
                this.draw();
            }
            
            attack() {
                this.attackState = true;
                this.attackTimer = 0;
                this.animationState = 'attack';
                
                // 2ÁßíÂêéÂõûÂà∞Á©∫Èó≤Áä∂ÊÄÅ
                setTimeout(() => {
                    this.animationState = 'idle';
                }, 2000);
            }
        }
        
        let monsterInstance = null;
        
        // ‰ªéXLSXÊñá‰ª∂Âä†ËΩΩÂçïËØçÊï∞ÊçÆ
        async function loadWords() {
            try {
                // Â∞ùËØïÂä†ËΩΩÊú¨Âú∞Â≠òÂÇ®ÁöÑËá™ÂÆö‰πâÂçïËØçÈõÜ
                const customWordset = localStorage.getItem('customWordset');
                if (customWordset) {
                    const parsed = JSON.parse(customWordset);
                    gameData.words = parsed.words || [];
                    gameData.wordsetName = parsed.wordsetName || "Ëá™ÂÆö‰πâÂçïËØçÈõÜ";
                    console.log('‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩËá™ÂÆö‰πâÂçïËØçÈõÜ:', gameData.words.length, '‰∏™ÂçïËØç');
                } else {
                    // Âä†ËΩΩÈªòËÆ§ÂçïËØçÈõÜ
                    gameData.words = getDefaultWords();
                    gameData.wordsetName = "ÈªòËÆ§ÂçïËØçÈõÜ";
                    console.log('‰ΩøÁî®ÈªòËÆ§ÂçïËØçÊï∞ÊçÆ:', gameData.words.length, '‰∏™ÂçïËØç');
                }
                updateWordsetInfo();
            } catch (error) {
                console.error('Âä†ËΩΩÂçïËØçÊï∞ÊçÆÂ§±Ë¥•:', error);
                gameData.words = getDefaultWords();
                gameData.wordsetName = "ÈªòËÆ§ÂçïËØçÈõÜ";
                updateWordsetInfo();
            }
        }
        
        // Ëé∑ÂèñÈªòËÆ§ÂçïËØç
        function getDefaultWords() {
            return [
                {
                    word: "APPLE",
                    image: "https://images.unsplash.com/photo-1568702846914-96b305d2aaeb?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8ZnJ1aXQsYXBwbGV8fHx8fHwxNjI5ODQ3MjU4&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/Àà√¶p.…ôl/",
                    translation: "ËãπÊûú",
                    examples: [
                        "I eat an apple every day for breakfast.",
                        "The teacher placed a shiny red apple on her desk."
                    ],
                    translations: [
                        "ÊàëÊØèÂ§©Êó©È§êÂêÉ‰∏Ä‰∏™ËãπÊûú„ÄÇ",
                        "ËÄÅÂ∏àÂú®Ê°åÂ≠ê‰∏äÊîæ‰∫Ü‰∏Ä‰∏™Èó™‰∫ÆÁöÑÁ∫¢ËãπÊûú„ÄÇ"
                    ],
                    level: 1
                },
                {
                    word: "BEACH",
                    image: "https://images.unsplash.com/photo-1505228395891-9a51e7e86bf6?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8YmVhY2h8fHx8fHwxNjI5ODQ3MjYy&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/biÀêt É/",
                    translation: "Êµ∑Êª©",
                    examples: [
                        "Children built sandcastles on the sunny beach.",
                        "We collected beautiful seashells along the beach."
                    ],
                    translations: [
                        "Â≠©Â≠ê‰ª¨Âú®Èò≥ÂÖâÊòéÂ™öÁöÑÊµ∑Êª©‰∏äÂ†ÜÊ≤ôÂ†°„ÄÇ",
                        "Êàë‰ª¨Ê≤øÁùÄÊµ∑Êª©Êî∂ÈõÜ‰∫ÜÁæé‰∏ΩÁöÑË¥ùÂ£≥„ÄÇ"
                    ],
                    level: 1
                },
                {
                    word: "CAT",
                    image: "https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8Y2F0fHx8fHx8MTYyOTg0NzI3Mg&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/k√¶t/",
                    translation: "Áå´",
                    examples: [
                        "The cat curled up on the sofa and fell asleep.",
                        "My neighbor has a black cat with green eyes."
                    ],
                    translations: [
                        "Áå´Ëú∑Áº©Âú®Ê≤ôÂèë‰∏äÁù°ÁùÄ‰∫Ü„ÄÇ",
                        "ÊàëÁöÑÈÇªÂ±ÖÊúâ‰∏ÄÂè™ÁªøÁúºÁùõÁöÑÈªëÁå´„ÄÇ"
                    ],
                    level: 1
                },
                {
                    word: "DOG",
                    image: "https://images.unsplash.com/photo-1517423447168-cb804aafa6e0?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8ZG9nfHx8fHx8MTYyOTg0NzI3OA&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/d…í…°/",
                    translation: "Áãó",
                    examples: [
                        "The dog wagged its tail happily when I came home.",
                        "We take our dog for a walk every evening."
                    ],
                    translations: [
                        "ÂΩìÊàëÂõûÂÆ∂Êó∂ÔºåÁãóÈ´òÂÖ¥Âú∞ÊëáÁùÄÂ∞æÂ∑¥„ÄÇ",
                        "Êàë‰ª¨ÊØèÂ§©Êôö‰∏äÈÉΩÂ∏¶ÁãóÂéªÊï£Ê≠•„ÄÇ"
                    ],
                    level: 1
                },
                {
                    word: "ELEPHANT",
                    image: "https://images.unsplash.com/photo-1549468057-5b7fa1a41d7a?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8ZWxlcGhhbnR8fHx8fHwxNjI5ODQ3Mjg0&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/Ààel.…™.f…ônt/",
                    translation: "Â§ßË±°",
                    examples: [
                        "The elephant used its trunk to spray water on itself.",
                        "We saw a family of elephants at the wildlife park."
                    ],
                    translations: [
                        "Â§ßË±°Áî®ÂÆÉÁöÑÈºªÂ≠êÂæÄËá™Â∑±Ë∫´‰∏äÂñ∑Ê∞¥„ÄÇ",
                        "Êàë‰ª¨Âú®ÈáéÁîüÂä®Áâ©Âõ≠ÁúãÂà∞‰∫Ü‰∏ÄÁæ§Â§ßË±°„ÄÇ"
                    ],
                    level: 2
                },
                {
                    word: "FLOWER",
                    image: "https://images.unsplash.com/photo-1490750967868-88aa4486c946?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8Zmxvd2VyfHx8fHx8MTYyOTg0NzI5MA&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/Ààfla ä.…ôr/",
                    translation: "Ëä±",
                    examples: [
                        "She planted colorful flowers in her garden.",
                        "He gave her a bouquet of roses for her birthday."
                    ],
                    translations: [
                        "Â•πÂú®Ëä±Âõ≠ÈáåÁßç‰∫Ü‰∫îÈ¢úÂÖ≠Ëâ≤ÁöÑËä±„ÄÇ",
                        "‰ªñÂú®Â•πÁîüÊó•Êó∂ÈÄÅÁªôÂ•π‰∏ÄÊùüÁé´Áë∞„ÄÇ"
                    ],
                    level: 2
                },
                {
                    word: "GUITAR",
                    image: "https://images.unsplash.com/photo-1541689592655-f5f52825a3b8?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8Z3VpdGFyfHx8fHx8MTYyOTg0NzI5Ng&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/…°…™Ààt…ëÀêr/",
                    translation: "Âêâ‰ªñ",
                    examples: [
                        "He plays the guitar in a rock band.",
                        "I'm learning to play the guitar."
                    ],
                    translations: [
                        "‰ªñÂú®‰∏Ä‰∏™ÊëáÊªö‰πêÈòüÂºπÂêâ‰ªñ„ÄÇ",
                        "ÊàëÊ≠£Âú®Â≠¶‰π†ÂºπÂêâ‰ªñ„ÄÇ"
                    ],
                    level: 3
                },
                {
                    word: "HOUSE",
                    image: "https://images.unsplash.com/photo-1575517111839-3a3843ee7f5d?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8aG91c2V8fHx8fHwxNjI5ODQ3MzAy&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/ha äs/",
                    translation: "ÊàøÂ≠ê",
                    examples: [
                        "They bought a new house near the lake.",
                        "Our house has three bedrooms and a large kitchen."
                    ],
                    translations: [
                        "‰ªñ‰ª¨Âú®ÊπñËæπ‰π∞‰∫Ü‰∏ÄÊ†ãÊñ∞ÊàøÂ≠ê„ÄÇ",
                        "Êàë‰ª¨ÁöÑÊàøÂ≠êÊúâ‰∏âÈó¥ÂçßÂÆ§Âíå‰∏Ä‰∏™Â§ßÂé®Êàø„ÄÇ"
                    ],
                    level: 3
                },
                {
                    word: "ISLAND",
                    image: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8aXNsYW5kfHx8fHx8MTYyOTg0NzMwOA&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/Ààa…™.l…ônd/",
                    translation: "Â≤õÂ±ø",
                    examples: [
                        "We spent our vacation on a tropical island.",
                        "The small island has beautiful beaches and clear water."
                    ],
                    translations: [
                        "Êàë‰ª¨Âú®‰∏Ä‰∏™ÁÉ≠Â∏¶Â≤õÂ±ø‰∏äÂ∫¶Ëøá‰∫ÜÂÅáÊúü„ÄÇ",
                        "Ëøô‰∏™Â∞èÂ≤õÊúâÁæé‰∏ΩÁöÑÊµ∑Êª©ÂíåÊ∏ÖÊæàÁöÑÊµ∑Ê∞¥„ÄÇ"
                    ],
                    level: 4
                },
                {
                    word: "JUNGLE",
                    image: "https://images.unsplash.com/photo-1475855581690-80accde3ae2b?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8anVuZ2xlfHx8fHx8MTYyOTg0NzMxNA&ixlib=rb-1.2.1&q=80&w=400",
                    audio: "https://www.soundjay.com/buttons/sounds/button-09.mp3",
                    phonetic: "/Ààd í å≈ã.…°…ôl/",
                    translation: "‰∏õÊûó",
                    examples: [
                        "The explorers trekked through the dense jungle.",
                        "Many exotic animals live in the jungle."
                    ],
                    translations: [
                        "Êé¢Èô©ÂÆ∂‰ª¨ÂæíÊ≠•Á©øË∂ä‰∫ÜËåÇÂØÜÁöÑ‰∏õÊûó„ÄÇ",
                        "ËÆ∏Â§öÂºÇÂõΩÂä®Áâ©ÁîüÊ¥ªÂú®‰∏õÊûó‰∏≠„ÄÇ"
                    ],
                    level: 5
                }
            ];
        }
        
        // Êõ¥Êñ∞ÂçïËØçÈõÜ‰ø°ÊÅØÊòæÁ§∫
        function updateWordsetInfo() {
            currentWordsetInfo.textContent = `ÂΩìÂâçÂçïËØçÈõÜ: ${gameData.wordsetName} (${gameData.words.length}‰∏™ÂçïËØç)`;
        }
        
        // ‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆÂà∞localStorage
        function saveGameData() {
            const saveData = {
                playerLevel: gameData.playerLevel,
                exp: gameData.exp,
                expToNextLevel: gameData.expToNextLevel,
                monstersDefeated: gameData.monstersDefeated,
                gold: gameData.gold
            };
            localStorage.setItem('wordGuardianData', JSON.stringify(saveData));
            console.log('Ê∏∏ÊàèÊï∞ÊçÆÂ∑≤‰øùÂ≠ò');
        }
        
        // ‰ªélocalStorageÂä†ËΩΩÊ∏∏ÊàèÊï∞ÊçÆ
        function loadGameData() {
            const savedData = localStorage.getItem('wordGuardianData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                gameData.playerLevel = parsedData.playerLevel || 1;
                gameData.exp = parsedData.exp || 0;
                gameData.expToNextLevel = parsedData.expToNextLevel || 100;
                gameData.monstersDefeated = parsedData.monstersDefeated || 0;
                gameData.gold = parsedData.gold || 0;
                console.log('Ê∏∏ÊàèÊï∞ÊçÆÂ∑≤Âä†ËΩΩ');
            } else {
                console.log('Ê≤°ÊúâÊâæÂà∞‰øùÂ≠òÁöÑÊ∏∏ÊàèÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº');
            }
        }
        
        // ÈÄÄÂá∫ÂΩìÂâçÊåëÊàò
        function exitChallenge() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫Êú¨Ê¨°ÊåëÊàòÂêóÔºüÂΩìÂâçËøõÂ∫¶Â∞Ü‰ºö‰∏¢Â§±ÔºÅ')) {
                clearTimeout(gameData.monsterAttackTimer);
                resetGameState();
                gameData.challengeWords = [];
                gameData.currentChallengeIndex = 0;
                challengeProgress.innerHTML = '';
                
                wordShield.textContent = "ÊåëÊàòÂ∑≤ÈÄÄÂá∫";
                wordShield.style.backgroundColor = 'rgba(96, 125, 139, 0.3)';
            }
        }
        
        // ÂàùÂßãÂåñÊ∏∏Êàè
        async function initGame() {
            await loadWords();
            loadGameData();
            updateStats();
            
            monsterCanvas.width = 140;
            monsterCanvas.height = 140;
            monsterInstance = new Monster(monsterCanvas);
            animateMonster();
            
            startBtn.addEventListener('click', startChallenge);
            fireBtn.addEventListener('click', fireAttack);
            hintBtn.addEventListener('click', showWordInfo);
            soundBtn.addEventListener('click', speakWord);
            exitBtn.addEventListener('click', exitChallenge);
            continueBtn.addEventListener('click', hideLevelUpPopup);
            closeWordInfoBtn.addEventListener('click', hideWordInfoPopup);
            closeRewardBtn.addEventListener('click', hideRewardPopup);
            
            uploadTrigger.addEventListener('click', () => {
                wordFileInput.click();
            });
            
            wordFileInput.addEventListener('change', handleFileUpload);
            
            const levelBtns = levelSelector.querySelectorAll('.level-btn');
            levelBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    levelBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameData.selectedLevel = btn.dataset.level;
                });
            });
        }
        
        // Âä®ÁîªÂæ™ÁéØ
        function animateMonster() {
            if (monsterInstance) {
                monsterInstance.update();
            }
            requestAnimationFrame(animateMonster);
        }
        
        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    uploadStatus.textContent = "Ê≠£Âú®Â§ÑÁêÜÊñá‰ª∂...";
                    uploadStatus.className = "upload-status";
                    uploadStatus.style.display = "block";
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™Â∑•‰ΩúË°®
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Â∞ÜÂ∑•‰ΩúË°®ËΩ¨Êç¢‰∏∫JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Êò†Â∞ÑÊï∞ÊçÆÂà∞ÈúÄË¶ÅÁöÑÊ†ºÂºè
                    const mappedData = jsonData.map(row => {
                        // Á°Æ‰øùÂàóÂêçÂåπÈÖçÔºàExcelÂàóÂêçÔºâ
                        return {
                            word: row['word'] || row['ÂçïËØç'] || row['Ëã±Êñá'] || '',
                            image: row['image'] || row['ÂõæÁâá'] || row['ÂõæÂÉè'] || '',
                            audio: row['audio'] || row['ÂèëÈü≥'] || row['Èü≥È¢ë'] || '',
                            phonetic: row['phonetic'] || row['Èü≥Ê†á'] || '',
                            translation: row['translation'] || row['ÁøªËØë'] || '',
                            examples: [
                                row['example1'] || row['‰æãÂè•1'] || '',
                                row['example2'] || row['‰æãÂè•2'] || ''
                            ].filter(example => example),
                            translations: [
                                row['translation1'] || row['ÁøªËØë1'] || '',
                                row['translation2'] || row['ÁøªËØë2'] || ''
                            ].filter(trans => trans),
                            level: row['level'] || row['Á∫ßÂà´'] || 1
                        };
                    });
                    
                    if (mappedData.length === 0) {
                        throw new Error('Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ');
                    }
                    
                    const wordsetName = file.name.replace('.xlsx', '');
                    const customWordset = {
                        words: mappedData,
                        wordsetName: wordsetName
                    };
                    
                    localStorage.setItem('customWordset', JSON.stringify(customWordset));
                    
                    gameData.words = mappedData;
                    gameData.wordsetName = wordsetName;
                    updateWordsetInfo();
                    
                    uploadStatus.textContent = `ÂçïËØç‰∏ä‰º†ÊàêÂäüÔºÅÂÖ±Âä†ËΩΩ ${mappedData.length} ‰∏™ÂçïËØç„ÄÇ`;
                    uploadStatus.className = "upload-status success";
                    resetGameState();
                    
                } catch (error) {
                    console.error('Êñá‰ª∂‰∏ä‰º†ÈîôËØØ:', error);
                    uploadStatus.textContent = 'Ëß£ÊûêXLSXÊñá‰ª∂Â§±Ë¥•: ' + error.message;
                    uploadStatus.className = "upload-status error";
                }
            };
            reader.onerror = function() {
                uploadStatus.textContent = 'ËØªÂèñÊñá‰ª∂Â§±Ë¥•';
                uploadStatus.className = "upload-status error";
            };
            reader.readAsArrayBuffer(file);
        }
        
        // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
        function resetGameState() {
            gameData.gameActive = false;
            letterContainer.innerHTML = '';
            targetContainer.innerHTML = '';
            wordShield.textContent = 'ÂáÜÂ§áÂ∞±Áª™';
            wordShield.style.backgroundColor = '';
            fireBtn.classList.remove('active');
            gameData.selectedLetter = null;
        }
        
        // ÊòæÁ§∫ÂçïËØç‰ø°ÊÅØÂºπÁ™ó
        function showWordInfo() {
            if (!gameData.gameActive || gameData.currentChallengeIndex >= gameData.challengeWords.length) {
                alert("ËØ∑ÂÖàÂºÄÂßãÊåëÊàòÔºÅ");
                return;
            }
            
            try {
                const currentWordData = gameData.challengeWords[gameData.currentChallengeIndex];
                if (!currentWordData) return;
                
                const displayWord = currentWordData.word;
                wordTitle.textContent = `ÂçïËØçÁßòÁ±ç: ${displayWord}`;
                wordInfoWord.textContent = displayWord;
                wordInfoPhonetic.textContent = currentWordData.phonetic || "/Êú™Êèê‰æõ/";
                wordInfoTranslation.textContent = currentWordData.translation;
                
                if (currentWordData.examples && currentWordData.examples.length > 0) {
                    wordInfoExample1.textContent = currentWordData.examples[0];
                    wordInfoExample1Trans.textContent = currentWordData.translations?.[0] || "Êú™Êèê‰æõÁøªËØë";
                    
                    if (currentWordData.examples.length > 1) {
                        wordInfoExample2.textContent = currentWordData.examples[1];
                        wordInfoExample2Trans.textContent = currentWordData.translations?.[1] || "Êú™Êèê‰æõÁøªËØë";
                    } else {
                        wordInfoExample2.textContent = "Êú™Êèê‰æõÊõ¥Â§ö‰æãÂè•";
                        wordInfoExample2Trans.textContent = "";
                    }
                } else {
                    wordInfoExample1.textContent = "Êú™Êèê‰æõ‰æãÂè•";
                    wordInfoExample1Trans.textContent = "";
                    wordInfoExample2.textContent = "";
                    wordInfoExample2Trans.textContent = "";
                }
                
                wordInfoPopup.style.display = 'block';
                overlay.style.display = 'block';
            } catch (error) {
                console.error("ÊòæÁ§∫ÂçïËØç‰ø°ÊÅØÂ§±Ë¥•:", error);
                alert("Êó†Ê≥ïËé∑ÂèñÂçïËØç‰ø°ÊÅØÔºåËØ∑ÈáçËØïÔºÅ");
            }
        }
        
        // ÈöêËóèÂçïËØç‰ø°ÊÅØÂºπÁ™ó
        function hideWordInfoPopup() {
            wordInfoPopup.style.display = 'none';
            overlay.style.display = 'none';
        }
        
        // ÈöêËóèÂ•ñÂä±ÂºπÁ™ó
        function hideRewardPopup() {
            rewardPopup.style.display = 'none';
            overlay.style.display = 'none';
        }
        
        // ÂºÄÂßãÊñ∞ÊåëÊàò
        function startChallenge() {
            if (gameData.gameActive) return;
            
            if (gameData.words.length < 10) {
                alert(`ÂΩìÂâçÂçïËØçÈõÜÂè™Êúâ ${gameData.words.length} ‰∏™ÂçïËØçÔºåËá≥Â∞ëÈúÄË¶Å 10 ‰∏™ÂçïËØçÊâçËÉΩÂºÄÂßãÊåëÊàòÔºÅ`);
                return;
            }
            
            gameData.challengeAttempts = 0;
            gameData.currentChallengeIndex = 0;
            gameData.challengeWords = [];
            
            if (gameData.selectedLevel === "mix") {
                const shuffled = [...gameData.words].sort(() => 0.5 - Math.random());
                gameData.challengeWords = shuffled.slice(0, 10);
            } else {
                const level = parseInt(gameData.selectedLevel);
                const levelWords = gameData.words.filter(word => word.level === level);
                const shuffled = [...levelWords].sort(() => 0.5 - Math.random());
                gameData.challengeWords = shuffled.slice(0, Math.min(10, shuffled.length));
            }
            
            createChallengeProgress();
            startNextWord();
        }
        
        // ÂàõÂª∫ÊåëÊàòËøõÂ∫¶ÊåáÁ§∫Âô®
        function createChallengeProgress() {
            challengeProgress.innerHTML = '';
            for (let i = 0; i < gameData.challengeWords.length; i++) {
                const progressItem = document.createElement('div');
                progressItem.className = 'progress-item';
                progressItem.textContent = i + 1;
                if (i === 0) {
                    progressItem.classList.add('active');
                }
                challengeProgress.appendChild(progressItem);
            }
        }
        
        // Êõ¥Êñ∞ÊåëÊàòËøõÂ∫¶
        function updateChallengeProgress(success) {
            const progressItems = challengeProgress.querySelectorAll('.progress-item');
            const currentItem = progressItems[gameData.currentChallengeIndex];
            
            currentItem.classList.remove('active');
            if (success) {
                currentItem.classList.add('completed');
            } else {
                currentItem.classList.add('failed');
            }
            
            if (gameData.currentChallengeIndex < gameData.challengeWords.length - 1) {
                progressItems[gameData.currentChallengeIndex + 1].classList.add('active');
            }
        }
        
        // ÂºÄÂßã‰∏ã‰∏Ä‰∏™ÂçïËØçÊåëÊàò
        function startNextWord() {
            if (gameData.currentChallengeIndex >= gameData.challengeWords.length) {
                challengeSuccess();
                return;
            }
            
            gameData.gameActive = true;
            gameData.playerLives = 3;
            gameData.monsterHasAttacked = false;
            gameData.selectedLetter = null;
            updateLives();
            fireBtn.classList.remove('active');
            
            letterContainer.innerHTML = '';
            targetContainer.innerHTML = '';
            targetContainer.innerHTML = '<div class="mobile-drag-hint">ÁÇπÂáªÂ≠óÊØçÁÑ∂ÂêéÁÇπÂáªÊ≠§Â§ÑÊîæÁΩÆ</div>';
            monsterHealthBar.innerHTML = '';
            
            const wordData = gameData.challengeWords[gameData.currentChallengeIndex];
            gameData.currentWord = wordData.word;
            
            // ÈáçÁΩÆÂõæÁâáÊòæÁ§∫
            const wordImageContainer = wordImage.parentNode;
            const existingFallback = wordImageContainer.querySelector('.image-fallback');
            if (existingFallback) {
                existingFallback.remove();
            }
            wordImage.src = wordData.image || '';
            wordImage.alt = wordData.word;
            wordImage.style.display = 'block';
            
            monsterInstance = new Monster(monsterCanvas);
            monsterNameLabel.textContent = monsterInstance.name;
            
            gameData.monsterHealth = gameData.currentWord.length;
            createMonsterHealthBar();
            
            wordShield.textContent = gameData.currentWord.toLowerCase();
            
            setTimeout(speakWord, 500);
            
            for (let i = 0; i < gameData.currentWord.length; i++) {
                const target = document.createElement('div');
                target.className = 'target';
                target.dataset.index = i;
                target.dataset.expected = gameData.currentWord[i];
                target.addEventListener('click', handleTargetClick);
                targetContainer.appendChild(target);
            }
            
            clearTimeout(gameData.monsterAttackTimer);
            gameData.monsterAttackTimer = setTimeout(() => {
                monsterAttack();
                scatterLetters();
            }, 10000);
        }
        
        // ÊÄ™Áâ©ÊîªÂáª
        function monsterAttack() {
            if (!gameData.gameActive || gameData.monsterHasAttacked) return;
            
            gameData.monsterHasAttacked = true;
            
            if (monsterInstance) {
                monsterInstance.attack();
            }
            
            const laser = document.createElement('div');
            laser.className = 'monster-laser';
            
            const monsterRect = monsterCanvas.getBoundingClientRect();
            const shieldRect = wordShield.getBoundingClientRect();
            const containerRect = document.querySelector('.game-container').getBoundingClientRect();
            
            const startX = monsterRect.left - containerRect.left + monsterRect.width/2;
            const startY = monsterRect.top - containerRect.top + monsterRect.height/2;
            const endX = shieldRect.left - containerRect.left + shieldRect.width/2;
            const endY = shieldRect.top - containerRect.top + shieldRect.height/2;
            
            const dx = endX - startX;
            const dy = endY - startY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            laser.style.width = '0';
            laser.style.left = `${startX}px`;
            laser.style.top = `${startY}px`;
            laser.style.transform = `rotate(${angle}deg)`;
            laser.style.opacity = '0';
            
            document.querySelector('.game-container').appendChild(laser);
            
            setTimeout(() => {
                laser.style.transition = 'width 0.5s ease, opacity 0.5s ease';
                laser.style.width = `${distance}px`;
                laser.style.opacity = '1';
            }, 100);
            
            setTimeout(() => {
                wordShield.classList.add('shake');
                
                setTimeout(() => {
                    if (laser.parentNode) {
                        laser.parentNode.removeChild(laser);
                    }
                    wordShield.classList.remove('shake');
                }, 500);
            }, 600);
        }
        
        // ÂàõÂª∫ÊÄ™ÂÖΩË°ÄÊù°
        function createMonsterHealthBar() {
            monsterHealthBar.innerHTML = '';
            for (let i = 0; i < gameData.monsterHealth; i++) {
                const segment = document.createElement('div');
                segment.className = 'health-segment';
                monsterHealthBar.appendChild(segment);
            }
        }
        
        // Êõ¥Êñ∞ÊÄ™ÂÖΩË°ÄÊù°
        function updateMonsterHealthBar() {
            const segments = document.querySelectorAll('.health-segment');
            segments.forEach((segment, index) => {
                if (index >= gameData.monsterHealth) {
                    segment.classList.add('lost');
                }
            });
        }
        
        // ÊâìÊï£Â≠óÊØçÔºà‰ºòÂåñ‰∏∫‰∏§Ë°åÂ∏ÉÂ±ÄÔºâ
        function scatterLetters() {
            wordShield.textContent = '';
            wordShield.style.backgroundColor = 'rgba(255, 107, 107, 0.3)';
            
            createLaserEffect();
            
            setTimeout(() => {
                const letters = gameData.currentWord.split('');
                
                // Ê∏ÖÁ©∫Â≠óÊØçÂÆπÂô®
                letterContainer.innerHTML = '';
                
                // ÂàõÂª∫‰∏§Ë°åÂÆπÂô®
                const row1 = document.createElement('div');
                row1.className = 'letter-row';
                row1.style.display = 'flex';
                row1.style.justifyContent = 'center';
                row1.style.width = '100%';
                row1.style.marginBottom = '10px';
                
                const row2 = document.createElement('div');
                row2.className = 'letter-row';
                row2.style.display = 'flex';
                row2.style.justifyContent = 'center';
                row2.style.width = '100%';
                
                // Â∞ÜÂ≠óÊØçÈöèÊú∫ÂàÜÈÖçÂà∞‰∏§Ë°å
                const shuffledLetters = [...letters].sort(() => Math.random() - 0.5);
                const splitIndex = Math.ceil(shuffledLetters.length / 2);
                
                const row1Letters = shuffledLetters.slice(0, splitIndex);
                const row2Letters = shuffledLetters.slice(splitIndex);
                
                // ÂàõÂª∫Á¨¨‰∏ÄË°åÂ≠óÊØç
                row1Letters.forEach((letter, index) => {
                    const letterElement = createLetterElement(letter, index, row1Letters.length);
                    row1.appendChild(letterElement);
                });
                
                // ÂàõÂª∫Á¨¨‰∫åË°åÂ≠óÊØç
                row2Letters.forEach((letter, index) => {
                    const letterElement = createLetterElement(letter, index, row2Letters.length);
                    row2.appendChild(letterElement);
                });
                
                // Ê∑ªÂä†Ë°åÂà∞ÂÆπÂô®
                letterContainer.appendChild(row1);
                letterContainer.appendChild(row2);
                
                createScatterParticles();
            }, 1000);
        }
        
        // ÂàõÂª∫Â≠óÊØçÂÖÉÁ¥†ÔºàÂ∏¶ÈöèÊú∫‰ΩçÁΩÆÔºâ
        function createLetterElement(letter, index, total) {
            const letterElement = document.createElement('div');
            letterElement.className = 'letter';
            letterElement.textContent = letter.toLowerCase();
            letterElement.dataset.letter = letter;
            letterElement.dataset.index = index;
            letterElement.dataset.id = `letter-${index}-${Date.now()}`;
            
            // ÈöèÊú∫‰ΩçÁΩÆÂÅèÁßª
            const offsetX = (Math.random() - 0.5) * 30;
            const offsetY = (Math.random() - 0.5) * 30;
            
            letterElement.style.position = 'relative';
            letterElement.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
            letterElement.style.transition = 'transform 0.3s ease';
            
            letterElement.addEventListener('click', handleLetterClick);
            
            return letterElement;
        }
        
        // Â≠óÊØçÁÇπÂáªÂ§ÑÁêÜ
        function handleLetterClick(e) {
            const letterElement = e.target;
            
            const allLetters = document.querySelectorAll('.letter');
            allLetters.forEach(letter => {
                if (letter !== letterElement) {
                    letter.classList.remove('selected');
                }
            });
            
            letterElement.classList.toggle('selected');
            
            if (letterElement.classList.contains('selected')) {
                gameData.selectedLetter = letterElement;
            } else {
                gameData.selectedLetter = null;
            }
        }
        
        // ÁõÆÊ†áÂå∫ÂüüÁÇπÂáª‰∫ã‰ª∂
        function handleTargetClick(e) {
            const target = e.target;
            
            if (target.classList.contains('target') && !target.textContent) {
                if (gameData.selectedLetter) {
                    target.textContent = gameData.selectedLetter.textContent;
                    target.classList.add('filled');
                    target.dataset.letter = gameData.selectedLetter.dataset.letter;
                    target.dataset.letterId = gameData.selectedLetter.dataset.id;
                    
                    gameData.selectedLetter.remove();
                    gameData.selectedLetter = null;
                    
                    createParticles(target);
                    
                    const hitEffect = document.createElement('div');
                    hitEffect.className = 'hit-effect';
                    target.appendChild(hitEffect);
                    setTimeout(() => {
                        hitEffect.classList.add('hit-animation');
                    }, 10);
                    
                    setTimeout(() => {
                        if (hitEffect.parentNode) {
                            hitEffect.parentNode.removeChild(hitEffect);
                        }
                    }, 600);
                    
                    checkFireButtonState();
                }
            }
            else if (target.classList.contains('target') && target.textContent) {
                const letter = target.textContent;
                const letterId = target.dataset.letterId;
                createDraggableLetter(letter, target.dataset.index, letterId);
                
                target.textContent = '';
                target.classList.remove('filled');
                target.dataset.letter = '';
                target.dataset.letterId = '';
                
                checkFireButtonState();
                createParticles(target);
            }
        }
        
        // ÂàõÂª∫ÊâìÊï£Â≠óÊØçÊó∂ÁöÑÁ≤íÂ≠êÊïàÊûú
        function createScatterParticles() {
            const containerRect = letterContainer.getBoundingClientRect();
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const x = Math.random() * containerRect.width;
                const y = Math.random() * containerRect.height;
                
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 100;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--p-tx', `${tx}px`);
                particle.style.setProperty('--p-ty', `${ty}px`);
                
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                
                const colors = ['#ffd166', '#ff6b6b', '#4ecdc4', '#a855f7', '#06b6d4'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                letterContainer.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 1500);
            }
        }
        
        // ÂàõÂª∫ÂèØÊãñÊãΩÂ≠óÊØç
        function createDraggableLetter(letter, index, letterId) {
            const letterElement = document.createElement('div');
            letterElement.className = 'letter';
            letterElement.textContent = letter.toLowerCase();
            letterElement.dataset.letter = letter.toUpperCase();
            letterElement.dataset.index = index;
            letterElement.dataset.id = letterId || `letter-${index}-${Date.now()}`;
            
            const containerRect = letterContainer.getBoundingClientRect();
            const x = Math.random() * (containerRect.width - 60);
            const y = Math.random() * (containerRect.height - 60);
            letterElement.style.left = `${x}px`;
            letterElement.style.top = `${y}px`;
            
            letterElement.addEventListener('click', handleLetterClick);
            
            letterContainer.appendChild(letterElement);
            return letterElement;
        }
        
        // ÂàõÂª∫ÊøÄÂÖâÊïàÊûú
        function createLaserEffect() {
            const laser = document.createElement('div');
            laser.className = 'laser';
            laser.style.width = '0';
            laser.style.left = '50%';
            laser.style.top = '170px';
            
            document.querySelector('.game-container').appendChild(laser);
            
            setTimeout(() => {
                laser.style.width = '100%';
                laser.style.left = '0';
                laser.style.transition = 'width 0.5s ease, left 0.5s ease';
            }, 10);
            
            setTimeout(() => {
                document.querySelector('.game-container').removeChild(laser);
            }, 600);
        }
        
        // ÂàõÂª∫Á≤íÂ≠êÊïàÊûú
        function createParticles(element) {
            const rect = element.getBoundingClientRect();
            
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 100;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--p-tx', `${tx}px`);
                particle.style.setProperty('--p-ty', `${ty}px`);
                
                particle.style.left = (rect.left + rect.width/2) + 'px';
                particle.style.top = (rect.top + rect.height/2) + 'px';
                
                const colors = ['#ffd166', '#ff6b6b', '#4ecdc4', '#a855f7', '#06b6d4'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 1500);
            }
        }
        
        // Ê£ÄÊü•ÂèëÂ∞ÑÊåâÈíÆÁä∂ÊÄÅ
        function checkFireButtonState() {
            const targets = document.querySelectorAll('.target');
            const filledTargets = Array.from(targets).filter(t => t.textContent);
            
            if (filledTargets.length === targets.length) {
                fireBtn.classList.add('active');
                fireBtn.style.boxShadow = '0 0 20px rgba(78, 205, 196, 0.8)';
            } else {
                fireBtn.classList.remove('active');
                fireBtn.style.boxShadow = '';
            }
        }
        
        // ÂèëÂ∞ÑÊîªÂáª
        function fireAttack() {
            if (!gameData.gameActive || !fireBtn.classList.contains('active')) return;
            
            const targets = document.querySelectorAll('.target');
            let completedWord = '';
            
            targets.forEach(target => {
                if (target.textContent) {
                    completedWord += target.dataset.letter;
                }
            });
            
            if (completedWord.length !== gameData.currentWord.length) {
                wordShield.classList.add('shake');
                setTimeout(() => {
                    wordShield.classList.remove('shake');
                }, 500);
                return;
            }
            
            attackWithLetters();
        }
        
        // ÈÄê‰∏™ÂèëÂ∞ÑÂ≠óÊØçÊîªÂáª
        function attackWithLetters() {
            const targets = document.querySelectorAll('.target');
            const letters = Array.from(targets).map(target => ({
                element: target,
                letter: target.dataset.letter,
                index: parseInt(target.dataset.index),
                isCorrect: target.dataset.letter === gameData.currentWord[parseInt(target.dataset.index)].toUpperCase()
            }));
            
            processLetterAttack(letters, 0);
        }
        
        // ÈÄê‰∏™Â§ÑÁêÜÂ≠óÊØçÊîªÂáª
        function processLetterAttack(letters, index) {
            if (index >= letters.length) {
                setTimeout(checkAttackResult, 500);
                return;
            }
            
            const letterData = letters[index];
            
            const attackElement = document.createElement('div');
            attackElement.className = 'letter attack-letter';
            attackElement.textContent = letterData.letter.toLowerCase();
            attackElement.style.position = 'absolute';
            attackElement.style.left = `${letterData.element.offsetLeft}px`;
            attackElement.style.top = `${letterData.element.offsetTop}px`;
            attackElement.style.background = letterData.isCorrect ? 
                'linear-gradient(145deg, #4ecdc4, #1a9e94)' : 
                'linear-gradient(145deg, #ff6b6b, #d84a4a)';
            
            const monsterRect = monsterCanvas.getBoundingClientRect();
            const containerRect = document.querySelector('.game-area').getBoundingClientRect();
            const targetRect = letterData.element.getBoundingClientRect();
            
            const tx = (monsterRect.left - containerRect.left + monsterRect.width/2) - (targetRect.left - containerRect.left + targetRect.width/2);
            const ty = (monsterRect.top - containerRect.top + monsterRect.height/2) - (targetRect.top - containerRect.top + targetRect.height/2);
            
            attackElement.style.setProperty('--tx', `${tx}px`);
            attackElement.style.setProperty('--ty', `${ty}px`);
            
            document.querySelector('.game-area').appendChild(attackElement);
            
            letterData.element.textContent = '';
            letterData.element.classList.remove('filled');
            letterData.element.style.background = '';
            letterData.element.style.border = '';
            letterData.element.style.boxShadow = '';
            
            attackElement.classList.add('attack-letter');
            
            setTimeout(() => {
                attackElement.remove();
                
                if (letterData.isCorrect) {
                    gameData.monsterHealth--;
                    updateMonsterHealthBar();
                    
                    showDamage(monsterCanvas, "üí•", "#ffd166");
                    
                    const hitEffect = document.createElement('div');
                    hitEffect.className = 'hit-effect';
                    document.querySelector('.monster-area').appendChild(hitEffect);
                    hitEffect.style.left = `${monsterRect.left - containerRect.left}px`;
                    hitEffect.style.top = `${monsterRect.top - containerRect.top}px`;
                    setTimeout(() => {
                        hitEffect.classList.add('hit-animation');
                    }, 10);
                    
                    setTimeout(() => {
                        if (hitEffect.parentNode) {
                            hitEffect.parentNode.removeChild(hitEffect);
                        }
                    }, 600);
                } else {
                    showDamage(monsterCanvas, "‚ùå", "#ff6b6b");
                }
                
                setTimeout(() => processLetterAttack(letters, index+1), 150);
            }, 500);
        }
        
        // Ê£ÄÊü•ÊîªÂáªÁªìÊûú
        function checkAttackResult() {
            if (gameData.monsterHealth <= 0) {
                defeatMonster();
            } else {
                gameData.playerLives--;
                updateLives();
                
                if (gameData.playerLives <= 0) {
                    gameOver();
                } else {
                    showDamage(monsterCanvas, "ÂõûË°Ä +Êª°", "#4ecdc4");
                    gameData.monsterHealth = gameData.currentWord.length;
                    updateMonsterHealthBar();
                    fireStrongLaser();
                    resetShieldWord();
                    setTimeout(() => {
                        resetLetters();
                    }, 5000);
                }
            }
        }
        
        // ÈáçÊñ∞Âú®Êä§Áõæ‰∏äÊòæÁ§∫ÂçïËØç
        function resetShieldWord() {
            wordShield.textContent = gameData.currentWord.toLowerCase();
            wordShield.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
        }
        
        // ÂèëÂ∞ÑÂº∫ÂäõÊøÄÂÖâ
        function fireStrongLaser() {
            const laser = document.createElement('div');
            laser.className = 'monster-laser super-strong-laser';
            
            const monsterRect = monsterCanvas.getBoundingClientRect();
            const containerRect = document.querySelector('.game-container').getBoundingClientRect();
            
            const startX = monsterRect.left - containerRect.left + monsterRect.width/2;
            const startY = monsterRect.top - containerRect.top + monsterRect.height/2;
            const endY = containerRect.height;
            
            laser.style.left = `${startX - 12}px`;
            laser.style.top = `${startY}px`;
            laser.style.height = '0';
            laser.style.opacity = '0.8';
            
            document.querySelector('.game-container').appendChild(laser);
            
            setTimeout(() => {
                laser.style.transition = 'height 1.2s ease';
                laser.style.height = `${endY - startY}px`;
                laser.style.opacity = '1';
            }, 10);
            
            const gameContainer = document.querySelector('.game-container');
            gameContainer.classList.add('shake-container');
            setTimeout(() => {
                gameContainer.classList.remove('shake-container');
            }, 1200);
            
            setTimeout(() => {
                if (laser.parentNode) {
                    laser.parentNode.removeChild(laser);
                }
            }, 1200);
        }
        
        // ÈáçÁΩÆÂ≠óÊØç
        function resetLetters() {
            letterContainer.innerHTML = '';
            targetContainer.innerHTML = '';
            targetContainer.innerHTML = '<div class="mobile-drag-hint">ÁÇπÂáªÂ≠óÊØçÁÑ∂ÂêéÁÇπÂáªÊ≠§Â§ÑÊîæÁΩÆ</div>';
            
            for (let i = 0; i < gameData.currentWord.length; i++) {
                const target = document.createElement('div');
                target.className = 'target';
                target.dataset.index = i;
                target.dataset.expected = gameData.currentWord[i];
                target.addEventListener('click', handleTargetClick);
                targetContainer.appendChild(target);
            }
            
            scatterLetters();
        }
        
        // ÊòæÁ§∫‰º§ÂÆ≥Êï∞Â≠ó
        function showDamage(element, text, color) {
            const damageElement = document.createElement('div');
            damageElement.className = 'damage';
            damageElement.textContent = text;
            damageElement.style.color = color;
            
            const elementRect = element.getBoundingClientRect();
            const containerRect = document.querySelector('.game-container').getBoundingClientRect();
            
            damageElement.style.left = (elementRect.left - containerRect.left + elementRect.width/2) + 'px';
            damageElement.style.top = (elementRect.top - containerRect.top - 20) + 'px';
            
            document.querySelector('.monster-area').appendChild(damageElement);
            
            setTimeout(() => {
                if (damageElement.parentNode) {
                    damageElement.parentNode.removeChild(damageElement);
                }
            }, 1500);
        }
        
        // ÂáªË¥•ÊÄ™ÂÖΩ
        function defeatMonster() {
            gameData.monstersDefeated++;
            monstersDisplay.textContent = gameData.monstersDefeated;
            
            const expGained = 20 + gameData.playerLevel * 5;
            gameData.exp += expGained;
            
            const goldGained = 5 + gameData.playerLevel * 2;
            gameData.gold += goldGained;
            goldDisplay.textContent = gameData.gold;
            
            saveGameData();
            
            showDamage(monsterCanvas, `+${expGained} XP`, "#ffd166");
            showDamage(monsterCanvas, `+${goldGained} ÈáëÂ∏Å`, "#ffd700");
            
            updateStats();
            
            createVictoryParticles();
            
            if (monsterCanvas) {
                monsterCanvas.classList.add('defeated');
            }
            
            if (gameData.exp >= gameData.expToNextLevel) {
                setTimeout(levelUp, 1500);
            }
            
            updateChallengeProgress(true);
            
            setTimeout(() => {
                gameData.gameActive = false;
                letterContainer.innerHTML = '';
                targetContainer.innerHTML = '';
                wordShield.textContent = 'ÂáÜÂ§áÂ∞±Áª™';
                wordShield.style.backgroundColor = '';
                fireBtn.classList.remove('active');
                
                if (monsterCanvas) {
                    monsterCanvas.classList.remove('defeated');
                }
                
                gameData.currentChallengeIndex++;
                setTimeout(() => startNextWord(), 1000);
            }, 2000);
        }
        
        // ÂàõÂª∫ËÉúÂà©Á≤íÂ≠êÊïàÊûú
        function createVictoryParticles() {
            const monsterRect = monsterCanvas.getBoundingClientRect();
            const containerRect = document.querySelector('.game-container').getBoundingClientRect();
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const startX = monsterRect.left - containerRect.left + monsterRect.width/2;
                const startY = monsterRect.top - containerRect.top + monsterRect.height/2;
                
                const angle = Math.random() * Math.PI * 2;
                const distance = 150 + Math.random() * 200;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--p-tx', `${tx}px`);
                particle.style.setProperty('--p-ty', `${ty}px`);
                
                particle.style.left = `${startX}px`;
                particle.style.top = `${startY}px`;
                
                const colors = ['#ffd166', '#ff6b6b', '#4ecdc4', '#a855f7', '#06b6d4'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.width = '12px';
                particle.style.height = '12px';
                
                document.querySelector('.game-container').appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 1500);
            }
        }
        
        // Ê∏∏ÊàèÁªìÊùü
        function gameOver() {
            updateChallengeProgress(false);
            gameData.challengeAttempts++;
            
            if (gameData.challengeAttempts >= 3) {
                alert('ÊåëÊàòÂ§±Ë¥•ÔºÅ‰Ω†Â∑≤ÁªèÂ∞ùËØï‰∫Ü3Ê¨°„ÄÇÁÇπÂáªÁ°ÆÂÆöÈáçÊñ∞ÂºÄÂßã„ÄÇ');
                gameData.gameActive = false;
                letterContainer.innerHTML = '';
                targetContainer.innerHTML = '';
                wordShield.textContent = 'ÊåëÊàòÂ§±Ë¥•';
                wordShield.style.backgroundColor = 'rgba(255, 107, 107, 0.5)';
                fireBtn.classList.remove('active');
            } else {
                alert(`ÊåëÊàòÂ§±Ë¥•ÔºÅ‰Ω†ËøòÊúâ${3 - gameData.challengeAttempts}Ê¨°Â∞ùËØïÊú∫‰ºö„ÄÇÁÇπÂáªÁ°ÆÂÆöÈáçÊñ∞Â∞ùËØïÂΩìÂâçÂçïËØç„ÄÇ`);
                gameData.gameActive = false;
                letterContainer.innerHTML = '';
                targetContainer.innerHTML = '';
                wordShield.textContent = 'ÈáçÊñ∞Â∞ùËØï';
                wordShield.style.backgroundColor = '';
                fireBtn.classList.remove('active');
                
                setTimeout(() => {
                    startNextWord();
                }, 500);
            }
        }
        
        // ÊåëÊàòÊàêÂäü
        function challengeSuccess() {
            const expReward = gameData.challengeWords.length * 15;
            const goldReward = gameData.challengeWords.length * 10;
            
            gameData.exp += expReward;
            gameData.gold += goldReward;
            goldDisplay.textContent = gameData.gold;
            
            saveGameData();
            
            rewardGold.textContent = `+${goldReward}`;
            rewardExp.textContent = `+${expReward}`;
            
            rewardPopup.style.display = 'block';
            overlay.style.display = 'block';
            
            if (gameData.exp >= gameData.expToNextLevel) {
                setTimeout(levelUp, 1000);
            }
        }
        
        // ÂçáÁ∫ß
        function levelUp() {
            gameData.playerLevel++;
            gameData.exp -= gameData.expToNextLevel;
            gameData.expToNextLevel = Math.floor(gameData.expToNextLevel * 1.5);
            gameData.maxHP += 20;
            
            saveGameData();
            
            newLevelDisplay.textContent = gameData.playerLevel;
            levelUpPopup.style.display = 'block';
            overlay.style.display = 'block';
            
            updateStats();
        }
        
        // ÈöêËóèÂçáÁ∫ßÂºπÁ™ó
        function hideLevelUpPopup() {
            levelUpPopup.style.display = 'none';
            overlay.style.display = 'none';
        }
        
        // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
        function updateStats() {
            levelDisplay.textContent = gameData.playerLevel;
            expDisplay.textContent = gameData.exp;
            monstersDisplay.textContent = gameData.monstersDefeated;
            goldDisplay.textContent = gameData.gold;
            updateLives();
        }
        
        // Êõ¥Êñ∞ÁîüÂëΩÂÄºÊòæÁ§∫
        function updateLives() {
            livesDisplay.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const heart = document.createElement('span');
                heart.className = 'heart';
                heart.innerHTML = i < gameData.playerLives ? '‚ù§Ô∏è' : 'ü§ç';
                livesDisplay.appendChild(heart);
            }
        }
        
        // Êí≠ÊîæÂçïËØçÂèëÈü≥
        function speakWord() {
            if (!gameData.currentWord || !gameData.gameActive) return;
            
            const currentWordData = gameData.challengeWords[gameData.currentChallengeIndex];
            if (!currentWordData || !currentWordData.audio) return;
            
            const audio = new Audio(currentWordData.audio);
            audio.play().catch(e => console.log("Êí≠ÊîæÂ§±Ë¥•:", e));
        }
        
        // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöÊâì‰π±Êï∞ÁªÑÈ°∫Â∫è
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // ÂàùÂßãÂåñÊ∏∏Êàè
        window.onload = initGame;
    </script>
</body>
</html>
